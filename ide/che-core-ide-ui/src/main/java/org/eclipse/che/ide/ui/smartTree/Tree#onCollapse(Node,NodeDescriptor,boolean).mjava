    private void onCollapse(Node node, NodeDescriptor nodeDescriptor, boolean deep) {
        if (nodeDescriptor.isExpanded() && fireCancellableEvent(new BeforeCollapseNodeEvent(node))) {
            nodeDescriptor.setExpanded(false);
            view.collapse(nodeDescriptor);

            fireEvent(new CollapseNodeEvent(node));
        }

        nodeDescriptor.setLoaded(false);

        for (Node toRemove : nodeStorage.getAllChildren(node)) {
            nodeStorage.remove(toRemove);
        }

        Scheduler.get().scheduleDeferred(new Scheduler.ScheduledCommand() {
            @Override
            public void execute() {
                update();
            }
        });
    }


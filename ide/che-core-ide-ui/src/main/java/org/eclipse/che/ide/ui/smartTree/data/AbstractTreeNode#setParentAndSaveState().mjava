  private Function<List<Node>, List<Node>> setParentAndSaveState() {
    return new Function<List<Node>, List<Node>>() {
      @Override
      public List<Node> apply(List<Node> children) throws FunctionException {
        if (children == null) {
          setChildren(Collections.<Node>emptyList());
          return Collections.emptyList();
        }

        for (Node node : children) {
          node.setParent(AbstractTreeNode.this);
        }

        setChildren(children);

        return children;
      }
    };
  }


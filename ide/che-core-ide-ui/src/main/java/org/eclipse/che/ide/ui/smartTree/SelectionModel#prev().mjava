  protected Node prev() {
    Node sel = lastSelectedNode;
    if (sel == null) {
      return null;
    }
    Node prev = nodeStorage.getPreviousSibling(sel);
    if (prev != null) {
      if ((!tree.isExpanded(prev) || nodeStorage.getChildCount(prev) < 1)) {
        return prev;
      } else {
        Node lastChild = nodeStorage.getLastChild(prev);
        while (lastChild != null
            && nodeStorage.getChildCount(lastChild) > 0
            && tree.isExpanded(lastChild)) {
          lastChild = nodeStorage.getLastChild(lastChild);
        }
        return lastChild;
      }
    } else {
      Node parent = nodeStorage.getParent(sel);
      if (parent != null) {
        return parent;
      }
    }
    return null;
  }


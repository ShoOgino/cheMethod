  private void internalInitialize() {
    securityTokenProvider
        .getSecurityToken()
        .then(
            token -> {
              String protocol = "https:".equals(getProtocol()) ? "wss://" : "ws://";
              String host = getHost();
              String context = getWebsocketContext();
              String url = protocol + host + context;
              char separator = url.contains("?") ? '&' : '?';
              String queryParams =
                  separator
                      + "token="
                      + token
                      + appContext
                          .getApplicationWebsocketId()
                          .map(id -> "&clientId=" + id)
                          .orElse("");
              Set<Runnable> initActions =
                  appContext.getApplicationWebsocketId().isPresent()
                      ? emptySet()
                      : singleton(WorkspaceMasterJsonRpcInitializer.this::processWsId);

              initializer.initialize(
                  "ws-master", singletonMap("url", url + queryParams), initActions);
            });
  }


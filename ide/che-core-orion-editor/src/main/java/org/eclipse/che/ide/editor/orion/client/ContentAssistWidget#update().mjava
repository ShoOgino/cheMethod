  private void update() {
    int scrollTop = popupBodyElement.getScrollTop();
    int itemHeight = getItemHeight();
    int topVisibleItem = scrollTop == 0 || itemHeight == 0 ? 0 : scrollTop / itemHeight;
    int topDOMItem = Math.max(0, topVisibleItem - (DOM_ITEMS_SIZE - getItemsPerPage()) / 2);
    int bottomDOMItem = Math.min(getTotalItems() - 1, topDOMItem + DOM_ITEMS_SIZE - 1);
    if (bottomDOMItem == getTotalItems() - 1) {
      topDOMItem = Math.max(0, bottomDOMItem - DOM_ITEMS_SIZE + 1);
    }

    // resize the extra top row
    setExtraRowHeight(getExtraTopRow(), topDOMItem);

    // replace the DOM items with new content based on the scroll position
    HTMLCollection nodes = listElement.getChildren();
    for (int i = 0; i <= (bottomDOMItem - topDOMItem); i++) {
      Element newNode = createProposalPopupItem(topDOMItem + i);
      listElement.replaceChild(newNode, nodes.item(i + 1));

      // check if the item is the selected
      if (newNode.getId().equals(selectedElement.getId())) {
        selectedElement = newNode;
        selectedElement.setAttribute("selected", "true");
      }
    }

    // resize the extra bottom row
    setExtraRowHeight(getExtraBottomRow(), getTotalItems() - (bottomDOMItem + 1));

    // ensure the keyboard focus is in the visible area
    if (focused) {
      getItem(topDOMItem + (bottomDOMItem - topDOMItem) / 2).focus();
    }
  }


    private void applyCompletion(Completion completion) {
        textEditor.setFocus();
        UndoableEditor undoableEditor = textEditor;
        HandlesUndoRedo undoRedo = undoableEditor.getUndoRedo();

        try {
            if (undoRedo != null) {
                undoRedo.beginCompoundChange();
            }
            completion.apply(textEditor.getDocument());
            final LinearRange selection = completion.getSelection(textEditor.getDocument());
            if (selection != null) {
                selectInEditor(selection);
            }
        } catch (final Exception e) {
            Log.error(getClass(), e);
        } finally {
            if (undoRedo != null) {
                undoRedo.endCompoundChange();
            }
        }
    }


    @Inject
    public AppStateManager(Map<String, Provider<StateComponent>> persistenceComponents,
                           PreferencesManager preferencesManager,
                           JsonFactory jsonFactory,
                           EventBus eventBus,
                           AppContext appContext) {
        this.persistenceComponents = persistenceComponents;
        this.preferencesManager = preferencesManager;
        this.jsonFactory = jsonFactory;
        this.appContext = appContext;

        eventBus.addHandler(WsStatusChangedEvent.TYPE, event -> {
            if (event.getStatus() == RUNNING) {
                Scheduler.get().scheduleDeferred(this::restoreWorkspaceState);
            }
        });

        eventBus.addHandler(WindowActionEvent.TYPE, new WindowActionHandler() {
            @Override
            public void onWindowClosing(WindowActionEvent event) {
                final Workspace workspace = appContext.getWorkspace();
                if (workspace != null) {
                    persistWorkspaceState(workspace.getId());
                }
            }

            @Override
            public void onWindowClosed(WindowActionEvent event) {
            }
        });
    }


    private void internalInitialize() {
        final WorkspaceImpl workspace = appContext.getWorkspace();
        final RuntimeImpl runtime = workspace.getRuntime();

        if (runtime == null) {
            return; // workspace is stopped
        }

        runtime.getWsAgentServer().ifPresent(server -> {
            String wsAgentWebSocketUrl =
                    server.getUrl().replaceFirst("http", "ws") + "/ws"; // TODO (spi ide): remove path when it comes with URL
            String wsAgentUrl = wsAgentWebSocketUrl.replaceFirst("api/ws", "wsagent");

            String separator = wsAgentUrl.contains("?") ? "&" : "?";
            String queryParams = appContext.getApplicationWebsocketId().map(id -> separator + "clientId=" + id).orElse("");
            Set<Runnable> initActions = appContext.getApplicationWebsocketId().isPresent() ? emptySet() : singleton(this::processWsId);

            initializer.initialize(WS_AGENT_JSON_RPC_ENDPOINT_ID, singletonMap("url", wsAgentUrl + queryParams), initActions);
        });
    }


    @Inject
    private void startWsAgentComponents(EventBus eventBus, final Map<String, Provider<WsAgentComponent>> components) {
        eventBus.addHandler(WorkspaceStartedEvent.TYPE, new WorkspaceStartedEvent.Handler() {
            @Override
            public void onWorkspaceStarted(WorkspaceStartedEvent event) {
                workspaceService.getWorkspace(event.getWorkspace().getId()).then(new Operation<WorkspaceDto>() {
                    @Override
                    public void apply(WorkspaceDto ws) throws OperationException {
//                        MachineDto devMachineDto = ws.getRuntime().getDevMachine();

                        String activeEnv = ws.getRuntime().getActiveEnv();
                        EnvironmentDto activeEnvironment = ws.getConfig().getEnvironments().get(activeEnv);
                        String devMachineName = Utils.getDevMachineName(activeEnvironment);
                        MachineDto devMachineDto = ws.getRuntime().getMachines().get(devMachineName);

                        DevMachine devMachine = new DevMachine(devMachineName, devMachineDto);
// FIXME: spi
//                        if (appContext instanceof AppContextImpl) {
//                            ((AppContextImpl)appContext).setProjectsRoot(Path.valueOf(devMachineDto.getRuntime().projectsRoot()));
//                        }

                        wsAgentStateControllerProvider.get().initialize(devMachine);
                        wsAgentURLModifier.initialize(devMachine);
                        SortedMap<String, Provider<WsAgentComponent>> sortedComponents = new TreeMap<>();
                        sortedComponents.putAll(components);
                        startWsAgentComponents(sortedComponents.values().iterator());
                    }
                }).catchError(new Operation<PromiseError>() {
                    @Override
                    public void apply(PromiseError err) throws OperationException {
                        Log.error(getClass(), err.getCause());
                        initializationFailed(err.getMessage());
                    }
                });
            }
        });
    }


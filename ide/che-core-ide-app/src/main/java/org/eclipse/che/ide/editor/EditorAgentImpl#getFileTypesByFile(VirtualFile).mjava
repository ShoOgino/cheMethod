  private Set<FileType> getFileTypesByFile(VirtualFile file) {
    String name = file.getName();

    if (isNullOrEmpty(name)) {
      return emptySet();
    }

    Set<FileType> typesByNamePattern =
        fileTypeRegistry
            .getFileTypes()
            .stream()
            .filter(
                type ->
                    type.getNamePatterns()
                        .stream()
                        .anyMatch(namePattern -> compile(namePattern).test(name)))
            .collect(toSet());

    String fileExtension = getFileExtension(name);
    if (isNullOrEmpty(fileExtension)) {
      return typesByNamePattern;
    }

    Set<FileType> fileTypes =
        typesByNamePattern
            .stream()
            .filter(type -> fileExtension.equals(type.getExtension()))
            .collect(toSet());
    fileTypes = fileTypes.isEmpty() ? typesByNamePattern : fileTypes;
    return fileTypes.isEmpty()
        ? singleton(fileTypeRegistry.getFileTypeByExtension(fileExtension))
        : fileTypes;
  }


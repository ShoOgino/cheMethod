  @Inject
  public AppContextImpl(
      EventBus eventBus,
      QueryParameters queryParameters,
      ResourceManager.ResourceManagerFactory resourceManagerFactory,
      Provider<EditorAgent> editorAgentProvider,
      Provider<AppStateManager> appStateManager) {
    this.eventBus = eventBus;
    this.queryParameters = queryParameters;
    this.resourceManagerFactory = resourceManagerFactory;
    this.editorAgentProvider = editorAgentProvider;
    this.appStateManager = appStateManager;

    projectsInImport = new ArrayList<>();

    WorkspaceStateHandler workspaceStateHandler = new WorkspaceStateHandler();

    eventBus.addHandler(SelectionChangedEvent.TYPE, this);
    eventBus.addHandler(ResourceChangedEvent.getType(), this);
    eventBus.addHandler(WindowActionEvent.TYPE, workspaceStateHandler);
    eventBus.addHandler(WorkspaceStoppedEvent.TYPE, workspaceStateHandler);
    eventBus.addHandler(WorkspaceStatusChangedEvent.TYPE, workspaceStateHandler);

    //in some cases IDE doesn't save preferences on window close
    //so try to save if window lost focus
    Elements.getWindow()
        .addEventListener(
            Event.BLUR, evt -> appStateManager.get().persistWorkspaceState(getWorkspaceId()));
  }


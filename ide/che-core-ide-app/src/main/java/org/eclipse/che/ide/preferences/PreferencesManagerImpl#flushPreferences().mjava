  @Override
  public Promise<Void> flushPreferences() {
    if (changedPreferences.isEmpty()) {
      return Promises.resolve(null);
    }

    return updatePreferences(changedPreferences)
        .thenPromise(
            result -> {
              persistedPreferences.putAll(changedPreferences);
              changedPreferences.clear();
              return Promises.resolve(null);
            });
  }


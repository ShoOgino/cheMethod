  @Inject
  public AppContextImpl(
      EventBus eventBus,
      ResourceManager.ResourceManagerFactory resourceManagerFactory,
      Provider<EditorAgent> editorAgentProvider,
      Provider<AppStateManager> appStateManager) {
    this.eventBus = eventBus;
    this.resourceManagerFactory = resourceManagerFactory;
    this.editorAgentProvider = editorAgentProvider;
    this.appStateManager = appStateManager;
    this.startAppActions = new ArrayList<>();

    projectsInImport = new ArrayList<>();

    eventBus.addHandler(ProjectTypesLoadedEvent.TYPE, e -> initResourceManager());

    WorkspaceStateHandler workspaceStateHandler = new WorkspaceStateHandler();

    eventBus.addHandler(SelectionChangedEvent.TYPE, this);
    eventBus.addHandler(ResourceChangedEvent.getType(), this);
    eventBus.addHandler(WorkspaceStoppedEvent.TYPE, workspaceStateHandler);
    eventBus.addHandler(WorkspaceStoppingEvent.TYPE, workspaceStateHandler);

    // in some cases IDE doesn't save preferences on window close
    // so try to save if window lost focus
    Elements.getWindow()
        .addEventListener(Event.BLUR, evt -> appStateManager.get().persistWorkspaceState());
  }


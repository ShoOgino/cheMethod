  private Function<String, Promise<String>> expandMacro(
      final StringContainer stringContainer, final Macro macro) {
    return new Function<String, Promise<String>>() {
      @Override
      public Promise<String> apply(String arg) throws FunctionException {
        return macro
            .expand()
            .thenPromise(
                new Function<String, Promise<String>>() {
                  @Override
                  public Promise<String> apply(String arg) throws FunctionException {
                    stringContainer.setCommandLine(
                        stringContainer.getCommandLine().replace(macro.getName(), arg));
                    return Promises.resolve(stringContainer.getCommandLine());
                  }
                });
      }
    };
  }


    @Test
    public void getMacroProviders() throws Exception {
        final Set<CommandPropertyValueProvider> providers = provider.getMacroProviders(devMachine);

        assertEquals(providers.size(), 2);

        final Iterator<CommandPropertyValueProvider> iterator = providers.iterator();

        final CommandPropertyValueProvider provider1 = iterator.next();

        assertTrue(provider1 instanceof CustomCommandPropertyValueProvider);
        assertEquals(provider1.getKey(), ServerProtocolMacroProvider.KEY.replace("%", WS_AGENT_PORT));

        provider1.getValue().then(new Operation<String>() {
            @Override
            public void apply(String address) throws OperationException {
                assertEquals(address, PROTOCOL);
            }
        });

        final CommandPropertyValueProvider provider2 = iterator.next();

        assertTrue(provider2 instanceof CustomCommandPropertyValueProvider);
        assertEquals(provider2.getKey(), ServerProtocolMacroProvider.KEY.replace("%", WS_AGENT_PORT.substring(0, WS_AGENT_PORT.length() - 4)));

        provider2.getValue().then(new Operation<String>() {
            @Override
            public void apply(String address) throws OperationException {
                assertEquals(address, PROTOCOL);
            }
        });
    }


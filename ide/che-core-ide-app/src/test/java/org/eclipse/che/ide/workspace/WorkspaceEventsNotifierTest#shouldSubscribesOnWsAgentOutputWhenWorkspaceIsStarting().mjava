    @Test
    public void shouldSubscribesOnWsAgentOutputWhenWorkspaceIsStarting() throws Exception {
        WorkspaceRuntimeDto runtime = mock(WorkspaceRuntimeDto.class);
        WorkspaceConfigDto workspaceConfig = mock(WorkspaceConfigDto.class);
        when(workspaceStatusEvent.getEventType()).thenReturn(STARTING);
        when(workspace.getRuntime()).thenReturn(runtime);
        when(runtime.getActiveEnv()).thenReturn(ACTIVE_ENV);
        when(workspace.getConfig()).thenReturn(workspaceConfig);
        List<EnvironmentDto> environments = new ArrayList<>(1);
        EnvironmentDto environment = mock(EnvironmentDto.class);
        environments.add(environment);
        when(workspaceConfig.getEnvironments()).thenReturn(environments);
        when(environment.getName()).thenReturn(ACTIVE_ENV);
        MachineConfigDto devMachineConfig = mock(MachineConfigDto.class);
        when(environment.devMachine()).thenReturn(devMachineConfig);
        when(devMachineConfig.getName()).thenReturn(MACHINE_NAME);

        workspaceEventsNotifier.trackWorkspaceEvents(workspace, callback);
        workspaceEventsNotifier.workspaceStatusSubscriptionHandler.onMessageReceived(workspaceStatusEvent);

        verify(workspacePromise).then(workspaceCaptor.capture());
        workspaceCaptor.getValue().apply(workspace);

        verify(messageBus, times(2)).subscribe(eq(WS_AGENT_LOG_CHANNEL), (MessageHandler)anyObject());
    }


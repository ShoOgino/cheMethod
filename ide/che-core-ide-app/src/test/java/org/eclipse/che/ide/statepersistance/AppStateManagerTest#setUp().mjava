  @Before
  public void setUp() {
    when(appStateService.loadState()).thenReturn(getStatePromise);
    when(getStatePromise.thenPromise((Function<String, Promise<Void>>) any())).thenReturn(promise);

    List<StateComponent> components = new ArrayList<>();
    components.add(component1);
    components.add(component2);

    when(stateComponentRegistry.getComponents()).thenReturn(components);
    when(stateComponentRegistry.getComponentById(anyString())).thenReturn(Optional.of(component1));
    when(stateComponentRegistryProvider.get()).thenReturn(stateComponentRegistry);

    when(component1Provider.get()).thenReturn(component1);
    when(component2Provider.get()).thenReturn(component2);

    when(component1.getId()).thenReturn(COMPONENT_ONE_ID);
    when(component2.getId()).thenReturn(COMPONENT_TWO_ID);
    when(jsonFactory.parse(anyString())).thenReturn(Json.createObject());
    appStateManager =
        new AppStateManager(
            perspectiveManagerProvider,
            stateComponentRegistryProvider,
            jsonFactory,
            promiseProvider,
            appStateService);
    appStateManager.readState();
  }


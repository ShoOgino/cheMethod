    @Before
    public void setUp() {
        WorkspaceImpl workspace = mock(WorkspaceImpl.class);
        when(workspace.getId()).thenReturn(WS_ID);
        when(appContext.getWorkspace()).thenReturn(workspace);

        Map<String, Provider<StateComponent>> components = new HashMap<>();
        components.put("component1", component1Provider);
        components.put("component2", component2Provider);

        when(component1Provider.get()).thenReturn(component1);
        when(component2Provider.get()).thenReturn(component2);

        when(preferencesManager.flushPreferences()).thenReturn(promise);
        when(preferencesManager.getValue(AppStateManager.PREFERENCE_PROPERTY_NAME)).thenReturn("");
        when(jsonFactory.parse(anyString())).thenReturn(pref = Json.createObject());
        appStateManager = new AppStateManager(components, preferencesManager, jsonFactory, eventBus, appContext);
    }


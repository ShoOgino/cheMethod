  @Before
  public void setUp() throws Exception {
    client =
        new ProjectServiceClient(
            loaderFactory, requestFactory, dtoFactory, unmarshaller, appContext);

    when(appContext.getWsAgentServerApiEndpoint()).thenReturn("http://127.0.0.3/api");

    when(loaderFactory.newLoader(any())).thenReturn(messageLoader);
    when(asyncRequest.loader(messageLoader)).thenReturn(asyncRequest);
    when(asyncRequest.data(any())).thenReturn(asyncRequest);
    when(asyncRequest.send(unmarshallableItemRef)).thenReturn(itemRefPromise);
    when(asyncRequest.header(any(), any())).thenReturn(asyncRequest);
    when(unmarshaller.newUnmarshaller(ItemReference.class)).thenReturn(unmarshallableItemRef);
    when(unmarshaller.newListUnmarshaller(ProjectConfigDto.class))
        .thenReturn(unmarshallablePrjsConf);
    when(unmarshaller.newListUnmarshaller(SourceEstimation.class))
        .thenReturn(unmarshallbleSourcesEstimation);
    when(unmarshaller.newUnmarshaller(SourceEstimation.class))
        .thenReturn(unmarshallbleSourceEstimation);
    when(unmarshaller.newUnmarshaller(ProjectSearchResponseDto.class))
        .thenReturn(unmarshallableSearch);
    when(unmarshaller.newUnmarshaller(TreeElement.class)).thenReturn(unmarshallableTreeElem);
    when(unmarshaller.newUnmarshaller(ProjectConfigDto.class)).thenReturn(unmarshallablePrjConf);

    when(requestFactory.createGetRequest(anyString())).thenReturn(asyncRequest);
    when(requestFactory.createPostRequest(anyString(), any(MimeType.class)))
        .thenReturn(asyncRequest);
    when(requestFactory.createRequest(
            any(RequestBuilder.Method.class), anyString(), any(), anyBoolean()))
        .thenReturn(asyncRequest);
    when(requestFactory.createPostRequest(anyString(), any())).thenReturn(asyncRequest);
  }


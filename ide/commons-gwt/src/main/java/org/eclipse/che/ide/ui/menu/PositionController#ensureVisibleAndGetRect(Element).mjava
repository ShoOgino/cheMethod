  /**
   * Ensures that an element is not display: none and is just visibility hidden so we can get an
   * accurate client rect.
   */
  private static ClientRect ensureVisibleAndGetRect(Element element) {
    // Try to get rect and see if it isn't all 0's
    ClientRect rect = element.getBoundingClientRect();
    double rectSum =
        rect.getBottom()
            + rect.getTop()
            + rect.getLeft()
            + rect.getRight()
            + rect.getHeight()
            + rect.getWidth();
    if (rectSum != 0) {
      return rect;
    }

    // We make an attempt to get an accurate measurement of the element
    CSSStyleDeclaration style = element.getStyle();
    String visibility = CssUtils.setAndSaveProperty(element, "visibility", "hidden");
    String display = style.getDisplay();

    // if display set to none we remove it and let its normal style show through
    if (style.getDisplay().equals("none")) {
      style.removeProperty("display");
    } else {
      // it's likely display: none in a css class so we just have to guess.
      // We guess display:block since that's common on containers.
      style.setDisplay("block");
    }
    rect = element.getBoundingClientRect();
    style.setDisplay(display);
    style.setVisibility(visibility);

    return rect;
  }


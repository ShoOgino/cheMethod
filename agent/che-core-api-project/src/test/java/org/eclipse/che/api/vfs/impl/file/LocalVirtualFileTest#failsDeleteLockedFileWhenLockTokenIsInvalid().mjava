    @Test
    public void failsDeleteLockedFileWhenLockTokenIsInvalid() throws Exception {
        VirtualFile root = getRoot();
        VirtualFile folder = root.createFolder(generateFolderName());
        VirtualFile file = folder.createFile(generateFileName(), DEFAULT_CONTENT);
        file.setProperty("property1", "value1");
        Path filePath = file.getPath();
        String invalidLockToken = invalidateLockToken(file.lock(0));

        try {
            file.delete(invalidLockToken);
            thrown.expect(ForbiddenException.class);
        } catch (ForbiddenException e) {
            assertionHelper.assertThatIoFileHasContent(filePath, DEFAULT_CONTENT_BYTES);
            assertionHelper.assertThatMetadataIoFileHasContent(file.getPath(),
                                                               serializeVirtualFileMetadata(ImmutableMap.of("property1", "value1")));
            assertionHelper.assertThatLockIoFileExists(filePath);
        }
    }


    @Test
    public void failsMoveFolderWhenTargetFolderNeedBeOverwrittenButContainsLockedFile() throws Exception {
        VirtualFile folder = getRoot().createFolder(generateFolderName());
        VirtualFile file = folder.createFile(generateFileName(), DEFAULT_CONTENT);
        VirtualFile targetFolder = getRoot().createFolder(generateFolderName());
        VirtualFile conflictFolder = targetFolder.createFolder(folder.getName());
        VirtualFile lockedFileInConflictFolder = conflictFolder.createFile(generateFileName(), "xxx");
        lockedFileInConflictFolder.lock(0);

        try {
            folder.moveTo(targetFolder, null, true, null);
            thrown.expect(ForbiddenException.class);
        } catch (ForbiddenException expected) {
            assertEquals("xxx", lockedFileInConflictFolder.getContentAsString());
            assertNull(getRoot().getChild(conflictFolder.getPath().newPath(file.getName())));

            assertNotNull(getRoot().getChild(folder.getPath()));
            assertEquals(DEFAULT_CONTENT, file.getContentAsString());
        }
    }


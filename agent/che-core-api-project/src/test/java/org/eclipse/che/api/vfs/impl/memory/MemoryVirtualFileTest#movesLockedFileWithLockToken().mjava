    @Test
    public void movesLockedFileWithLockToken() throws Exception {
        VirtualFile file = getRoot().createFile(generateFileName(), DEFAULT_CONTENT);
        file.setProperty("property1", "value1");
        String lockToken = file.lock(0);
        Path filePath = file.getPath();
        VirtualFile targetFolder = getRoot().createFolder(generateFolderName());

        VirtualFile movedFile = file.moveTo(targetFolder, null, false, lockToken);

        assertEquals(movedFile, getRoot().getChild(movedFile.getPath()));
        assertFalse(movedFile.isLocked());
        assertEquals(ImmutableMap.of("property1", "value1"), movedFile.getProperties());
        assertEquals(DEFAULT_CONTENT, movedFile.getContentAsString());

        assertNull(getRoot().getChild(filePath));
    }


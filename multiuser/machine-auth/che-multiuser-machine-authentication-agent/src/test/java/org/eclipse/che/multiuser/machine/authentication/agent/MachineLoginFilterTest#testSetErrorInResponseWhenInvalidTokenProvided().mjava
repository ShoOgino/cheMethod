  @Test
  public void testSetErrorInResponseWhenInvalidTokenProvided() throws Exception {
    final String invalidToken = "invalid_token";
    when(tokenExtractorMock.getToken(any(HttpServletRequest.class))).thenReturn(invalidToken);

    machineLoginFilter.doFilter(getRequestMock(null, invalidToken), responseMock, chainMock);

    verify(tokenExtractorMock).getToken(any(HttpServletRequest.class));
    verify(responseMock)
        .sendError(
            eq(SC_UNAUTHORIZED),
            argThat(s -> s.startsWith("Authentication on machine failed cause:")));
  }


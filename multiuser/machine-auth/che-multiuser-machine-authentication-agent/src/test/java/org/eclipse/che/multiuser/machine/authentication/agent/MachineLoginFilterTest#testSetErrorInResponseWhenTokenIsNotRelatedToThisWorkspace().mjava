  @Test
  public void testSetErrorInResponseWhenTokenIsNotRelatedToThisWorkspace() throws Exception {
    final Map<String, Object> headers = new HashMap<>();
    headers.put("kind", MACHINE_TOKEN_KIND);
    headers.put("workspace", "workspace73");
    final String differentToken =
        Jwts.builder()
            .setPayload(GSON.toJson(subject))
            .setHeader(headers)
            .signWith(RS512, keyPair.getPrivate())
            .compact();
    when(tokenExtractorMock.getToken(any(HttpServletRequest.class))).thenReturn(differentToken);

    machineLoginFilter.doFilter(getRequestMock(null, differentToken), responseMock, chainMock);

    verify(tokenExtractorMock).getToken(any(HttpServletRequest.class));
    verify(responseMock)
        .sendError(SC_UNAUTHORIZED, "Authentication on machine failed, invalid token provided.");
  }


  @Test
  public void shouldProcessingRequestWithValidQueryParameterAndPutUserIntoHttpSession()
      throws Exception {
    // token service response mocking
    when(jsonResponseMock.asDto(UserDto.class)).thenReturn(userMock);
    // mocking for setting the principal in http session
    doNothing().when(sessionMock).setAttribute(anyString(), any());
    final HttpServletRequest requestMock = getRequestMock(null, MACHINE_TOKEN);
    when(requestMock.getQueryString()).thenReturn("token=" + MACHINE_TOKEN);

    machineLoginFilter.doFilter(requestMock, servletResponseMock, chainMock);

    verify(sessionMock).setAttribute("principal", machineSubject);
  }


  @Test
  public void testSetErrorInResponseWhenNonMachineTokenProvided() throws Exception {
    final String differentToken =
        Jwts.builder()
            .setPayload(GSON.toJson(subject))
            .setHeader(new HashMap<>())
            .signWith(RS512, keyPair.getPrivate())
            .compact();
    when(tokenExtractorMock.getToken(any(HttpServletRequest.class))).thenReturn(differentToken);

    machineLoginFilter.doFilter(getRequestMock(null, differentToken), responseMock, chainMock);

    verify(tokenExtractorMock).getToken(any(HttpServletRequest.class));
    verify(responseMock)
        .sendError(SC_UNAUTHORIZED, "Authentication on machine failed, invalid token provided.");
  }


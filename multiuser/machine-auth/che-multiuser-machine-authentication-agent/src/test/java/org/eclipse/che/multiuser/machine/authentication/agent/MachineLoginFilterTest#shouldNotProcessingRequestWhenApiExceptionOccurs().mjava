  @Test
  public void shouldNotProcessingRequestWhenApiExceptionOccurs() throws Exception {
    final String apiExMsg = "panic!";
    // token service response mocking
    when(jsonResponseMock.asDto(UserDto.class)).thenReturn(userMock);
    // mocking for setting the principal in http session
    doNothing().when(sessionMock).setAttribute(anyString(), any());
    when(httpJsonRequestMock.request()).thenThrow(new ServerException(apiExMsg));

    machineLoginFilter.doFilter(
        getRequestMock(null, MACHINE_TOKEN), servletResponseMock, chainMock);

    verify(servletResponseMock).sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, apiExMsg);
  }


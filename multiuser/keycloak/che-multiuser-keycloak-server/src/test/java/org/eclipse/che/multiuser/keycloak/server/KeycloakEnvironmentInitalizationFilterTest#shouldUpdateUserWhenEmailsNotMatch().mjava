  @Test
  public void shouldUpdateUserWhenEmailsNotMatch() throws Exception {

    Subject existingSubject = new SubjectImpl("name", "id1", "token", false);
    UserImpl user = new UserImpl("id2", "test2@test.com", "username2");
    DefaultJwt<Claims> jwt = createJwt();

    ArgumentCaptor<UserImpl> captor = ArgumentCaptor.forClass(UserImpl.class);

    // given
    when(tokenExtractor.getToken(any(HttpServletRequest.class))).thenReturn("token2");
    when(request.getAttribute("token")).thenReturn(jwt);
    when(session.getAttribute(eq("che_subject"))).thenReturn(existingSubject);
    when(userManager.getById(anyString())).thenReturn(user);

    // when
    filter.doFilter(request, response, chain);

    // then
    verify(userManager).update(captor.capture());
    assertEquals(jwt.getBody().get("email"), captor.getValue().getEmail());
  }


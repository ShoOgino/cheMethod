  @BeforeMethod
  public void setUp() throws Exception {
    MockitoAnnotations.initMocks(this);
    when(request.getScheme()).thenReturn("http");
    when(request.getSession()).thenReturn(session);
    EnvironmentContext context = spy(EnvironmentContext.getCurrent());
    EnvironmentContext.setCurrent(context);
    filter =
        new KeycloakEnvironmentInitalizationFilter(
            userManager, tokenExtractor, permissionChecker, keycloakSettings);
    Field parser = filter.getClass().getSuperclass().getDeclaredField("jwtParser");
    parser.setAccessible(true);
    parser.set(filter, jwtParser);
    final KeyPair kp = new KeyPair(mock(PublicKey.class), mock(PrivateKey.class));
    when(keyManager.getKeyPair(anyString())).thenReturn(kp);
  }


  @Test
  public void shouldThrowExceptionWhenNoEmailExists() throws Exception {

    Map<String, Object> claimParams = new HashMap<>();
    claimParams.put("preferred_username", "username");
    Claims claims = new DefaultClaims(claimParams).setSubject("id2");
    DefaultJwt<Claims> jwt = new DefaultJwt<>(new DefaultHeader(), claims);
    // given
    when(tokenExtractor.getToken(any(HttpServletRequest.class))).thenReturn("token2");
    when(request.getAttribute("token")).thenReturn(jwt);

    // when
    filter.doFilter(request, response, chain);

    verify(response).setStatus(400);
    verify(servletOutputStream)
        .write(
            eq(
                "Unable to authenticate user because email address is not set in keycloak profile"
                    .getBytes()));
    verifyNoMoreInteractions(chain);
  }


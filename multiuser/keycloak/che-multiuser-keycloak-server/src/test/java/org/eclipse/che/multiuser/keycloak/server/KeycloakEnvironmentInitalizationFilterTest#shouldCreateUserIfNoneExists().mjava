  @Test
  public void shouldCreateUserIfNoneExists() throws Exception {

    UserImpl user = new UserImpl();
    DefaultJwt<Claims> jwt = createJwt();
    user.setEmail((String) jwt.getBody().get("email"));
    user.setId(jwt.getBody().getSubject());
    user.setName((String) jwt.getBody().get("preferred_username"));

    ArgumentCaptor<UserImpl> captor = ArgumentCaptor.forClass(UserImpl.class);

    // given
    when(tokenExtractor.getToken(any(HttpServletRequest.class))).thenReturn("token2");
    when(request.getScheme()).thenReturn("http");
    when(request.getSession()).thenReturn(session);
    when(request.getAttribute("token")).thenReturn(jwt);
    when(session.getAttribute(eq("che_subject"))).thenReturn(null);
    when(userManager.getById(anyString())).thenThrow(NotFoundException.class);
    when(userManager.create(any(User.class), anyBoolean())).thenReturn(user);

    // when
    filter.doFilter(request, response, chain);

    // then
    verify(session).setAttribute(eq("che_subject"), captor.capture());
    verify(userManager).create(captor.capture(), eq(false));
    assertEquals(jwt.getBody().getSubject(), captor.getValue().getId());
    assertEquals(jwt.getBody().get("email"), captor.getValue().getEmail());
    assertEquals(jwt.getBody().get("preferred_username"), captor.getValue().getName());
  }


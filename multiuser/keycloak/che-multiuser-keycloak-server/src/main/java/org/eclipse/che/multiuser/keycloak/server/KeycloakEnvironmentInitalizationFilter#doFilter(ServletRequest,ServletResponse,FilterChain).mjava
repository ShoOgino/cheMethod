  @Override
  public void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain)
      throws IOException, ServletException {

    final HttpServletRequest httpRequest = (HttpServletRequest) request;
    final String token = tokenExtractor.getToken(httpRequest);
    if (shouldSkipAuthentication(httpRequest, token)) {
      filterChain.doFilter(request, response);
      return;
    }

    final HttpSession session = httpRequest.getSession();
    Subject subject = (Subject) session.getAttribute("che_subject");
    if (subject == null || !subject.getToken().equals(token)) {
      Jwt jwtToken = (Jwt) httpRequest.getAttribute("token");
      if (jwtToken == null) {
        sendError(response, 401, "Cannot detect or instantiate user.");
      }
      Claims claims = (Claims) jwtToken.getBody();

      try {
        String username =
            claims.get(
                keycloakSettings.get().get(KeycloakConstants.USERNAME_CLAIM_SETTING), String.class);
        if (username == null) { // fallback to unique id promised by spec
          // https://openid.net/specs/openid-connect-basic-1_0.html#ClaimStability
          username = claims.getIssuer() + ":" + claims.getSubject();
        }
        String email = claims.get("email", String.class);
        if (isNullOrEmpty(email)) {
          sendError(
              response,
              400,
              "Unable to authenticate user because email address is not set in keycloak profile");
          return;
        }
        User user = userManager.getOrCreateUser(claims.getSubject(), email, username);
        subject =
            new AuthorizedSubject(
                new SubjectImpl(user.getName(), user.getId(), token, false), permissionChecker);
        session.setAttribute("che_subject", subject);
      } catch (ServerException | ConflictException e) {
        throw new ServletException(
            "Unable to identify user " + claims.getSubject() + " in Che database", e);
      }
    }

    try {
      EnvironmentContext.getCurrent().setSubject(subject);
      filterChain.doFilter(addUserInRequest(httpRequest, subject), response);
    } finally {
      EnvironmentContext.reset();
    }
  }


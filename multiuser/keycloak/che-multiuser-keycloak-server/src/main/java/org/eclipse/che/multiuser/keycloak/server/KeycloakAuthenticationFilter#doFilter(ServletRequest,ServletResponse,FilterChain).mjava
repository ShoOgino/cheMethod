  @Override
  public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
      throws IOException, ServletException {
    HttpServletRequest request = (HttpServletRequest) req;

    final String token = tokenExtractor.getToken(request);
    if (token == null) {
      send401(res, "Authorization token is missed");
      return;
    }

    Jws<Claims> jwt;
    try {
      if (shouldSkipAuthentication(request, token)) {
        chain.doFilter(req, res);
        return;
      }
      jwt = jwtParser.parseClaimsJws(token);
      LOG.debug("JWT = ", jwt);
      // OK, we can trust this JWT
    } catch (ExpiredJwtException e) {
      send401(res, "The specified token is expired");
      return;
    } catch (JwtException e) {
      send401(res, "Token validation failed: " + e.getMessage());
      return;
    }
    request.setAttribute("token", jwt);
    chain.doFilter(req, res);
  }


  @Test
  public void shouldAddPermissions() throws Exception {
    final EnvironmentContext ctx = new EnvironmentContext();
    ctx.setSubject(new SubjectImpl("test-user-name", "test-user-id", "test-token", false));
    EnvironmentContext.setCurrent(ctx);
    final StackImpl stack = createStack();

    permProvider.onEvent(new StackPersistedEvent(stack));

    final ArgumentCaptor<StackPermissionsImpl> captor =
        ArgumentCaptor.forClass(StackPermissionsImpl.class);
    verify(permManager).storePermission(captor.capture());
    final StackPermissionsImpl perm = captor.getValue();
    assertEquals(perm.getInstanceId(), stack.getId());
    assertEquals(perm.getUserId(), "test-user-id");
    assertEquals(perm.getDomainId(), StackDomain.DOMAIN_ID);
    assertEquals(perm.getActions(), StackDomain.getActions());
  }


  @Test
  public void shouldRecognizePredefinedStackWhenAFewPermissionsPagesIsRetrieved() throws Exception {
    final String stackId = "stack123";

    final AbstractPermissions privateStackPermission = mock(AbstractPermissions.class);
    when(privateStackPermission.getUserId()).thenReturn("userId");

    final AbstractPermissions publicStackPermission = mock(AbstractPermissions.class);
    when(publicStackPermission.getUserId()).thenReturn("*");

    final Page<AbstractPermissions> permissionsPage1 = mock(Page.class);
    when(permissionsPage1.getItems())
        .thenReturn(asList(privateStackPermission, privateStackPermission, privateStackPermission));
    when(permissionsPage1.hasNextPage()).thenReturn(true);

    final Page<AbstractPermissions> permissionsPage2 = mock(Page.class);
    when(permissionsPage2.getItems())
        .thenReturn(asList(privateStackPermission, publicStackPermission, privateStackPermission));
    when(permissionsPage2.hasNextPage()).thenReturn(false);

    doReturn(permissionsPage2)
        .when(permissionsFilter)
        .getNextPermissionsPage(stackId, permissionsPage1);
    doReturn(null).when(permissionsFilter).getNextPermissionsPage(stackId, permissionsPage2);
    when(permissionsManager.getByInstance(anyString(), anyString(), anyInt(), anyInt()))
        .thenReturn(permissionsPage1);

    assertTrue(permissionsFilter.isStackPredefined(stackId));
  }


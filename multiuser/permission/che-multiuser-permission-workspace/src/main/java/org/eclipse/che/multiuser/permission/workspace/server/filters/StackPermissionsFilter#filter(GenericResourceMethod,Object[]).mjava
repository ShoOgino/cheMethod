  @Override
  public void filter(GenericResourceMethod genericResourceMethod, Object[] arguments)
      throws ForbiddenException, ServerException {
    final String methodName = genericResourceMethod.getMethod().getName();

    final Subject currentSubject = EnvironmentContext.getCurrent().getSubject();
    String action;
    String stackId;

    switch (methodName) {
      case "getStack":
      case "getIcon":
        stackId = ((String) arguments[0]);
        action = READ;

        if (currentSubject.hasPermission(DOMAIN_ID, stackId, SEARCH)) {
          // allow to read stack if user has 'search' permission
          return;
        }
        break;

      case "updateStack":
      case "uploadIcon":
        stackId = ((String) arguments[1]);
        action = UPDATE;
        break;

      case "removeIcon":
        stackId = ((String) arguments[0]);
        action = UPDATE;
        break;

      case "removeStack":
        stackId = ((String) arguments[0]);
        action = DELETE;
        break;

      case "createStack":
      case "searchStacks":
        // available for all
        return;
      default:
        throw new ForbiddenException("The user does not have permission to perform this operation");
    }

    if (currentSubject.hasPermission(
            SystemDomain.DOMAIN_ID, null, SystemDomain.MANAGE_SYSTEM_ACTION)
        && isStackPredefined(stackId)) {
      // allow any operation with predefined stack if user has 'manageSystem' permission
      return;
    }

    if (!currentSubject.hasPermission(DOMAIN_ID, stackId, action)) {
      throw new ForbiddenException(
          "The user does not have permission to " + action + " stack with id '" + stackId + "'");
    }
  }


  @Test
  public void shouldAddPermissions() throws Exception {
    final EnvironmentContext ctx = new EnvironmentContext();
    ctx.setSubject(new SubjectImpl("test-user-name", "test-user-id", "test-token", false));
    EnvironmentContext.setCurrent(ctx);
    final OldRecipeImpl recipe = createRecipe();

    permProvider.onEvent(new RecipePersistedEvent(recipe));

    final ArgumentCaptor<RecipePermissionsImpl> captor =
        ArgumentCaptor.forClass(RecipePermissionsImpl.class);
    verify(permManager).storePermission(captor.capture());
    final RecipePermissionsImpl perm = captor.getValue();
    assertEquals(perm.getInstanceId(), recipe.getId());
    assertEquals(perm.getUserId(), "test-user-id");
    assertEquals(perm.getDomainId(), RecipeDomain.DOMAIN_ID);
    assertEquals(perm.getActions(), RecipeDomain.getActions());
  }


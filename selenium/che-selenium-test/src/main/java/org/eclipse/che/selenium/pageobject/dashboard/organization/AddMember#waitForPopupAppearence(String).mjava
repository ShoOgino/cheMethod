  /**
   * Wait for popup is attached to DOM and animation ends.
   *
   * @param xpath xpath to match the 'che-popup' element
   */
  private void waitForPopupAppearence(String xpath) {
    FluentWait<WebDriver> wait =
        new FluentWait<WebDriver>(seleniumWebDriver)
            .withTimeout(REDRAW_UI_ELEMENTS_TIMEOUT_SEC, TimeUnit.SECONDS)
            .pollingEvery(200, TimeUnit.MILLISECONDS)
            .ignoring(StaleElementReferenceException.class);

    Map<String, Integer> lastSize = new HashMap<>();
    lastSize.put("height", 0);
    lastSize.put("width", 0);

    wait.until(
        (Function<WebDriver, Boolean>)
            driver -> {
              List<WebElement> elements = seleniumWebDriver.findElements(By.xpath(xpath));
              if (elements.isEmpty()) {
                return false;
              }

              Dimension size = elements.get(0).getSize();
              if (lastSize.get("height") < size.getHeight()
                  || lastSize.get("width") < size.getHeight()) {
                lastSize.put("height", size.getHeight());
                lastSize.put("width", size.getWidth());

                return false;
              }

              return true;
            });
  }


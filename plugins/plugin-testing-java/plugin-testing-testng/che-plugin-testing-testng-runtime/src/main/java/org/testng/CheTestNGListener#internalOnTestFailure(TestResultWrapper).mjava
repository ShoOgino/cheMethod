  /**
   * Annalise method result when it was failed.
   *
   * @param wrapper wrapped method result
   */
  public void internalOnTestFailure(TestResultWrapper wrapper) {
    if (!parametersMap.containsKey(wrapper)) {
      internalOnTestStart(wrapper);
    }

    Throwable throwable = wrapper.getThrowable();
    String testMethodName = getTestMethodName(wrapper);
    Map<String, String> params = new HashMap<>();
    params.put("name", testMethodName);
    if (throwable != null) {
      String failMessage = throwable.getMessage();
      //TODO add message replacement with 'Expected[] but Found[]'
      String stackTrace = getStackTrace(throwable);
      params.put("message", failMessage);
      params.put("details", stackTrace);
    } else {
      params.put("message", "");
    }

    out.println();
    testFailed(out, params);
    onTestFinished(wrapper);
  }


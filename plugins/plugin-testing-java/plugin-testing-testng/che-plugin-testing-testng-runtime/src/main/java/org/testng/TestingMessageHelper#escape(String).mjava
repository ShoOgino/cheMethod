  private static String escape(String str) {
    if (str == null) {
      return null;
    }

    int escapeLength = calculateEscapedStringLength(str);
    if (escapeLength == str.length()) {
      return str;
    }

    char[] chars = new char[escapeLength];
    int currentOffset = 0;
    for (int i = 0; i < str.length(); i++) {
      char c = str.charAt(i);
      char escape = escapeChar(c);
      if (escape != 0) {
        chars[currentOffset++] = ESCAPE_SEPARATOR;
        chars[currentOffset++] = escape;
      } else {
        chars[currentOffset++] = c;
      }
    }

    return new String(chars);
  }


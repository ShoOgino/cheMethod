  @Test
  public void shouldUseTextEditFirst() throws Exception {
    TextEdit textEdit = mock(TextEdit.class);
    Range range = mock(Range.class);
    Position startPosition = mock(Position.class);
    Position endPosition = mock(Position.class);

    when(serverCapabilities.getCompletionProvider()).thenReturn(completionOptions);
    when(completionOptions.getResolveProvider()).thenReturn(false);

    when(document.getCursorPosition()).thenReturn(new TextPosition(0, 5));
    when(completion.getInsertText()).thenReturn("foo");
    when(completion.getLabel()).thenReturn("bar");
    when(completion.getTextEdit()).thenReturn(textEdit);

    when(textEdit.getRange()).thenReturn(range);
    when(textEdit.getNewText()).thenReturn("fooBar");

    when(range.getStart()).thenReturn(startPosition);
    when(range.getEnd()).thenReturn(endPosition);

    when(startPosition.getLine()).thenReturn(1);
    when(startPosition.getCharacter()).thenReturn(5);

    when(endPosition.getLine()).thenReturn(1);
    when(endPosition.getCharacter()).thenReturn(5);

    Completion[] completions = new Completion[1];
    proposal.getCompletion(completion -> completions[0] = completion);

    completions[0].apply(document);

    verify(document, times(1)).replace(eq(1), eq(5), eq(1), eq(5), eq("fooBar"));
    verify(document, times(1)).replace(anyInt(), anyInt(), anyInt(), anyInt(), anyString());
  }


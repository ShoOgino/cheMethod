  @Test
  public void shouldPlaceCursorInRightPositionWithInsertedText() throws Exception {

    when(serverCapabilities.getCompletionProvider()).thenReturn(completionOptions);
    when(completionOptions.getResolveProvider()).thenReturn(false);

    when(document.getCursorPosition()).thenReturn(new TextPosition(0, 5));
    when(completion.getInsertText()).thenReturn("foo");

    when(document.getIndexFromPosition(any())).thenReturn(5);

    Completion[] completions = new Completion[1];
    proposal.getCompletion(completion -> completions[0] = completion);

    completions[0].apply(document);
    LinearRange selection = completions[0].getSelection(document);

    assertEquals(8, selection.getStartOffset());
    assertEquals(0, selection.getLength());
  }


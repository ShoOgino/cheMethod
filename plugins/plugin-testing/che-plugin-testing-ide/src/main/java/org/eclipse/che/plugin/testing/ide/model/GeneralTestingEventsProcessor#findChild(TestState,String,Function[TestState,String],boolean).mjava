  @Nullable
  private TestState findChild(
      TestState parentSuite,
      String name,
      Function<TestState, String> nameFunction,
      boolean preferSuite) {
    if (treeBuildBeforeStart) {
      Set<TestState> result = new HashSet<>();
      Collection<TestState> children;
      if (gettingChildren) {
        children = parentSuite.getChildren();
      } else {
        children = currentChildren;
      }

      for (TestState child : children) {
        if (!child.isFinal() && name.equals(nameFunction.apply(child))) {
          result.add(child);
        }
      }

      if (!result.isEmpty()) {
        return result
            .stream()
            .filter(testState -> testState.isSuite() == preferSuite)
            .findFirst()
            .orElse(result.iterator().next());
      }
    }
    return null;
  }


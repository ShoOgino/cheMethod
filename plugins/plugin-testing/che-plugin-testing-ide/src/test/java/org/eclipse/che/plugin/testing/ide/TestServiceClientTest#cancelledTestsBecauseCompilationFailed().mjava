  @Test
  public void cancelledTestsBecauseCompilationFailed() {
    Promise<CommandImpl> compileCommandPromise =
        createCommandPromise(
            new CommandImpl("test-compile", "mvn test-compile -f ${current.project.path}", "mvn"));

    Promise<TestResult> result =
        testServiceClient.runTestsAfterCompilation(
            projectPath, testFramework, parameters, statusNotification, compileCommandPromise);

    triggerProcessEvents(
        processStartResponse(true),
        processStarted(),
        processStdErr("A small warning"),
        processStdOut("BUILD FAILURE"),
        processDied());

    verify(testServiceClient, never())
        .sendTests(anyString(), anyString(), anyMapOf(String.class, String.class));
    verify(statusNotification)
        .setContent("Compiling the project before starting the test session.");
    result.catchError(
        new Operation<PromiseError>() {
          @Override
          public void apply(PromiseError promiseError) throws OperationException {
            Throwable cause = promiseError.getCause();
            Assert.assertNotNull(cause);
            Assert.assertEquals(TestServiceClient.PROJECT_BUILD_FAILED_MESSAGE, cause.getMessage());
          }
        });
  }


    @Override
    public JdiField[] getFields() throws DebuggerException {
        if (fields == null) {
            try {
                ObjectReference object = stackFrame.thisObject();
                if (object == null) {
                    ReferenceType type = stackFrame.location().declaringType();
                    List<Field> fs = stackFrame.location().declaringType().allFields();
                    fields = new JdiField[fs.size()];
                    int i = 0;
                    for (Field f : fs) {
                        fields[i++] = new JdiFieldImpl(f, type);
                    }
                } else {
                    List<Field> fs = object.referenceType().allFields();
                    fields = new JdiField[fs.size()];
                    int i = 0;
                    for (Field f : fs) {
                        fields[i++] = new JdiFieldImpl(f, object);
                    }
                }

                Arrays.sort(fields);
            } catch (InvalidStackFrameException e) {
                throw new DebuggerException(e.getMessage(), e);
            }
        }
        return fields;
    }


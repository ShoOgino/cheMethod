  @Test
  public void showErrorMessageIfCanNotShowPreviewWindow() throws Exception {
    when(moveSettings.isUpdateQualifiedNames()).thenReturn(true);
    when(changeCreationResult.isCanShowPreviewPage()).thenReturn(false);

    presenter.onPreviewButtonClicked();

    verify(moveSettings).setSessionId(anyString());
    verify(moveSettings).setUpdateReferences(anyBoolean());
    verify(moveSettings).setUpdateQualifiedNames(anyBoolean());
    verify(moveSettings).setFilePatterns(anyString());
    verify(session).setSessionId(anyString());

    verify(moveSettingsPromise).thenPromise(changeCreationFunction.capture());
    changeCreationFunction.getValue().apply(any());
    verify(refactorService).createChange(session);

    verify(changeCreationResultPromise).then(changeResultOperation.capture());
    changeResultOperation.getValue().apply(changeCreationResult);
    verify(previewPresenter, never()).show(anyString(), any());
    verify(moveView, never()).hide();
    verify(moveView).showStatusMessage(refactoringStatus);
  }


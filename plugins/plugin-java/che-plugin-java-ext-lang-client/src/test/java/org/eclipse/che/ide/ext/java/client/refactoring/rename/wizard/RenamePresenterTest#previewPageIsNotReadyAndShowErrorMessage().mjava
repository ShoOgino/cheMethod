  @Test
  public void previewPageIsNotReadyAndShowErrorMessage() throws Exception {
    when(changeCreationResult.isCanShowPreviewPage()).thenReturn(false);
    when(changeCreationResult.getStatus()).thenReturn(refactoringStatus);
    when(refactoringStatus.getSeverity()).thenReturn(4);

    renamePresenter.show(refactorInfo);

    verify(refactorService).createRenameRefactoring(createRenameRefactoringDto);
    verify(renameRefactoringSessionPromise).then(renameRefactoringSessionCaptor.capture());
    renameRefactoringSessionCaptor.getValue().apply(session);

    renamePresenter.onPreviewButtonClicked();

    verify(refactoringSession).setSessionId(SESSION_ID);

    verifyPreparingRenameSettingsDto();
    verifyPreparingRenameChanges();

    verify(changeCreationResultPromise).then(changeCreationResultCaptor.capture());
    changeCreationResultCaptor.getValue().apply(changeCreationResult);
    verify(view).showErrorMessage(refactoringStatus);
  }


  @Test
  public void changedValuesShouldBeSaved() throws OperationException {
    initWidgets();
    when(widget.getSelectedValue()).thenReturn(VALUE_2);
    when(preferencesManager.getValue(anyString())).thenReturn(VALUE_1);

    presenter.go(container);

    verify(mapPromise).then(operationCaptor.capture());
    operationCaptor.getValue().apply(getAllProperties());

    presenter.storeChanges();

    verify(preferencesManager, times(18)).setValue(anyString(), anyString());
    verify(preferencesManager, times(36)).getValue(anyString());

    when(preferencesManager.getValue(anyString())).thenReturn(VALUE_2);

    assertThat(presenter.isDirty(), equalTo(false));
  }


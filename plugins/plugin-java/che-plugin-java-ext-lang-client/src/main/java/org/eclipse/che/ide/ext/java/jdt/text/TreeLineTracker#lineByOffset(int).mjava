  /**
   * Returns the line number for the given offset. If the offset is between two lines, the line
   * starting at <code>offset</code> is returned. The last line is returned if <code>offset</code>
   * is equal to the document length.
   *
   * @param offset a document offset
   * @return the line number starting at or containing <code>offset</code>
   * @throws BadLocationException if the offset is invalid
   */
  private int lineByOffset(final int offset) throws BadLocationException {
    /* Works for any binary search tree. */
    int remaining = offset;
    Node node = fRoot;
    int line = 0;

    while (true) {
      if (node == null) fail(offset);

      if (remaining < node.offset) {
        node = node.left;
      } else {
        remaining -= node.offset;
        line += node.line;
        if (remaining < node.length || remaining == node.length && node.right == null) // last line
        return line;

        remaining -= node.length;
        line++;
        node = node.right;
      }
    }
  }


  /*
   * @see org.eclipse.jface.text.ILineTracker#replace(int, int, java.lang.String)
   */
  public final void replace(int offset, int length, String text) throws BadLocationException {
    if (ASSERT) checkTree();

    // Inlined nodeByOffset as we need both node and offset
    int remaining = offset;
    Node first = fRoot;
    final int firstNodeOffset;

    while (true) {
      if (first == null) fail(offset);

      if (remaining < first.offset) {
        first = first.left;
      } else {
        remaining -= first.offset;
        if (remaining < first.length
            || remaining == first.length && first.right == null) { // last line
          firstNodeOffset = offset - remaining;
          break;
        }
        remaining -= first.length;
        first = first.right;
      }
    }
    // Inline nodeByOffset end
    if (ASSERT) Assert.isTrue(first != null);

    Node last;
    if (offset + length < firstNodeOffset + first.length) last = first;
    else last = nodeByOffset(offset + length);
    if (ASSERT) Assert.isTrue(last != null);

    int firstLineDelta = firstNodeOffset + first.length - offset;
    if (first == last) replaceInternal(first, text, length, firstLineDelta);
    else replaceFromTo(first, last, text, length, firstLineDelta);

    if (ASSERT) checkTree();
  }


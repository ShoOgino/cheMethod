    /**
     * Returns the offset for the given line number. Note that the last line is always incomplete, i.e. has the {@link #NO_DELIM}
     * delimiter.
     *
     * @param line
     *         a line number
     * @return the line offset with the given line number
     * @throws BadLocationException
     *         if the line is invalid
     */
    private int offsetByLine(final int line) throws BadLocationException {
      /* Works for any binary search tree. */
        int remaining = line;
        int offset = 0;
        Node node = fRoot;

        while (true) {
            if (node == null)
                fail(line);

            if (remaining == node.line)
                return offset + node.offset;

            if (remaining < node.line) {
                node = node.left;
            } else {
                remaining -= node.line + 1;
                offset += node.offset + node.length;
                node = node.right;
            }
        }
    }


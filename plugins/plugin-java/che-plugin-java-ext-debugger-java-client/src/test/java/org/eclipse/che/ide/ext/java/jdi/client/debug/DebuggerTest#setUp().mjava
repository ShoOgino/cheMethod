    @Before
    public void setUp() {
        MockitoAnnotations.initMocks(this);

        super.setUp();

        doReturn(location).when(dtoFactory).createDto(Location.class);
        doReturn(jdiBreakpoint).when(dtoFactory).createDto(BreakPoint.class);


        doReturn(messageBus).when(messageBusProvider).getMachineMessageBus();

        doReturn(localStorage).when(localStorageProvider).get();
        doReturn(DEBUG_INFO).when(localStorage).getItem(JavaDebugger.LOCAL_STORAGE_DEBUGGER_KEY);
        doReturn(javaDebuggerInfo).when(dtoFactory).createDtoFromJson(DEBUG_INFO, JavaDebuggerInfo.class);

        doReturn(fgnResolver).when(fqnResolverFactory).getResolver(anyString());
        doReturn(FQN).when(fgnResolver).resolveFqn(file);

        doReturn(PATH).when(file).getPath();

        debugger = new JavaDebugger(service, dtoFactory, localStorageProvider, messageBusProvider, eventBus, fqnResolverFactory, appContext,
                                    javaDebuggerFileHandler,
                                    debuggerManager, fileTypeRegistry);
        doReturn(promiseEventList).when(service).checkEvents(DEBUGGER_ID);
        doReturn(promiseEventList).when(promiseEventList).then(any(Operation.class));

        // setup messageBus
        verify(eventBus).addHandler(eq(WsAgentStateEvent.TYPE), extServerStateHandlerCaptor.capture());
        extServerStateHandlerCaptor.getValue().onWsAgentStarted(WsAgentStateEvent.createWsAgentStartedEvent());

        debugger.addObserver(observer);

        FileType fileType = mock(FileType.class);
        doReturn(Collections.singletonList("application/java")).when(fileType).getMimeTypes();
        doReturn(fileType).when(fileTypeRegistry).getFileTypeByFile(eq(file));
    }


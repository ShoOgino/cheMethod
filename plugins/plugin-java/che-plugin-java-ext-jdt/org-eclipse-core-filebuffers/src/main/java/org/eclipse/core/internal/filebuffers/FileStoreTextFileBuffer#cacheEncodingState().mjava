  protected void cacheEncodingState() {
    fEncoding = fExplicitEncoding;
    fHasBOM = false;
    fIsCacheUpdated = true;

    InputStream stream = null;
    try {
      stream = getFileContents(fFileStore);
      if (stream == null) return;

      QualifiedName[] options =
          new QualifiedName[] {IContentDescription.CHARSET, IContentDescription.BYTE_ORDER_MARK};
      IContentDescription description =
          null; //Platform.getContentTypeManager().getDescriptionFor(stream, fFileStore.getName(), options);
      if (description != null) {
        fHasBOM = description.getProperty(IContentDescription.BYTE_ORDER_MARK) != null;
        if (fEncoding == null) fEncoding = description.getCharset();
      }
    } catch (CoreException e) {
      // do nothing
    } /*catch (IOException e) {
      	// do nothing
      }*/ finally {
      try {
        if (stream != null) stream.close();
      } catch (IOException ex) {
        FileBuffersPlugin.getDefault()
            .log(
                new Status(
                    IStatus.ERROR,
                    FileBuffersPlugin.PLUGIN_ID,
                    IStatus.OK,
                    FileBuffersMessages.JavaTextFileBuffer_error_closeStream,
                    ex));
      }
    }

    // Use global default
    if (fEncoding == null) fEncoding = fManager.getDefaultEncoding();
  }


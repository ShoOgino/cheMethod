  String getContent(
      IDocument document, IRegion region, boolean expandRegionToFullLine, int surroundingLines)
      throws CoreException {
    try {
      if (expandRegionToFullLine) {
        int startLine =
            Math.max(document.getLineOfOffset(region.getOffset()) - surroundingLines, 0);
        int endLine;
        if (region.getLength() == 0) {
          // no lines are in the region, so remove one from the context,
          // or else spurious changes show up that look like deletes from the source
          if (surroundingLines == 0) {
            // empty: show nothing
            return ""; // $NON-NLS-1$
          }

          endLine =
              Math.min(
                  document.getLineOfOffset(region.getOffset()) + surroundingLines - 1,
                  document.getNumberOfLines() - 1);
        } else {
          endLine =
              Math.min(
                  document.getLineOfOffset(region.getOffset() + region.getLength() - 1)
                      + surroundingLines,
                  document.getNumberOfLines() - 1);
        }

        int offset = document.getLineInformation(startLine).getOffset();
        IRegion endLineRegion = document.getLineInformation(endLine);
        int length = endLineRegion.getOffset() + endLineRegion.getLength() - offset;
        return document.get(offset, length);

      } else {
        return document.get(region.getOffset(), region.getLength());
      }
    } catch (BadLocationException e) {
      throw Changes.asCoreException(e);
    }
  }


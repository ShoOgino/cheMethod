  /**
   * Returns a document representing the current state of the buffer, prior to the application of
   * the change.
   *
   * <p>The returned document should not be modified.
   *
   * @param monitor the progress monitor to use, or <code>null</code>
   * @return the current document, or the empty document
   * @throws CoreException if no document could be acquired
   */
  public final IDocument getCurrentDocument(IProgressMonitor monitor) throws CoreException {
    if (monitor == null) monitor = new NullProgressMonitor();
    IDocument result = null;
    monitor.beginTask("", 2); // $NON-NLS-1$
    try {
      result = acquireDocument(new SubProgressMonitor(monitor, 1));
    } finally {
      if (result != null) releaseDocument(result, new SubProgressMonitor(monitor, 1));
    }
    monitor.done();
    if (result == null) result = new Document();
    return result;
  }


  /**
   * Returns a document representing the preview of the refactored buffer, after the application of
   * the change object.
   *
   * @param monitor the progress monitor to use, or <code>null</code>
   * @return the preview document, or an empty document
   * @throws CoreException if no document could be acquired
   */
  public final IDocument getPreviewDocument(IProgressMonitor monitor) throws CoreException {
    if (monitor == null) monitor = new NullProgressMonitor();

    IDocument result = null;
    IDocument document = null;

    try {

      document = acquireDocument(new SubProgressMonitor(monitor, 1));
      if (document != null) {
        result = new Document(document.get());

        performChanges(result, null, true);
      }

    } catch (BadLocationException exception) {
      throw Changes.asCoreException(exception);
    } finally {
      if (document != null) {
        releaseDocument(document, new SubProgressMonitor(monitor, 1));
      }
      monitor.done();
    }
    if (result == null) result = new Document();
    return result;
  }


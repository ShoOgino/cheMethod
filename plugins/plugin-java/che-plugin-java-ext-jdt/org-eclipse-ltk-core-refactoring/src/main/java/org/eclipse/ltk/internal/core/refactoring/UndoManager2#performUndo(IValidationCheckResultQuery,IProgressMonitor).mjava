  public void performUndo(IValidationCheckResultQuery query, IProgressMonitor pm)
      throws CoreException {
    IUndoableOperation undo =
        fOperationHistory.getUndoOperation(RefactoringCorePlugin.getUndoContext());
    UndoableOperation2ChangeAdapter changeOperation = getUnwrappedOperation(undo);
    if (changeOperation == null)
      throw new CoreException(
          new Status(
              IStatus.ERROR,
              RefactoringCorePlugin.getPluginId(),
              IStatus.ERROR,
              RefactoringCoreMessages.UndoManager2_no_change,
              null));
    if (query == null) query = new NullQuery();
    try {
      fOperationHistory.undoOperation(undo, pm, new QueryAdapter(query));
    } catch (ExecutionException e) {
      handleException(e);
    }
  }


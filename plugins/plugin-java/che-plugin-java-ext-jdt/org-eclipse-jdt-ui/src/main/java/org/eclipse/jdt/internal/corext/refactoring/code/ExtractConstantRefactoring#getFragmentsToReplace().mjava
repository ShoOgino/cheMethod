  private IASTFragment[] getFragmentsToReplace() throws JavaModelException {
    List<IASTFragment> toReplace = new ArrayList<IASTFragment>();
    if (fReplaceAllOccurrences) {
      Iterator<ASTNode> replacementScope = getReplacementScope();
      while (replacementScope.hasNext()) {
        ASTNode scope = replacementScope.next();
        IASTFragment[] allMatches =
            ASTFragmentFactory.createFragmentForFullSubtree(scope)
                .getSubFragmentsMatching(getSelectedExpression());
        IASTFragment[] replaceableMatches = retainOnlyReplacableMatches(allMatches);
        for (int i = 0; i < replaceableMatches.length; i++) toReplace.add(replaceableMatches[i]);
      }
    } else if (canReplace(getSelectedExpression())) toReplace.add(getSelectedExpression());
    return toReplace.toArray(new IASTFragment[toReplace.size()]);
  }


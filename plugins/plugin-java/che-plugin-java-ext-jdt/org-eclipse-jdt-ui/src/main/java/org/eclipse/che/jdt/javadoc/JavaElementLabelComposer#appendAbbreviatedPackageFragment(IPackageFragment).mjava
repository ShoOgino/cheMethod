  private void appendAbbreviatedPackageFragment(IPackageFragment pack) {
    refreshPackageNameAbbreviation();

    String pkgName = pack.getElementName();

    if (fgPkgNameAbbreviation != null && fgPkgNameAbbreviation.length != 0) {

      for (int i = 0; i < fgPkgNameAbbreviation.length; i++) {
        PackageNameAbbreviation abbr = fgPkgNameAbbreviation[i];

        String abbrPrefix = abbr.getPackagePrefix();
        if (pkgName.startsWith(abbrPrefix)) {
          int abbrPrefixLength = abbrPrefix.length();
          int pkgLength = pkgName.length();
          if (!(pkgLength == abbrPrefixLength || pkgName.charAt(abbrPrefixLength) == '.')) continue;

          fBuffer.append(abbr.getAbbreviation());

          if (pkgLength > abbrPrefixLength) {
            fBuffer.append('.');

            String remaining = pkgName.substring(abbrPrefixLength + 1);

            if (isPackageNameCompressionEnabled()) appendCompressedPackageFragment(remaining);
            else fBuffer.append(remaining);
          }

          return;
        }
      }
    }

    if (isPackageNameCompressionEnabled()) {
      appendCompressedPackageFragment(pkgName);
    } else {
      fBuffer.append(pkgName);
    }
  }


  /**
   * Returns the expected type if any, <code>null</code> otherwise.
   *
   * <p><strong>Note:</strong> This method may run {@linkplain
   * org.eclipse.jdt.core.ICodeAssist#codeComplete(int, org.eclipse.jdt.core.CompletionRequestor)
   * codeComplete} on the compilation unit.
   *
   * @return the expected type if any, <code>null</code> otherwise
   */
  public IType getExpectedType() {
    if (fType == null && getCompilationUnit() != null) {
      CompletionContext context = getCoreContext();
      if (context != null) {
        char[][] expectedTypes = context.getExpectedTypesSignatures();
        if (expectedTypes != null && expectedTypes.length > 0) {
          IJavaProject project = getCompilationUnit().getJavaProject();
          if (project != null) {
            try {
              fType =
                  project.findType(
                      SignatureUtil.stripSignatureToFQN(String.valueOf(expectedTypes[0])));
            } catch (JavaModelException x) {
              JavaPlugin.log(x);
            }
          }
        }
      }
    }
    return fType;
  }


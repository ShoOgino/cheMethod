  private Selection adjustSelection(char[] characters, Selection selection, int end) {
    int newEnd = selection.getInclusiveEnd();
    for (int i = selection.getExclusiveEnd(); i <= end; i++) {
      char ch = characters[i];
      if (ch != '\n' && ch != '\r') break;
      newEnd++;
    }
    return Selection.createFromStartEnd(selection.getOffset(), newEnd);
  }


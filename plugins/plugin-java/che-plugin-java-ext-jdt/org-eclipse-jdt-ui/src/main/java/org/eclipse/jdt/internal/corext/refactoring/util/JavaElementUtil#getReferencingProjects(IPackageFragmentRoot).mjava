  /**
   * @param root the package fragment root
   * @return array of projects that have the specified root on their classpath
   * @throws JavaModelException if getting the raw classpath or all Java projects fails
   */
  public static IJavaProject[] getReferencingProjects(IPackageFragmentRoot root)
      throws JavaModelException {
    IClasspathEntry cpe = root.getRawClasspathEntry();
    if (cpe.getEntryKind() == IClasspathEntry.CPE_LIBRARY) cpe = root.getResolvedClasspathEntry();
    IJavaProject[] allJavaProjects =
        JavaCore.create(ResourcesPlugin.getWorkspace().getRoot()).getJavaProjects();
    List<IJavaProject> result = new ArrayList<IJavaProject>(allJavaProjects.length);
    for (int i = 0; i < allJavaProjects.length; i++) {
      IJavaProject project = allJavaProjects[i];
      IPackageFragmentRoot[] roots = project.findPackageFragmentRoots(cpe);
      if (roots.length > 0) result.add(project);
    }
    return result.toArray(new IJavaProject[result.size()]);
  }


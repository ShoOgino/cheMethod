  public static int getIndentationLevel(ASTNode node, ICompilationUnit unit) throws CoreException {
    IPath fullPath = unit.getCorrespondingResource().getFullPath();
    try {
      FileBuffers.getTextFileBufferManager()
          .connect(fullPath, LocationKind.IFILE, new NullProgressMonitor());
      ITextFileBuffer buffer =
          FileBuffers.getTextFileBufferManager().getTextFileBuffer(fullPath, LocationKind.IFILE);
      try {
        IRegion region = buffer.getDocument().getLineInformationOfOffset(node.getStartPosition());
        return Strings.computeIndentUnits(
            buffer.getDocument().get(region.getOffset(), region.getLength()),
            unit.getJavaProject());
      } catch (BadLocationException exception) {
        JavaPlugin.log(exception);
      }
      return 0;
    } finally {
      FileBuffers.getTextFileBufferManager()
          .disconnect(fullPath, LocationKind.IFILE, new NullProgressMonitor());
    }
  }


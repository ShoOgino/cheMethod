  @Override
  public RefactoringStatus checkFinalConditions(IProgressMonitor pm) throws CoreException {
    pm.beginTask(RefactoringCoreMessages.ExtractConstantRefactoring_checking_preconditions, 2);

    /* Note: some checks are performed on change of input widget
     * values. (e.g. see ExtractConstantRefactoring.checkConstantNameOnChange())
     */

    //TODO: possibly add more checking for name conflicts that might
    //      lead to a change in behavior

    try {
      RefactoringStatus result = new RefactoringStatus();

      createConstantDeclaration();
      replaceExpressionsWithConstant();
      fChange =
          fCuRewrite.createChange(
              RefactoringCoreMessages.ExtractConstantRefactoring_change_name,
              true,
              new SubProgressMonitor(pm, 1));

      if (fCheckResultForCompileProblems) {
        checkSource(new SubProgressMonitor(pm, 1), result);
      }
      return result;
    } finally {
      fConstantTypeCache = null;
      fCuRewrite.clearASTAndImportRewrites();
      pm.done();
    }
  }


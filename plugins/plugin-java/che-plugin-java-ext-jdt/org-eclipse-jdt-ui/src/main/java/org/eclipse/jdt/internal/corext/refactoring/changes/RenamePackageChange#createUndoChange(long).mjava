  @Override
  protected Change createUndoChange(long stampToRestore) throws CoreException {
    IPackageFragment pack = getPackage();
    if (pack == null) return new NullChange();
    Map<IResource, Long> stamps = new HashMap<IResource, Long>();
    if (!fRenameSubpackages) {
      addStamps(stamps, pack.getCompilationUnits());
    } else {
      IPackageFragment[] allPackages = JavaElementUtil.getPackageAndSubpackages(pack);
      for (int i = 0; i < allPackages.length; i++) {
        IPackageFragment currentPackage = allPackages[i];
        addStamps(stamps, currentPackage.getCompilationUnits());
      }
    }
    return new RenamePackageChange(
        createNewPath(), getNewName(), getOldName(), stampToRestore, stamps, fRenameSubpackages);
    // Note: This reverse change only works if the renamePackage change did
    // not merge the source package into an existing target.
  }


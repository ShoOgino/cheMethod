  @Override
  protected Change doDelete(IProgressMonitor pm) throws CoreException {
    if (!confirmDeleteIfReferenced()) return new NullChange();
    int resourceUpdateFlags = IResource.KEEP_HISTORY;
    int jCoreUpdateFlags =
        IPackageFragmentRoot.ORIGINATING_PROJECT_CLASSPATH
            | IPackageFragmentRoot.OTHER_REFERRING_PROJECTS_CLASSPATH;

    pm.beginTask("", 2); // $NON-NLS-1$
    IPackageFragmentRoot root = getRoot();
    IResource rootResource = root.getResource();
    CompositeChange result = new CompositeChange(getName());

    ResourceDescription rootDescription = ResourceDescription.fromResource(rootResource);
    IJavaProject[] referencingProjects = JavaElementUtil.getReferencingProjects(root);
    HashMap<IFile, String> classpathFilesContents = new HashMap<IFile, String>();
    for (int i = 0; i < referencingProjects.length; i++) {
      IJavaProject javaProject = referencingProjects[i];
      IFile classpathFile = javaProject.getProject().getFile(".classpath"); // $NON-NLS-1$
      if (classpathFile.exists()) {
        classpathFilesContents.put(classpathFile, getFileContents(classpathFile));
      }
    }

    root.delete(resourceUpdateFlags, jCoreUpdateFlags, new SubProgressMonitor(pm, 1));

    rootDescription.recordStateFromHistory(rootResource, new SubProgressMonitor(pm, 1));
    for (Iterator<Entry<IFile, String>> iterator = classpathFilesContents.entrySet().iterator();
        iterator.hasNext(); ) {
      Entry<IFile, String> entry = iterator.next();
      IFile file = entry.getKey();
      String contents = entry.getValue();
      // Restore time stamps? This should probably be some sort of UndoTextFileChange.
      TextFileChange classpathUndo =
          new TextFileChange(
              Messages.format(
                  RefactoringCoreMessages.DeletePackageFragmentRootChange_restore_file,
                  BasicElementLabels.getPathLabel(file.getFullPath(), true)),
              file);
      classpathUndo.setEdit(new ReplaceEdit(0, getFileLength(file), contents));
      result.add(classpathUndo);
    }
    result.add(new UndoDeleteResourceChange(rootDescription));

    pm.done();
    return result;
  }


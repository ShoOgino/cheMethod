  protected final Change performChange(Refactoring refactoring, boolean storeUndo)
      throws Exception {
    CreateChangeOperation create = new CreateChangeOperation(refactoring);
    PerformChangeOperation perform = new PerformChangeOperation(create);
    if (storeUndo) {
      perform.setUndoManager(getUndoManager(), refactoring.getName());
    }
    ResourcesPlugin.getWorkspace().run(perform, new NullProgressMonitor());
    assertTrue("Change wasn't executed", perform.changeExecuted());
    return perform.getUndoChange();
  }


  @BeforeClass
  protected void initProjectApi() throws Exception {
    TestWorkspaceHolder workspaceHolder = new TestWorkspaceHolder(new ArrayList<>());
    File root = new File("target/test-classes");
    assertTrue(root.exists());

    File indexDir = new File("target/fs_index");
    assertTrue(indexDir.mkdirs());

    Set<PathMatcher> filters = new HashSet<>();
    filters.add(path -> true);
    FSLuceneSearcherProvider sProvider = new FSLuceneSearcherProvider(indexDir, filters);

    EventService eventService = new EventService();
    LocalVirtualFileSystemProvider vfsProvider =
        new LocalVirtualFileSystemProvider(root, sProvider);
    ProjectTypeRegistry projectTypeRegistry = new ProjectTypeRegistry(new HashSet<>());
    projectTypeRegistry.registerProjectType(new JavaProjectType(new JavaValueProviderFactory()));
    ProjectHandlerRegistry projectHandlerRegistry = new ProjectHandlerRegistry(new HashSet<>());
    ProjectRegistry projectRegistry =
        new ProjectRegistry(
            workspaceHolder,
            vfsProvider,
            projectTypeRegistry,
            projectHandlerRegistry,
            eventService);
    projectRegistry.initProjects();

    ProjectImporterRegistry importerRegistry = new ProjectImporterRegistry(new HashSet<>());
    FileWatcherNotificationHandler fileWatcherNotificationHandler =
        new DefaultFileWatcherNotificationHandler(vfsProvider);
    projectManager =
        new ProjectManager(
            vfsProvider,
            projectTypeRegistry,
            mock(WorkspaceSyncCommunication.class),
            projectRegistry,
            projectHandlerRegistry,
            importerRegistry,
            fileWatcherNotificationHandler,
            workspaceHolder,
            mock(FileWatcherManager.class));

    ResourcesPlugin resourcesPlugin =
        new ResourcesPlugin(
            "target/index", root.getAbsolutePath(), () -> projectRegistry, () -> projectManager);
    resourcesPlugin.start();

    JavaPlugin javaPlugin =
        new JavaPlugin(root.getAbsolutePath() + "/.settings", resourcesPlugin, projectRegistry);
    javaPlugin.start();

    JavaModelManager.getDeltaState().initializeRoots(true);

    createJavaFile();

    Formatter formatter = new Formatter();
    service = new JavaFormatterService(projectManager, formatter);
  }


    private IJavaElement getSelectedElement(IType type, int offset, int lineStartOffset) throws JavaModelException {
        if (offset <= lineStartOffset) {
            return null;
        }
        ICompilationUnit compilationUnit = type.getCompilationUnit();
        IJavaElement[] javaElements = compilationUnit.codeSelect(offset, 0);

        if (javaElements.length == 0) {
            return getSelectedElement(type, --offset, lineStartOffset);
        }

        IJavaElement element = javaElements[0];

        if (element.getElementType() == METHOD) {
            return element;
        }

        return getSelectedElement(type, --offset, lineStartOffset);
    }


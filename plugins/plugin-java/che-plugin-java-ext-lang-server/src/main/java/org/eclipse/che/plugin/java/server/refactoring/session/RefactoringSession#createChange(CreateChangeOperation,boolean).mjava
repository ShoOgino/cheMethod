  private Change createChange(CreateChangeOperation operation, boolean updateStatus)
      throws RefactoringException {
    CoreException exception = null;
    try {
      ResourcesPlugin.getWorkspace().run(operation, new NullProgressMonitor());
    } catch (CoreException e) {
      exception = e;
    }

    if (updateStatus) {
      RefactoringStatus status = null;
      if (exception != null) {
        status = new RefactoringStatus();
        String msg = exception.getMessage();
        if (msg != null) {
          status.addFatalError(Messages.format("{0}. See the error log for more details.", msg));
        } else {
          status.addFatalError(
              "An unexpected exception occurred while creating a change object. See the error log for more details.");
        }
        JavaPlugin.log(exception);
      } else {
        status = operation.getConditionCheckingStatus();
      }
      setConditionCheckingStatus(status);
    } else {
      if (exception != null) throw new RefactoringException(exception);
    }
    Change change = operation.getChange();
    return change;
  }


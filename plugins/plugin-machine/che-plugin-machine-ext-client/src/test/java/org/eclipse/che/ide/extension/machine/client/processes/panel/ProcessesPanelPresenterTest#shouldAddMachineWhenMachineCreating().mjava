    @Test
    public void shouldAddMachineWhenMachineCreating() throws Exception {
        MachineDto machineDto = mock(MachineDto.class);
        MachineConfigDto machineConfigDto = mock(MachineConfigDto.class);
        OutputConsole outputConsole = mock(OutputConsole.class);
        when(machineConfigDto.getName()).thenReturn("machine_name");
        when(machineDto.getConfig()).thenReturn(machineConfigDto);
        when(appContext.getWorkspaceId()).thenReturn(WORKSPACE_ID);
        when(commandConsoleFactory.create(eq("machine_name"))).thenReturn(outputConsole);

        MachineStateEvent machineStateEvent = mock(MachineStateEvent.class);
        when(machineStateEvent.getMachine()).thenReturn(machineDto);
        verify(eventBus, times(5)).addHandler(anyObject(), machineStateHandlerCaptor.capture());
        MachineStateEvent.Handler machineStateHandler = machineStateHandlerCaptor.getAllValues().get(0);
        machineStateHandler.onMachineCreating(machineStateEvent);

        verify(outputConsole).go(acceptsOneWidgetCaptor.capture());
        IsWidget widget = mock(IsWidget.class);
        acceptsOneWidgetCaptor.getValue().setWidget(widget);

        verify(workspaceAgent).setActivePart(anyObject());
        verify(commandConsoleFactory).create(eq("machine_name"));
        verify(view).addWidget(anyString(), anyString(), anyObject(), anyObject(), anyBoolean());
        verify(view).setProcessesData(eq(presenter.rootNode));
    }


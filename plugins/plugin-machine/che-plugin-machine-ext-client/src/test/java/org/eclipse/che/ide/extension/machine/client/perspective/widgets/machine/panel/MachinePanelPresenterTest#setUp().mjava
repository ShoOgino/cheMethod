    @Before
    public void setUp() {
        when(entityFactory.createMachine(machineDtoFromAPI1)).thenReturn(machine1);
        when(entityFactory.createMachine(machineDtoFromAPI2)).thenReturn(machine2);

        MachineConfigDto machineConfig1 = mock(MachineConfigDto.class);
        MachineConfigDto machineConfig2 = mock(MachineConfigDto.class);
        when(selectedMachine1.getConfig()).thenReturn(machineConfig1);
        when(selectedMachine2.getConfig()).thenReturn(machineConfig2);

        when(entityFactory.createMachineNode(isNull(MachineTreeNode.class),
                                             anyString(),
                                             Matchers.<List<MachineTreeNode>>anyObject())).thenReturn(rootNode);

        //noinspection unchecked
        when(entityFactory.createMachineNode(eq(rootNode),
                                             eq(selectedMachine2),
                                             isNull(List.class))).thenReturn(machineNode2);
        //noinspection unchecked
        when(entityFactory.createMachineNode(eq(rootNode),
                                             eq(selectedMachine1),
                                             isNull(List.class))).thenReturn(machineNode1);

        presenter = new MachinePanelPresenter(view, service, entityFactory, locale, appliance, eventBus, resources, appContext);

        when(service.getMachines(anyString())).thenReturn(machinesPromise);
        when(machinesPromise.then(Matchers.<Operation<List<MachineDto>>>anyObject())).thenReturn(machinesPromise);

        when(service.getMachine(anyString())).thenReturn(machinePromise);
        when(machinePromise.then(Matchers.<Operation<MachineDto>>anyObject())).thenReturn(machinePromise);

        when(appContext.getWorkspace()).thenReturn(usersWorkspaceDto);
        when(usersWorkspaceDto.getId()).thenReturn(TEXT);
    }


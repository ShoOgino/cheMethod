  @Test
  public void shouldBeAbleToBuildImageWithRemoteContext() throws IOException, InterruptedException {
    AuthConfigs authConfigs = DtoFactory.newDto(AuthConfigs.class);
    AuthConfig authConfig = DtoFactory.newDto(AuthConfig.class);
    Map<String, AuthConfig> auth = new HashMap<>();
    auth.put("auth", authConfig);
    authConfigs.setConfigs(auth);

    final String imageId = "37a7da3b7edc";
    final String remote = "https://some.host.com/path/tarball.tar";

    BuildImageParams buildImageParams =
        BuildImageParams.create(remote).withAuthConfigs(authConfigs);

    doReturn(
            new ByteArrayInputStream(
                ("{\"stream\":\"Successfully built " + imageId + "\"}").getBytes()))
        .when(dockerResponse)
        .getInputStream();

    String returnedImageId = dockerConnector.buildImage(buildImageParams, progressMonitor);

    verify(dockerConnectionFactory).openConnection(nullable(URI.class));
    verify(dockerConnection).method(REQUEST_METHOD_POST);
    verify(dockerConnection).path("/build");

    verify(dockerConnection).query(eq("remote"), eq(remote));
    verify(dockerConnection, never()).header("Content-Type", "application/x-compressed-tar");
    verify(dockerConnection, never()).header(eq("Content-Length"), anyInt());
    verify(dockerConnection, never()).entity(any(InputStream.class));

    verify(dockerConnection).header(eq("X-Registry-Config"), nullable(byte[].class));
    verify(dockerConnection).request();
    verify(dockerResponse).getStatus();
    verify(dockerResponse).getInputStream();

    assertEquals(returnedImageId, imageId);
  }


    @Test
    public void shouldReTagBuiltImageWithPredictableOnInstanceCreationFromRecipe() throws Exception {
        String generatedContainerId = "genContainerId";
        doReturn(generatedContainerId).when(containerNameGenerator).generateContainerName(eq(WORKSPACE_ID),
                                                                                          eq(MACHINE_ID),
                                                                                          eq(USER_NAME),
                                                                                          eq(MACHINE_NAME));
        String repo = MACHINE_SNAPSHOT_PREFIX + "repo1";
        String tag = "tag1";
        String registry = "registry1";
        TagParams tagParams =
                TagParams.create(registry + "/" + repo + ":" + tag, "eclipse-che/" + generatedContainerId);

        createInstanceFromSnapshot(repo, tag, registry);

        verify(dockerConnector).tag(eq(tagParams));
        ArgumentCaptor<RemoveImageParams> argumentCaptor = ArgumentCaptor.forClass(RemoveImageParams.class);
        verify(dockerConnector).removeImage(argumentCaptor.capture());
        RemoveImageParams imageParams = argumentCaptor.getValue();
        assertEquals(imageParams.getImage(), registry + "/" + repo + ":" + tag);
        assertFalse(imageParams.isForce());
    }


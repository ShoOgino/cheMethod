  /**
   * Removes image from unsecured docker registry. This method removes only manifests from registry,
   * but no blobs. To free disk space it is required to use garbage collection, see <a
   * href="https://docs.docker.com/registry/garbage-collection/#how-garbage-collection-works">here</a>
   *
   * @param dockerMachineSource contains information about snapshot that should be removed
   * @throws SnapshotException when an error occurs while deleting snapshot
   */
  private void removeSnapshotFromRegistry(final DockerMachineSource dockerMachineSource)
      throws SnapshotException {
    try {
      URL url =
          UriBuilder.fromUri(
                  "http://"
                      + dockerMachineSource.getRegistry()) // TODO make possible to use https here
              .path("/v2/{repository}/manifests/{digest}")
              .build(dockerMachineSource.getRepository(), dockerMachineSource.getDigest())
              .toURL();
      final HttpURLConnection conn = (HttpURLConnection) url.openConnection();
      try {
        conn.setConnectTimeout(30 * 1000);
        conn.setRequestMethod("DELETE");
        // TODO add auth header for secured registry
        final int responseCode = conn.getResponseCode();
        if ((responseCode / 100) != 2) {
          InputStream in = conn.getErrorStream();
          if (in == null) {
            in = conn.getInputStream();
          }
          LOG.error(
              "An error occurred while deleting snapshot with url: {}\nError stream: {}",
              url,
              IoUtil.readAndCloseQuietly(in));
          throw new SnapshotException("Internal server error occurs. Can't remove snapshot");
        }
      } finally {
        conn.disconnect();
      }
    } catch (IOException e) {
      LOG.error(
          "Failed to remove {} snapshot from {}. Cause: {}",
          dockerMachineSource.getRepository(),
          dockerMachineSource.getRegistry(),
          e.getLocalizedMessage(),
          e);
    }
  }


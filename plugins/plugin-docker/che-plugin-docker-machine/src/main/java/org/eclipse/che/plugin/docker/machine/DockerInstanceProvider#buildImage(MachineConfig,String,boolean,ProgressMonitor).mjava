    protected void buildImage(MachineConfig machineConfig,
                              String machineImageName,
                              boolean doForcePullOnBuild,
                              ProgressMonitor progressMonitor)
            throws MachineException {

        Recipe recipe = recipeRetriever.getRecipe(machineConfig);
        Dockerfile dockerfile = parseRecipe(recipe);
        long memoryLimit = (long)machineConfig.getLimits().getRam() * 1024 * 1024;

        File workDir = null;
        try {
            // build docker image
            workDir = Files.createTempDirectory(null).toFile();
            final File dockerfileFile = new File(workDir, "Dockerfile");
            dockerfile.writeDockerfile(dockerfileFile);

            docker.buildImage(BuildImageParams.create(dockerfileFile)
                                              .withForceRemoveIntermediateContainers(true)
                                              .withRepository(machineImageName)
                                              .withAuthConfigs(dockerCredentials.getCredentials())
                                              .withDoForcePull(doForcePullOnBuild)
                                              .withMemoryLimit(memoryLimit)
                                              .withMemorySwapLimit(-1),
                              progressMonitor);
        } catch (IOException e) {
            throw new MachineException(e.getLocalizedMessage(), e);
        } finally {
            if (workDir != null) {
                FileCleaner.addFile(workDir);
            }
        }
    }


    @Override
    public InstanceKey saveToSnapshot(String owner) throws MachineException {
        try {
            final String repository = generateRepository();
            final String tag = "latest";
            if(!snapshotUseRegistry) {
                commitContainer(owner, repository, tag);
                return new DockerInstanceKey(repository, tag);
            }
            final String repositoryName = registry + '/' + repository;
            commitContainer(owner, repositoryName, tag);
            //TODO fix this workaround. Docker image is not visible after commit when using swarm
            Thread.sleep(2000);
            final ProgressLineFormatterImpl lineFormatter = new ProgressLineFormatterImpl();
            final String digest = docker.push(PushParams.create(repository)
                                                        .withTag(tag)
                                                        .withRegistry(registry),
                                              progressMonitor -> {
                                                  try {
                                                      outputConsumer.writeLine(lineFormatter.format(progressMonitor));
                                                  } catch (IOException ignored) {
                                                  }
                                              });
            docker.removeImage(RemoveImageParams.create(repositoryName).withForce(false));
            return new DockerInstanceKey(repository, tag, registry, digest);
        } catch (IOException ioEx) {
            throw new MachineException(ioEx);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new MachineException(e.getLocalizedMessage(), e);
        }
    }


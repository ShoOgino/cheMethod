    protected Map<String, ServerImpl> addRefAndUrlToServers(final Map<String, ServerImpl> servers, final Map<String, String> labels) {
        final Map<String, ServerConfImpl> serversConfFromLabels = getServersConfFromLabels(servers.keySet(), labels);
        for (Map.Entry<String, ServerImpl> serverEntry : servers.entrySet()) {
            ServerPropertiesImpl serverProperties = new ServerPropertiesImpl(serverEntry.getValue().getProperties());
            ServerConf serverConf = serversConf.getOrDefault(serverEntry.getKey(), serversConfFromLabels.get(serverEntry.getKey()));
            if (serverConf != null) {
                if (serverConf.getRef() != null) {
                    serverEntry.getValue().setRef(serverConf.getRef());
                }
                if (serverConf.getPath() != null) {
                    serverProperties.setPath(serverConf.getPath());
                }
                if (serverConf.getProtocol() != null) {
                    serverEntry.getValue().setProtocol(serverConf.getProtocol());

                    String externalUrl = serverConf.getProtocol() + "://" + serverEntry.getValue().getAddress();
                    if (!isNullOrEmpty(serverConf.getPath())) {
                        if (serverConf.getPath().charAt(0) != '/') {
                            externalUrl = externalUrl + '/';
                        }
                        externalUrl = externalUrl + serverConf.getPath();
                    }
                    serverEntry.getValue().setUrl(externalUrl);

                    String internalUrl = serverConf.getProtocol() + "://" + serverProperties.getInternalAddress();
                    if (serverConf.getPath() != null) {
                        if (serverConf.getPath().charAt(0) != '/') {
                            internalUrl = internalUrl + '/';
                        }
                        internalUrl = internalUrl + serverConf.getPath();
                    }
                    serverProperties.setInternalUrl(internalUrl);
                }
                serverEntry.getValue().setProperties(serverProperties);
            }
        }

        return servers;
    }


    protected SshMachineProcess start(SshMachineInstance machine, Agent agent) throws ServerException {
        Command command = new CommandImpl(agent.getId(), agent.getScript(), "agent");
        SshMachineProcess process = machine.createProcess(command, null);
        LineConsumer lineConsumer = new AbstractLineConsumer() {
            @Override
            public void writeLine(String line) throws IOException {
                machine.getLogger().writeLine(line);
            }
        };

        CountDownLatch countDownLatch = new CountDownLatch(1);
        executor.execute(ThreadLocalPropagateContext.wrap(() -> {
            try {
                countDownLatch.countDown();
                process.start(lineConsumer);
            } catch (ConflictException e) {
                try {
                    machine.getLogger().writeLine(format("[ERROR] %s", e.getMessage()));
                } catch (IOException ignored) {
                }
            } finally {
                try {
                    lineConsumer.close();
                } catch (IOException ignored) {
                }
            }
        }));
        try {
            // ensure that code inside of task submitted to executor is called before end of this method
            countDownLatch.await();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }

        return process;
    }


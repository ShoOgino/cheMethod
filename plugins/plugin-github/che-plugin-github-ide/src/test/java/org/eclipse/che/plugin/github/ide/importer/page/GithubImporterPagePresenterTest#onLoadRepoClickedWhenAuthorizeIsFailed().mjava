  @Test
  public void onLoadRepoClickedWhenAuthorizeIsFailed() throws Exception {
    String userId = "userId";
    CurrentUser user = mock(CurrentUser.class);

    when(appContext.getCurrentUser()).thenReturn(user);
    when(user.getId()).thenReturn(userId);

    final Throwable exception = mock(UnauthorizedException.class);
    doReturn(exception).when(promiseError).getCause();

    presenter.onLoadRepoClicked();

    verify(gitHubClientService).getRepositoriesList(anyString());
    verify(gitHubClientService).getUserInfo(anyString());
    verify(gitHubClientService).getOrganizations(anyString());

    verify(gitHubAuthenticator).authenticate(anyString(), asyncCallbackCaptor.capture());
    AsyncCallback<OAuthStatus> asyncCallback = asyncCallbackCaptor.getValue();
    asyncCallback.onFailure(exception);

    verify(view, times(2)).setLoaderVisibility(eq(true));
    verify(view, times(2)).setInputsEnableState(eq(false));
    verify(view, times(2)).setInputsEnableState(eq(true));
    verify(view, never()).setAccountNames(any());
    verify(view, never()).showGithubPanel();
    verify(view, never()).setRepositories(org.mockito.ArgumentMatchers.any());
  }


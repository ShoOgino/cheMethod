  /** Check that we've expected branch when url contains a branch name */
  @Test
  public void shouldReturnGitHubBranchFactory() throws Exception {

    String githubUrl = "https://github.com/eclipse/che/tree/4.2.x";
    String githubCloneUrl = "https://github.com/eclipse/che";
    String githubBranch = "4.2.x";

    FactoryDto computedFactory = newDto(FactoryDto.class).withV(CURRENT_VERSION);
    when(urlFactoryBuilder.createFactoryFromJson(anyString()))
        .thenReturn(Optional.of(computedFactory));

    githubFactoryParametersResolver.createFactory(singletonMap(URL_PARAMETER_NAME, githubUrl));

    // check we called the builder with the following factory json file
    verify(urlFactoryBuilder).createFactoryFromJson(fileLocationArgumentCaptor.capture());
    assertEquals(
        fileLocationArgumentCaptor.getValue(),
        "https://raw.githubusercontent.com/eclipse/che/4.2.x/.factory.json");

    // check we provide dockerfile and correct env
    verify(urlFactoryBuilder).buildDefaultWorkspaceConfig(eq("che"));

    // check project config built
    verify(projectConfigDtoMerger)
        .merge(any(FactoryDto.class), projectConfigDtoArgumentCaptor.capture());

    ProjectConfigDto projectConfigDto = projectConfigDtoArgumentCaptor.getValue().get();
    SourceStorageDto sourceStorageDto = projectConfigDto.getSource();
    assertNotNull(sourceStorageDto);
    assertEquals(sourceStorageDto.getType(), "github");
    assertEquals(sourceStorageDto.getLocation(), githubCloneUrl);
    Map<String, String> sourceParameters = sourceStorageDto.getParameters();
    assertEquals(sourceParameters.size(), 1);
    assertEquals(sourceParameters.get("branch"), githubBranch);
  }


    @VisibleForTesting
    void doCommit(final String message, final boolean addAll, final boolean commitAll, final boolean amend) {
        final Resource[] resources = appContext.getResources();
        checkState(resources != null);
        service.commit(appContext.getDevMachine(),
                       project.getLocation(),
                       message,
                       addAll,
                       commitAll ? new Path[]{} : toRelativePaths(resources),
                       amend)
               .then(new Operation<Revision>() {
                   @Override
                   public void apply(Revision revision) throws OperationException {
                       onCommitSuccess(revision);
                       view.close();
                   }
               })
               .catchError(new Operation<PromiseError>() {
                   @Override
                   public void apply(PromiseError error) throws OperationException {
                       handleError(error.getCause());
                       view.close();
                   }
               });
    }


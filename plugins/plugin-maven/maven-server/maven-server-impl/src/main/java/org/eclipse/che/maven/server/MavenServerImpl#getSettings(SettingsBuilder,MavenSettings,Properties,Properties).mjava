    private Settings getSettings(SettingsBuilder builder, MavenSettings settings, Properties systemProperties, Properties userProperties)
            throws RemoteException {
        SettingsBuildingRequest request = new DefaultSettingsBuildingRequest();
        request.setGlobalSettingsFile(settings.getGlobalSettings());
        request.setUserSettingsFile(settings.getUserSettings());
        request.setSystemProperties(systemProperties);
        request.setUserProperties(userProperties);

        Settings result = new Settings();
        try {
            result = builder.build(request).getEffectiveSettings();
        } catch (SettingsBuildingException e) {
            MavenServerContext.getLogger().info(e);
        }

        result.setOffline(settings.isOffline());
        if (settings.getLocalRepository() != null) {
            result.setLocalRepository(settings.getLocalRepository().getPath());
        }
        if (result.getLocalRepository() == null) {
            result.setLocalRepository(new File(System.getProperty("user.home"), ".m2/repository").getPath());
        }
        return result;
    }


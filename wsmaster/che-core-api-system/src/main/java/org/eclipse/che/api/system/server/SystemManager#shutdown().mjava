  @PreDestroy
  @VisibleForTesting
  void shutdown() throws InterruptedException {
    LOG.debug("Synchronous shutdown requested");
    if (!statusRef.compareAndSet(RUNNING, PREPARING_TO_SHUTDOWN)) {
      shutdownLatch.await();
    } else {
      doStopServices();
    }
  }


    @Override
    public synchronized void saveSnapshot(SnapshotImpl snapshot) throws SnapshotException {
        requireNonNull(snapshot, "Required non-null snapshot");
        if (snapshots.containsKey(snapshot.getWorkspaceId())) {
            throw new SnapshotException(format("Snapshot with id '%s' already exists", snapshot.getId()));
        }
        final Optional<SnapshotImpl> opt = doGetSnapshot(snapshot.getWorkspaceId(), snapshot.getEnvName(), snapshot.getMachineName());
        if (opt.isPresent()) {
            throw new SnapshotException(format("Snapshot for machine '%s:%s:%s' already exists",
                                               snapshot.getWorkspaceId(),
                                               snapshot.getEnvName(),
                                               snapshot.getMachineName()));
        }
        snapshots.put(snapshot.getId(), snapshot);
    }


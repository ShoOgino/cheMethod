  @Override
  public final void doFilter(
      ServletRequest request, ServletResponse response, FilterChain filterChain)
      throws IOException, ServletException {
    final HttpServletRequest httpRequest = (HttpServletRequest) request;
    Subject subject = new SubjectImpl("che", "che", "dummy_token", false);
    HttpSession session = httpRequest.getSession();
    session.setAttribute("codenvy_user", subject);

    final EnvironmentContext environmentContext = EnvironmentContext.getCurrent();

    try {
      environmentContext.setSubject(subject);
      Tracer tracer = OptionalTracer.fromNullable(optionalTracer);
      if (tracer != null) {
        TracingTags.USER_ID.set(tracer.activeSpan(), subject.getUserId());
      }
      TracingTags.USER_ID.set(subject.getUserId());
      filterChain.doFilter(addUserInRequest(httpRequest, subject), response);
    } finally {
      EnvironmentContext.reset();
    }
  }


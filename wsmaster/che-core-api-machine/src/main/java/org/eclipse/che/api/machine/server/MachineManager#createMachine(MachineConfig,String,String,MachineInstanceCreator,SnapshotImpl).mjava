    private MachineImpl createMachine(MachineConfig machineConfig,
                                      String workspaceId,
                                      String environmentName,
                                      MachineInstanceCreator instanceCreator,
                                      SnapshotImpl snapshot)
            throws NotFoundException,
                   SnapshotException,
                   ConflictException,
                   BadRequestException,
                   MachineException {
        final InstanceProvider instanceProvider = machineInstanceProviders.getProvider(machineConfig.getType());
        final String sourceType = machineConfig.getSource().getType();

        Recipe recipe;
        InstanceKey instanceKey = null;
        if (snapshot != null) {
            instanceKey = snapshot.getInstanceKey();
        }
        if ("Recipe".equalsIgnoreCase(sourceType)) {
            // TODO should we check that it is dockerfile?
            recipe = getRecipeByLocation(machineConfig);
        } else {
            throw new BadRequestException("Source type is unsupported " + sourceType);
        }

        if (!MACHINE_DISPLAY_NAME_PATTERN.matcher(machineConfig.getName()).matches()) {
            throw new BadRequestException("Invalid machine name " + machineConfig.getName());
        }

        for (MachineImpl machine : machineRegistry.getMachines()) {
            if (machine.getWorkspaceId().equals(workspaceId) && machine.getConfig().getName().equals(machineConfig.getName())) {
                throw new ConflictException("Machine with name " + machineConfig.getName() + " already exists");
            }
        }

        final String machineId = generateMachineId();
        final String creator = EnvironmentContext.getCurrent().getUser().getId();

        if (machineConfig.getLimits().getRam() == 0) {
            MachineConfigImpl machineConfigWithLimits = new MachineConfigImpl(machineConfig);
            machineConfigWithLimits.setLimits(new LimitsImpl(defaultMachineMemorySizeMB));
            machineConfig = machineConfigWithLimits;
        }

        final MachineImpl machine = new MachineImpl(machineConfig,
                                                    machineId,
                                                    workspaceId,
                                                    environmentName,
                                                    creator,
                                                    MachineStatus.CREATING,
                                                    null);

        createMachineLogsDir(machineId);
        final LineConsumer machineLogger = getMachineLogger(machineId, getMachineChannels(machine.getConfig().getName(),
                                                                                          machine.getWorkspaceId(),
                                                                                          machine.getEnvName())
                .getOutput());

        try {
            machineRegistry.addMachine(machine);

            instanceCreator.createInstance(instanceProvider, recipe, instanceKey, machine, machineLogger);

            return machine;
        } catch (ConflictException e) {
            throw new MachineException(e.getLocalizedMessage(), e);
        }
    }


    private void createInstance(InstanceProvider instanceProvider,
                                Machine machine,
                                LineConsumer machineLogger) throws MachineException {
        Instance instance = null;
        try {
            eventService.publish(DtoFactory.newDto(MachineStatusEvent.class)
                                           .withEventType(MachineStatusEvent.EventType.CREATING)
                                           .withMachineId(machine.getId())
                                           .withDev(machine.getConfig().isDev())
                                           .withWorkspaceId(machine.getWorkspaceId())
                                           .withMachineName(machine.getConfig().getName()));

            instance = instanceProvider.createInstance(machine, machineLogger);

            instance.setStatus(MachineStatus.RUNNING);

            machineRegistry.update(instance);

            if (machine.getConfig().isDev()) {
                wsAgentLauncher.startWsAgent(machine.getWorkspaceId());
            }

            eventService.publish(DtoFactory.newDto(MachineStatusEvent.class)
                                           .withEventType(MachineStatusEvent.EventType.RUNNING)
                                           .withDev(machine.getConfig().isDev())
                                           .withMachineId(machine.getId())
                                           .withWorkspaceId(machine.getWorkspaceId())
                                           .withMachineName(machine.getConfig().getName()));

        } catch (Exception creationEx) {
            try {
                machineRegistry.remove(machine.getId());
            } catch (NotFoundException ignore) {
            }
            eventService.publish(DtoFactory.newDto(MachineStatusEvent.class)
                                           .withEventType(MachineStatusEvent.EventType.ERROR)
                                           .withMachineId(machine.getId())
                                           .withDev(machine.getConfig().isDev())
                                           .withWorkspaceId(machine.getWorkspaceId())
                                           .withMachineName(machine.getConfig().getName())
                                           .withError(creationEx.getLocalizedMessage()));
            try {
                machineLogger.writeLine(String.format("[ERROR] %s", creationEx.getLocalizedMessage()));
            } catch (IOException ioEx) {
                LOG.error(ioEx.getLocalizedMessage());
            }

            try {
                if (instance != null) {
                    instance.destroy();
                }
            } catch (MachineException destroyingEx) {
                LOG.error(destroyingEx.getLocalizedMessage(), destroyingEx);
            }
            throw new MachineException(creationEx.getLocalizedMessage(), creationEx);
        }
    }


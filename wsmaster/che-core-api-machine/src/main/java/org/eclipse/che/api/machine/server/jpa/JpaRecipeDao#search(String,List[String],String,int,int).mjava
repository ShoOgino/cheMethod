  @Override
  @Transactional
  public List<RecipeImpl> search(
      String user, List<String> tags, String type, int skipCount, int maxItems)
      throws ServerException {
    try {
      final EntityManager manager = managerProvider.get();
      final CriteriaBuilder cb = manager.getCriteriaBuilder();
      final CriteriaQuery<RecipeImpl> query = cb.createQuery(RecipeImpl.class);
      final Root<RecipeImpl> fromRecipe = query.from(RecipeImpl.class);
      final ParameterExpression<String> typeParam = cb.parameter(String.class, "recipeType");
      final Predicate checkType =
          cb.or(cb.isNull(typeParam), cb.equal(fromRecipe.get("type"), typeParam));
      final TypedQuery<RecipeImpl> typedQuery;
      if (tags != null && !tags.isEmpty()) {
        final Join<RecipeImpl, String> tag = fromRecipe.join("tags");
        query
            .select(cb.construct(RecipeImpl.class, tag.getParent()))
            .where(cb.and(checkType, tag.in(tags)))
            .groupBy(fromRecipe.get("id"))
            .having(cb.equal(cb.count(tag), tags.size()));
        typedQuery = manager.createQuery(query).setParameter("tags", tags);
      } else {
        typedQuery = manager.createQuery(query.where(checkType));
      }
      return typedQuery
          .setParameter("recipeType", type)
          .setFirstResult(skipCount)
          .setMaxResults(maxItems)
          .getResultList();
    } catch (RuntimeException ex) {
      throw new ServerException(ex.getLocalizedMessage(), ex);
    }
  }


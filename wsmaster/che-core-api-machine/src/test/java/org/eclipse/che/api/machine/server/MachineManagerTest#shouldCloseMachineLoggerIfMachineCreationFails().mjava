    @Test(expectedExceptions = MachineException.class)
    public void shouldCloseMachineLoggerIfMachineCreationFails() throws Exception {
        //given
        MachineConfig machineConfig = mock(MachineConfig.class);
        MachineSource machineSource = mock(MachineSource.class);
        LineConsumer machineLogger = mock(LineConsumer.class);
        doReturn(machineLogger).when(manager).getMachineLogger(eq(MACHINE_ID), any(LineConsumer.class));
        when(machineConfig.getSource()).thenReturn(machineSource);
        when(machineConfig.getName()).thenReturn("Name");
        when(machineSource.getType()).thenReturn("dockerfile");
        doThrow(ConflictException.class).when(machineRegistry).addMachine(any());

        //when
        manager.createMachineSync(machineConfig, "workspaceId", "environmentName", logConsumer);

        //then
        verify(machineLogger).close();
    }


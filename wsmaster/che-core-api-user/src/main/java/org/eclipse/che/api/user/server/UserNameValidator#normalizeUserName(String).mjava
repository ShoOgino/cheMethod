    /**
     * Remove illegal characters from username, to make it URL-friendly.
     * If all characters are illegal, return automatically generated username.
     * Also ensures username is unique, if not, adds digits to it's end.
     *
     * @param name
     *        username
     * @return username without illegal characters
     */
    public String normalizeUserName(String name) throws ServerException {
        String normalized = ILLEGAL_USERNAME_CHARACTERS.matcher(name).replaceAll("");
        String candidate = normalized.isEmpty() ? NameGenerator.generate("username", 4) : normalized;

        int i = 1;
        try {
            while (userExists(candidate)) {
                candidate = normalized.isEmpty() ? NameGenerator.generate("username", 4) : normalized + String.valueOf(i++);
            }
        } catch (ServerException e) {
            LOG.warn("Error occured during username normalization", e);
            throw e;
        }
        return candidate;
    }


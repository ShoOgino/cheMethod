    /**
     * Creates new user and profile.
     * <p/>
     * When current user is in 'system/admin' role then {@code userDescriptor} parameter
     * will be used for user creation, otherwise method uses {@code token} and {@link #tokenValidator}.
     *
     * @param token
     *         authentication token
     * @param isTemporary
     *         if it is {@code true} creates temporary user
     * @return entity of created user
     * @throws ForbiddenException
     *         when the user is not the system admin, or self creation is disabled
     * @throws BadRequestException
     *         when {@code userDescriptor} is invalid
     * @throws UnauthorizedException
     *         when token is null
     * @throws ConflictException
     *         when token is not valid
     * @throws ServerException
     *         when some error occurred while persisting user or user profile
     * @see UserDescriptor
     * @see #getCurrent()
     * @see #updatePassword(String)
     * @see #getById(String)
     * @see #getByAlias(String)
     * @see #remove(String)
     */
    @POST
    @Path("/create")
    @Consumes(APPLICATION_JSON)
    @Produces(APPLICATION_JSON)
    @GenerateLink(rel = LINK_REL_CREATE_USER)
    @ApiOperation(value = "Create a new user",
                  notes = "Create a new user in the system. There are two ways to create a user: " +
                          "through a regular registration workflow and by system/admin. In the former case, " +
                          "auth token is sent to user's mailbox, while system/admin can create a user directly " +
                          "with predefined name and password",
                  response = UserDescriptor.class)
    @ApiResponses({@ApiResponse(code = 201, message = "Created"),
                   @ApiResponse(code = 400, message = "Missed required parameters, parameters are not valid"),
                   @ApiResponse(code = 401, message = "Missed token parameter"),
                   @ApiResponse(code = 403, message = "Invalid or missing request parameters"),
                   @ApiResponse(code = 409, message = "Invalid token"),
                   @ApiResponse(code = 500, message = "Internal Server Error")})
    public Response create(@ApiParam(value = "New user")
                           UserDescriptor userDescriptor,
                           @ApiParam(value = "Authentication token")
                           @QueryParam("token")
                           String token,
                           @ApiParam(value = "User type")
                           @QueryParam("temporary")
                           @DefaultValue("false")
                           Boolean isTemporary,
                           @Context
                           SecurityContext context) throws ForbiddenException,
                                                           BadRequestException,
                                                           UnauthorizedException,
                                                           ConflictException,
                                                           ServerException,
                                                           NotFoundException {
        if (!context.isUserInRole("system/admin") && !userSelfCreationAllowed) {
            throw new ForbiddenException("Currently only admins can create accounts. Please contact our Admin Team for further info.");
        }

        final User user = context.isUserInRole("system/admin") ? fromEntity(userDescriptor) : fromToken(token);
        userManager.create(user, isTemporary);
        return status(CREATED).entity(injectLinks(toDescriptor(user), getServiceContext())).build();
    }


    @BeforeMethod
    public void setUp() throws Exception {
        ResourceBinderImpl resources = new ResourceBinderImpl();
        DependencySupplierImpl dependencies = new DependencySupplierImpl();
        dependencies.addComponent(UserManager.class, userManager);
        dependencies.addComponent(TokenValidator.class, tokenValidator);

        userService = new UserService(userManager, tokenValidator, userNameValidator, true);
        final Field uriField = userService.getClass()
                                          .getSuperclass()
                                          .getDeclaredField("uriInfo");
        uriField.setAccessible(true);
        uriField.set(userService, uriInfo);

        resources.addResource(userService, null);

        EverrestProcessor processor = new EverrestProcessor(resources,
                                                            new ApplicationProviderBinder(),
                                                            dependencies,
                                                            new EverrestConfiguration(),
                                                            null);
        launcher = new ResourceLauncher(processor);
        ProviderBinder providerBinder = ProviderBinder.getInstance();
        providerBinder.addExceptionMapper(ApiExceptionMapper.class);
        ApplicationContextImpl.setCurrent(new ApplicationContextImpl(null, null, providerBinder));
        //set up user
        final User user = createUser();

        when(uriInfo.getBaseUriBuilder()).thenReturn(new UriBuilderImpl());

        org.eclipse.che.commons.env.EnvironmentContext.getCurrent().setSubject(new Subject() {

            @Override
            public String getUserName() {
                return user.getEmail();
            }

            @Override
            public boolean hasPermission(String domain, String instance, String action) {
                return false;
            }

            @Override
            public void checkPermission(String domain, String instance, String action) throws ForbiddenException {
            }

            @Override
            public String getToken() {
                return null;
            }

            @Override
            public String getUserId() {
                return user.getId();
            }

            @Override
            public boolean isTemporary() {
                return false;
            }
        });
    }


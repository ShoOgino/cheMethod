  private String getValidatedEnvironmentName(WorkspaceImpl workspace, @Nullable String envName)
      throws NotFoundException, ServerException {
    if (envName != null && !workspace.getConfig().getEnvironments().containsKey(envName)) {
      throw new NotFoundException(
          format(
              "Workspace '%s:%s' doesn't contain environment '%s'",
              workspace.getNamespace(), workspace.getConfig().getName(), envName));
    }

    envName = firstNonNull(envName, workspace.getConfig().getDefaultEnv());

    if (envName == null
        && SidecarToolingWorkspaceUtil.isSidecarBasedWorkspace(
            workspace.getConfig().getAttributes())) {
      // Sidecar-based workspaces are allowed not to have any environments
      return null;
    }

    // validate environment in advance
    if (envName == null) {
      throw new NotFoundException(
          format(
              "Workspace %s:%s can't use null environment",
              workspace.getNamespace(), workspace.getConfig().getName()));
    }
    try {
      runtimes.validate(workspace.getConfig().getEnvironments().get(envName));
    } catch (InfrastructureException | ValidationException e) {
      throw new ServerException(e);
    }

    return envName;
  }


    private void initializeEnvironment(String workspaceId,
                                       String envName,
                                       Environment env,
                                       String networkId,
                                       MessageConsumer<MachineLogMessage> messageConsumer)
            throws ServerException,
                   ConflictException {

        ComposeEnvironmentImpl composeEnvironment = environmentParser.parse(env);

        applyAgents(env, composeEnvironment);

        normalize(composeEnvironment);

        List<String> servicesOrder = startStrategy.order(composeEnvironment);

        EnvironmentHolder environmentHolder = new EnvironmentHolder(servicesOrder,
                                                                    composeEnvironment,
                                                                    messageConsumer,
                                                                    EnvStatus.STARTING,
                                                                    envName,
                                                                    networkId);

        try (StripedLocks.WriteLock lock = stripedLocks.acquireWriteLock(workspaceId)) {
            if (environments.putIfAbsent(workspaceId, environmentHolder) != null) {
                throw new ConflictException(format("Environment of workspace '%s' already exists", workspaceId));
            }
        }
    }


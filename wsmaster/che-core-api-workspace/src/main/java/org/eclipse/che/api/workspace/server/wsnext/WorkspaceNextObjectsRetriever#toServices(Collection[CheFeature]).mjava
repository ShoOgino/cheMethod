  private Collection<CheService> toServices(Collection<CheFeature> features)
      throws InfrastructureException {
    Collection<CheService> services = getServices(features);
    Map<String, List<String>> parameters = getServicesParameters(features);

    for (CheService service : services) {
      String serviceName = service.getMetadata().getName();
      String serviceVersion = service.getSpec().getVersion();
      String serviceKey = serviceName + '/' + serviceVersion;

      // for now we match whole env variable value against '${<parameter name>}'
      service
          .getSpec()
          .getContainers()
          .stream()
          .flatMap(container -> container.getEnv().stream())
          .filter(this::isParameter)
          .forEach(
              envVar -> {
                String parameterKey = serviceKey + '/' + envVar.getValue();
                List<String> remove = parameters.remove(parameterKey);
                String envVarValue;
                if (remove != null) {
                  envVarValue = String.join(",", remove);
                } else {
                  envVarValue = "";
                }
                envVar.setValue(envVarValue);
              });
    }

    if (!parameters.isEmpty()) {
      throw new InfrastructureException(
          "Parameters not supported by services found: " + parameters.keySet());
    }

    return services;
  }


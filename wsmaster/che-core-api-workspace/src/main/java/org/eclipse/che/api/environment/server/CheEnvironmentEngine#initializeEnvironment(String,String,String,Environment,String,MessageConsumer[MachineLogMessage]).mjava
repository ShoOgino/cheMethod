    private void initializeEnvironment(String namespace,
                                       String workspaceId,
                                       String envName,
                                       Environment envConfig,
                                       String networkId,
                                       MessageConsumer<MachineLogMessage> messageConsumer)
            throws ServerException,
                   ConflictException,
                   EnvironmentException {

        CheServicesEnvironmentImpl internalEnv = environmentParser.parse(envConfig);

        internalEnv.setWorkspaceId(workspaceId);

        infrastructureProvisioner.provision(envConfig, internalEnv);

        normalize(namespace,
                  workspaceId,
                  internalEnv);

        List<String> servicesOrder = startStrategy.order(internalEnv);

        normalizeNames(internalEnv);

        EnvironmentHolder environmentHolder = new EnvironmentHolder(servicesOrder,
                                                                    internalEnv,
                                                                    messageConsumer,
                                                                    EnvStatus.STARTING,
                                                                    envName,
                                                                    networkId);

        try (@SuppressWarnings("unused") CloseableLock lock = stripedLocks.acquireWriteLock(workspaceId)) {
            if (environments.putIfAbsent(workspaceId, environmentHolder) != null) {
                throw new ConflictException(format("Environment of workspace '%s' already exists", workspaceId));
            }
        }
    }


    /**
     * Adapts given workspace configuration environments to a new format,
     * if it contains environments array, otherwise does nothing.
     *
     * @throws IllegalArgumentException
     *         if the old format is bad, and can't be converted to a new one
     */
    public void adaptModifying(JsonObject conf) {
        if (conf.has("environments") && conf.get("environments").isJsonArray()) {
            final JsonObject newEnvironments = new JsonObject();
            for (JsonElement environmentEl : conf.get("environments").getAsJsonArray()) {
                if (!environmentEl.isJsonObject()) {
                    throw new IllegalArgumentException("Bad format, expected environment to be json object");
                }
                final JsonObject env = environmentEl.getAsJsonObject();
                if (!env.has("name") || env.get("name").isJsonNull()) {
                    throw new IllegalArgumentException("Bad format, expected environment to provide a name");
                }
                final String envName = env.get("name").getAsString();
                newEnvironments.add(envName, asEnvironment(env, envName));
            }
            conf.add("environments", newEnvironments);
        }
    }


    private String replaceSnapshot(MachineImpl machine, String namespace) {
        try {
            try {
                SnapshotImpl oldSnapshot = snapshotDao.getSnapshot(machine.getWorkspaceId(),
                                                                   machine.getEnvName(),
                                                                   machine.getConfig().getName());
                snapshotDao.removeSnapshot(oldSnapshot.getId());

                runtimes.removeSnapshot(oldSnapshot);
            } catch (NotFoundException ignored) {
                // Do nothing if no snapshot found
            }

            SnapshotImpl snapshot = null;
            try {
                snapshot = runtimes.saveMachine(namespace,
                                                machine.getWorkspaceId(),
                                                machine.getId());

                snapshotDao.saveSnapshot(snapshot);
            } catch (ApiException e) {
                if (snapshot != null) {
                    try {
                        runtimes.removeSnapshot(snapshot);
                    } catch (ApiException e1) {
                        LOG.error(format("Snapshot removal failed. Snapshot: %s. Error: %s",
                                         snapshot,
                                         e1.getLocalizedMessage()),
                                  e1);
                    }
                }
                throw e;
            }

            return null;
        } catch (ApiException apiEx) {
            LOG.error("Snapshot creation failed. Error: " + apiEx.getLocalizedMessage(), apiEx);
            return apiEx.getLocalizedMessage();
        }
    }


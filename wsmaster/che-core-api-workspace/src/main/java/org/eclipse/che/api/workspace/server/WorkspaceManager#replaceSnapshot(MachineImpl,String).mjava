    private String replaceSnapshot(MachineImpl machine, String namespace) {
        try {
            try {
                SnapshotImpl oldSnapshot = snapshotDao.getSnapshot(machine.getWorkspaceId(),
                                                                   machine.getEnvName(),
                                                                   machine.getConfig().getName());
                snapshotDao.removeSnapshot(oldSnapshot.getId());

                runtimes.removeSnapshot(oldSnapshot);
            } catch (NotFoundException ignored) {
                // Do nothing if no snapshot found
            }

            SnapshotImpl snapshot = null;
            try {
                snapshot = runtimes.saveMachine(namespace,
                                                machine.getWorkspaceId(),
                                                machine.getId());
                // check if the workspace exists before creating a snapshot,
                // if it is not an integrity constraint violation exception will occur,
                // this may happen when workspace stop called simultaneously.
                // The issue https://github.com/eclipse/che/issues/2683 should fix it
                // in a way that it won't be possible to snapshot workspace simultaneously.
                if (exists(machine.getWorkspaceId())) {
                    snapshotDao.saveSnapshot(snapshot);
                } else {
                    LOG.warn("Snapshot for a workspace '{}' won't be saved, as the workspace doesn't exist anymore",
                             machine.getWorkspaceId());
                    runtimes.removeSnapshot(snapshot);
                }
            } catch (ApiException e) {
                if (snapshot != null) {
                    try {
                        runtimes.removeSnapshot(snapshot);
                    } catch (ApiException e1) {
                        LOG.error(format("Snapshot removal failed. Snapshot: %s. Error: %s",
                                         snapshot,
                                         e1.getLocalizedMessage()),
                                  e1);
                    }
                }
                throw e;
            }

            return null;
        } catch (ApiException apiEx) {
            LOG.error("Snapshot creation failed. Error: " + apiEx.getLocalizedMessage(), apiEx);
            return apiEx.getLocalizedMessage();
        }
    }


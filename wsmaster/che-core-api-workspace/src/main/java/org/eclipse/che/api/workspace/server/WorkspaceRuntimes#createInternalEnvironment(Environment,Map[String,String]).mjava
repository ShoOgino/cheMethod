  private InternalEnvironment createInternalEnvironment(
      Environment environment, Map<String, String> workspaceConfigAttributes)
      throws InfrastructureException, ValidationException, NotFoundException {
    String recipeType = environment.getRecipe().getType();
    InternalEnvironmentFactory factory = environmentFactories.get(recipeType);
    if (factory == null) {
      throw new NotFoundException(
          format("InternalEnvironmentFactory is not configured for recipe type: '%s'", recipeType));
    }
    InternalEnvironment internalEnvironment = factory.create(environment);

    applyWorkspaceNext(internalEnvironment, workspaceConfigAttributes, recipeType);

    return internalEnvironment;
  }


  @Override
  public void onEvent(WorkspaceStatusEvent event) {

    String workspaceId = event.getWorkspaceId();
    if (WorkspaceStatusEvent.EventType.STOPPED.equals(event.getEventType())) {
      while (userIdToWorkspaces.values().remove(workspaceId)) {}
      workspaceOwners.remove(workspaceId);
    }

    if (WorkspaceStatusEvent.EventType.STARTING.equals(event.getEventType())) {
      Subject subject = EnvironmentContext.getCurrent().getSubject();
      if (subject == Subject.ANONYMOUS) {
        throw new IllegalStateException(
            "Workspace "
                + workspaceId
                + " is being started by the 'Anonymous' user.\n"
                + "This shouldn't happen, and workspaces should always be created by a real user.");
      }
      userIdToWorkspaces.put(subject.getUserId(), workspaceId);
      updateSubject(subject);
    }
  }


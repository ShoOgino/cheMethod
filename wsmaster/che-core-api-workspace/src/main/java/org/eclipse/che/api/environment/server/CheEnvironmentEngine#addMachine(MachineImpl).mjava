    private void addMachine(MachineImpl machine) throws ServerException {
        Instance instance = new NoOpMachineInstance(machine);
        try (CloseableLock lock = stripedLocks.acquireWriteLock(machine.getWorkspaceId())) {
            ensurePreDestroyIsNotExecuted();
            EnvironmentHolder environmentHolder = environments.get(machine.getWorkspaceId());
            if (environmentHolder != null && environmentHolder.status != EnvStatus.STOPPING) {
                environmentHolder.machines.add(instance);
            } else {
                throw new ServerException(
                        format("Can't add machine into environment. Environment of workspace '%s' is missing",
                               machine.getWorkspaceId()));
            }
        }
    }


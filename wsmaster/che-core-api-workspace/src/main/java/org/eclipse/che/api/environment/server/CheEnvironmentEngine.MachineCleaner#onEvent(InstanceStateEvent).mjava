        @Override
        public void onEvent(InstanceStateEvent event) {
            if ((event.getType() == OOM) || (event.getType() == DIE)) {
                EnvironmentHolder environmentHolder;
                try (CloseableLock lock = stripedLocks.acquireReadLock("workspaceId")) {
                    environmentHolder = environments.get(event.getWorkspaceId());
                }
                if (environmentHolder != null) {
                    for (Instance instance : environmentHolder.machines) {
                        if (instance.getId().equals(event.getMachineId())) {
                            String message = "Machine is destroyed. ";
                            if (event.getType() == OOM) {
                                message = message +
                                          "The processes in this machine need more RAM. This machine started with " +
                                          instance.getConfig().getLimits().getRam() +
                                          "MB. Create a new machine configuration that allocates additional RAM or increase " +
                                          "the workspace RAM limit in the user dashboard.";
                            }

                            try {
                                if (!Strings.isNullOrEmpty(message)) {
                                    instance.getLogger().writeLine(message);
                                }
                            } catch (IOException ignore) {
                            }

                            eventService.publish(newDto(MachineStatusEvent.class)
                                                         .withEventType(MachineStatusEvent.EventType.DESTROYED)
                                                         .withDev(instance.getConfig().isDev())
                                                         .withMachineId(instance.getId())
                                                         .withWorkspaceId(instance.getWorkspaceId())
                                                         .withMachineName(instance.getConfig().getName()));
                        }
                    }
                }
            }
        }


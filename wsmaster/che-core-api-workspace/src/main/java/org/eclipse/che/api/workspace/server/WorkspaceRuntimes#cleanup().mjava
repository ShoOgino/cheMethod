    /**
     * Removes all workspaces from the in-memory storage, while
     * {@link CheEnvironmentEngine} is responsible for environment destroying.
     */
    @PreDestroy
    @VisibleForTesting
    void cleanup() {
        isPreDestroyInvoked = true;

        final ExecutorService stopEnvExecutor =
                Executors.newFixedThreadPool(2 * Runtime.getRuntime().availableProcessors(),
                                             new ThreadFactoryBuilder().setNameFormat("StopEnvironment-%d")
                                                                       .setDaemon(false)
                                                                       .build());
        try (StripedLocks.WriteAllLock lock = stripedLocks.acquireWriteAllLock()) {
            for (Map.Entry<String, WorkspaceState> workspace : workspaces.entrySet()) {
                if (workspace.getValue().status.equals(WorkspaceStatus.RUNNING) ||
                    workspace.getValue().status.equals(WorkspaceStatus.STARTING)) {
                    stopEnvExecutor.execute(() -> {
                        try {
                            environmentEngine.stop(workspace.getKey());
                        } catch (ServerException | NotFoundException e) {
                            LOG.error(e.getLocalizedMessage(), e);
                        }
                    });
                }
            }

            workspaces.clear();

            stopEnvExecutor.shutdown();
        }
        try {
            if (!stopEnvExecutor.awaitTermination(50, TimeUnit.SECONDS)) {
                stopEnvExecutor.shutdownNow();
                if (!stopEnvExecutor.awaitTermination(10, TimeUnit.SECONDS)) {
                    LOG.warn("Unable terminate destroy machines pool");
                }
            }
        } catch (InterruptedException e) {
            stopEnvExecutor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }


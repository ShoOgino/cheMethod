  private TestInternalRuntime mockRuntime(WorkspaceImpl workspace, WorkspaceStatus status)
      throws Exception {
    RuntimeIdentity identity =
        new RuntimeIdentityImpl(workspace.getId(), workspace.getConfig().getDefaultEnv(), "id");
    //        doAnswer(inv -> {
    //            final WorkspaceImpl ws = (WorkspaceImpl)inv.getArguments()[0];
    //            ws.setStatus(status);
    //            return ws;
    //        }).when(runtimes).injectStatus(workspace);
    MachineImpl machine1 = spy(createMachine());
    MachineImpl machine2 = spy(createMachine());
    Map<String, Machine> machines = new HashMap<>();
    machines.put("machine1", machine1);
    machines.put("machine2", machine2);
    TestInternalRuntime runtime = new TestInternalRuntime(mockContext(identity), machines);
    doAnswer(
            inv -> {
              workspace.setStatus(status);
              workspace.setRuntime(runtime);
              return null;
            })
        .when(runtimes)
        .injectRuntime(workspace);
    when(runtimes.isAnyRunning()).thenReturn(true);
    return runtime;
  }


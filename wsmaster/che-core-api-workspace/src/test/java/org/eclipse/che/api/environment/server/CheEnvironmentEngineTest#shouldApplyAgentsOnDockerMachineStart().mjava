    @Test
    public void shouldApplyAgentsOnDockerMachineStart() throws Exception {
        // given
        List<Instance> instances = startEnv();
        String workspaceId = instances.get(0).getWorkspaceId();

        when(engine.generateMachineId()).thenReturn("newMachineId");
        Instance newMachine = mock(Instance.class);
        when(newMachine.getId()).thenReturn("newMachineId");
        when(newMachine.getWorkspaceId()).thenReturn(workspaceId);
        when(composeProvider.startService(anyString(),
                                          anyString(),
                                          anyString(),
                                          anyString(),
                                          anyString(),
                                          anyBoolean(),
                                          anyString(),
                                          any(ComposeServiceImpl.class),
                                          any(LineConsumer.class)))
                .thenReturn(newMachine);

        MachineConfigImpl config = createConfig(false);
        List<String> agents = asList("agent1", "agent2");

        // when
        engine.startMachine(workspaceId, config, agents);

        // then
        verify(agentConfigApplier).modify(any(ComposeServiceImpl.class), eq(agents));
    }


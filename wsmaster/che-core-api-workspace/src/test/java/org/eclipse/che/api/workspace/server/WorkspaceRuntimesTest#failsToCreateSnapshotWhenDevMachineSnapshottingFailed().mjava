  @Test(expectedExceptions = ServerException.class, expectedExceptionsMessageRegExp = "can't save")
  public void failsToCreateSnapshotWhenDevMachineSnapshottingFailed() throws Exception {
    WorkspaceImpl workspace = newWorkspace("workspace", "env-name");
    setRuntime(workspace.getId(), WorkspaceStatus.RUNNING);
    prepareMachines(workspace.getId(), "env-name");
    when(envEngine.saveSnapshot(any(), any())).thenThrow(new ServerException("can't save"));

    try {
      runtimes.snapshot(workspace.getId());
    } catch (Exception x) {
      verifyEventsSequence(
          event(
              workspace.getId(),
              WorkspaceStatus.RUNNING,
              WorkspaceStatus.SNAPSHOTTING,
              EventType.SNAPSHOT_CREATING,
              null),
          event(
              workspace.getId(),
              WorkspaceStatus.SNAPSHOTTING,
              WorkspaceStatus.RUNNING,
              EventType.SNAPSHOT_CREATION_ERROR,
              "can't save"));
      throw x;
    }
  }


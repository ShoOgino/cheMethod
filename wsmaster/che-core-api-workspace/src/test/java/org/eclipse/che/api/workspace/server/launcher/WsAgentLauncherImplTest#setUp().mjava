    @BeforeMethod
    public void setUp() throws Exception {
        wsAgentLauncher = new WsAgentLauncherImpl(() -> machineProcessManager,
                                                  requestFactory, null,
                                                  WS_AGENT_MAX_START_TIME_MS,
                                                  WS_AGENT_PING_DELAY_MS,
                                                  WS_AGENT_PING_CONN_TIMEOUT_MS,
                                                  WS_AGENT_TIMED_OUT_MESSAGE
        );
        pingRequest = Mockito.mock(HttpJsonRequest.class, new SelfReturningAnswer());
        when(agent.getScript()).thenReturn("script");
        when(machine.getId()).thenReturn(MACHINE_ID);
        when(machine.getWorkspaceId()).thenReturn(WORKSPACE_ID);
        when(machine.getRuntime()).thenReturn(machineRuntime);
        doReturn(Collections.<String, Server>singletonMap(WS_AGENT_PORT, SERVER)).when(machineRuntime).getServers();
        when(requestFactory.fromUrl(anyString())).thenReturn(pingRequest);
        when(pingRequest.request()).thenReturn(pingResponse);
        when(pingResponse.getResponseCode()).thenReturn(HttpURLConnection.HTTP_OK);
    }


    @Test
    public void errorEventShouldBePublishedIfDevMachineFailedToStart() throws Exception {
        final WorkspaceImpl workspace = createWorkspace();
        runtimes = spy(new WorkspaceRuntimes(machineManager, eventService));
        doNothing().when(runtimes).publishEvent(any(), any(), any());
        doNothing().when(runtimes).cleanupStartResources(any());

        doAnswer(invocation -> {
            final MachineConfig cfg = (MachineConfig)invocation.getArguments()[0];
            if (cfg.isDev()) {
                throw new MachineException("Start error");
            }
            return createMachine(cfg);
        }).when(machineManager).createMachineSync(any(), any(), any(), any(LineConsumer.class));

        try {
            runtimes.start(workspace, workspace.getConfig().getDefaultEnv());
        } catch (MachineException ex) {
            verify(runtimes).publishEvent(EventType.ERROR, workspace.getId(), ex.getLocalizedMessage());
        }
    }


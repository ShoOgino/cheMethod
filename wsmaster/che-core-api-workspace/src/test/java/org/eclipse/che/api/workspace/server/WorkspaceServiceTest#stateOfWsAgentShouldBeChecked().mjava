  @Test
  public void stateOfWsAgentShouldBeChecked() throws Exception {
    final WorkspaceImpl workspace = createWorkspace(createConfigDto());
    workspace.setStatus(RUNNING);

    WsAgentHealthStateDto wsAgentState = newDto(WsAgentHealthStateDto.class);
    WorkspaceRuntimeImpl runtime = mock(WorkspaceRuntimeImpl.class);
    MachineImpl machine = mock(MachineImpl.class);
    when(runtime.getDevMachine()).thenReturn(machine);
    when(wsAgentHealthChecker.check(machine)).thenReturn(wsAgentState);

    workspace.setRuntime(runtime);

    when(wsManager.getWorkspace(workspace.getId())).thenReturn(workspace);

    final Response response =
        given()
            .auth()
            .basic(ADMIN_USER_NAME, ADMIN_USER_PASSWORD)
            .when()
            .get(SECURE_PATH + "/workspace/" + workspace.getId() + "/check");

    verify(wsAgentHealthChecker).check(machine);
    assertEquals(RUNNING, wsAgentState.getWorkspaceStatus());
    assertEquals(200, response.getStatusCode());
  }


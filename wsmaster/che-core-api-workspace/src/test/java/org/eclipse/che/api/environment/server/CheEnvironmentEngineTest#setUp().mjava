    @BeforeMethod
    public void setUp() throws Exception {
        engine = spy(new CheEnvironmentEngine(snapshotDao,
                                              machineInstanceProviders,
                                              System.getProperty("java.io.tmpdir"),
                                              DEFAULT_MACHINE_MEM_LIMIT_MB,
                                              eventService,
                                              environmentParser,
                                              new DefaultServicesStartStrategy(),
                                              machineProvider,
                                              infrastructureProvisioner,
                                              API_ENDPOINT,
                                              recipeDownloader,
                                              containerNameGenerator,
                                              agentRegistry,
                                              sharedPool));

        when(machineInstanceProviders.getProvider("docker")).thenReturn(instanceProvider);
        when(instanceProvider.getRecipeTypes()).thenReturn(Collections.singleton("dockerfile"));
        when(agentRegistry.getAgent(any(AgentKey.class))).thenReturn(agent);

        EnvironmentContext.getCurrent().setSubject(new SubjectImpl("name", "id", "token", false));
    }


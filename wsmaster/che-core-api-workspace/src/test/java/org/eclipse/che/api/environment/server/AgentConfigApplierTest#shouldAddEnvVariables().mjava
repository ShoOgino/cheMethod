  @Test
  public void shouldAddEnvVariables() throws Exception {
    when(sorter.sort(any()))
        .thenReturn(asList(AgentKeyImpl.parse("agent1"), AgentKeyImpl.parse("agent2")));
    when(agent1.getProperties()).thenReturn(singletonMap("environment", "p1=v1,p2=v2"));
    when(agent2.getProperties()).thenReturn(singletonMap("environment", "p3=v3"));
    CheServiceImpl service = new CheServiceImpl();

    agentConfigApplier.apply(
        new ExtendedMachineImpl(asList("agent1", "agent2"), emptyMap(), emptyMap()), service);

    Map<String, String> env = service.getEnvironment();
    assertEquals(env.size(), 3);
    assertEquals(env.get("p1"), "v1");
    assertEquals(env.get("p2"), "v2");
    assertEquals(env.get("p3"), "v3");
  }


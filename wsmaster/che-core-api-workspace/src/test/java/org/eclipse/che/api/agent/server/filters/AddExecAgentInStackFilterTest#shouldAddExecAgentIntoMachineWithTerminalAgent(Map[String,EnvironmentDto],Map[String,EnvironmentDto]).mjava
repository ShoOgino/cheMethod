  @Test(dataProvider = "environmentsProvider")
  public void shouldAddExecAgentIntoMachineWithTerminalAgent(
      Map<String, EnvironmentDto> inputEnv, Map<String, EnvironmentDto> expectedEnv)
      throws ApiException {
    StackDto inputStack =
        newDto(StackDto.class)
            .withWorkspaceConfig(newDto(WorkspaceConfigDto.class).withEnvironments(inputEnv));

    final Response response =
        given()
            .auth()
            .basic(ADMIN_USER_NAME, ADMIN_USER_PASSWORD)
            .contentType(APPLICATION_JSON)
            .body(inputStack)
            .when()
            .post(SECURE_PATH + "/stack");

    assertEquals(response.getStatusCode(), 201);

    verify(stackService).createStack(stackCaptor.capture());
    Map<String, EnvironmentDto> actualEnv =
        stackCaptor.getValue().getWorkspaceConfig().getEnvironments();
    assertEquals(actualEnv, expectedEnv);
  }


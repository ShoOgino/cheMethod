    @Test
    public void shouldSetDockerfileContentInsteadOfUrlIfUrlPointsToCheApiOnMachineStart() throws Exception {
        // given
        List<Instance> instances = startEnv();
        String workspaceId = instances.get(0).getWorkspaceId();

        when(engine.generateMachineId()).thenReturn("newMachineId");
        Instance newMachine = mock(Instance.class);
        when(newMachine.getId()).thenReturn("newMachineId");
        when(newMachine.getWorkspaceId()).thenReturn(workspaceId);
        when(composeProvider.startService(anyString(),
                                          anyString(),
                                          anyString(),
                                          anyString(),
                                          anyString(),
                                          anyBoolean(),
                                          anyString(),
                                          any(ComposeServiceImpl.class),
                                          any(LineConsumer.class)))
                .thenReturn(newMachine);

        MachineConfigImpl config = createConfig(false);
        String machineName = "extraMachine";
        config.setName(machineName);
        config.setSource(new MachineSourceImpl("docker").setLocation(API_ENDPOINT + "/recipe/12345"));
        String dockerfileContent = "this is dockerfile content";
        when(recipeDownloader.getRecipe(anyString())).thenReturn("this is dockerfile content");

        // when
        engine.startMachine(workspaceId, config, emptyList());

        // then
        ArgumentCaptor<ComposeServiceImpl> captor = ArgumentCaptor.forClass(ComposeServiceImpl.class);
        verify(composeProvider).startService(anyString(),
                                             anyString(),
                                             anyString(),
                                             anyString(),
                                             eq(machineName),
                                             eq(false),
                                             anyString(),
                                             captor.capture(),
                                             any(LineConsumer.class));
        ComposeServiceImpl actualService = captor.getValue();
        assertNull(actualService.getBuild().getContext());
        assertEquals(actualService.getBuild().getDockerfile(), dockerfileContent);
    }


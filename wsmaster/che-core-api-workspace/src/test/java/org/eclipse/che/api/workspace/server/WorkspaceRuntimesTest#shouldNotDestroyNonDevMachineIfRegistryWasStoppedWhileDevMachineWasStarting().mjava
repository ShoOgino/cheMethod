    @Test
    public void shouldNotDestroyNonDevMachineIfRegistryWasStoppedWhileDevMachineWasStarting() throws Exception {
        final WorkspaceImpl workspace = createWorkspace();

        doAnswer(invocation -> {
            final MachineConfig machineCfg = (MachineConfig)invocation.getArguments()[0];
            if (!machineCfg.isDev()) {
                runtimes.cleanup();
            }
            return createMachine((MachineConfig)invocation.getArguments()[0]);
        }).when(machineManager).createMachineSync(any(), anyString(), anyString(), any(LineConsumer.class));

        try {
            runtimes.start(workspace, workspace.getConfig().getDefaultEnv());
        } catch (ServerException ex) {
            assertEquals(ex.getMessage(), "Could not perform operation because application server is stopping");
        }
        verify(machineManager, never()).destroy(any(), anyBoolean());
    }


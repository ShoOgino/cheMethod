  @Test(timeOut = 1000)
  public void shouldUseMachineTokenWhenConstructionUrlToCheck() throws Exception {
    servers.clear();
    servers.put("wsagent/http", new ServerImpl("http://localhost"));

    checker.startAsync(readinessHandler);
    connectionChecker.getReportCompFuture().complete("wsagent/http");

    verify(machineTokenProvider).getToken(WORKSPACE_ID);
    ArgumentCaptor<URL> urlCaptor = ArgumentCaptor.forClass(URL.class);
    verify(checker).doCreateChecker(urlCaptor.capture(), eq("wsagent/http"));
    URL urlToCheck = urlCaptor.getValue();
    assertNotEquals(urlToCheck.getQuery().indexOf("token=" + MACHINE_TOKEN), -1);
  }


  @Test
  public void removesOldSnapshotsWhenNewSnapshotsMetadataSuccessfullySaved() throws Exception {
    WorkspaceImpl workspace = newWorkspace("workspace", "env-name");
    setRuntime(workspace.getId(), WorkspaceStatus.RUNNING);
    SnapshotImpl oldSnapshot = mock(SnapshotImpl.class);
    doReturn((singletonList(oldSnapshot))).when(snapshotDao).replaceSnapshots(any(), any(), any());

    runtimes.snapshot(workspace.getId());

    verify(envEngine).removeSnapshot(oldSnapshot);
    verifyEventsSequence(
        event(
            workspace.getId(),
            WorkspaceStatus.RUNNING,
            WorkspaceStatus.SNAPSHOTTING,
            EventType.SNAPSHOT_CREATING,
            null),
        event(
            workspace.getId(),
            WorkspaceStatus.SNAPSHOTTING,
            WorkspaceStatus.RUNNING,
            EventType.SNAPSHOT_CREATED,
            null));
  }


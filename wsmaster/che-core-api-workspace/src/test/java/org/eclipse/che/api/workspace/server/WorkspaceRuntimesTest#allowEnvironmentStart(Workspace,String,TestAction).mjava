  private List<Instance> allowEnvironmentStart(
      Workspace workspace, String envName, TestAction beforeReturn) throws Exception {
    Environment environment = workspace.getConfig().getEnvironments().get(envName);
    ArrayList<Instance> machines = new ArrayList<>(environment.getMachines().size());
    for (Map.Entry<String, ? extends ExtendedMachine> entry :
        environment.getMachines().entrySet()) {
      machines.add(
          newMachine(
              workspace.getId(),
              envName,
              entry.getKey(),
              entry.getValue().getAgents().contains("org.eclipse.che.ws-agent")));
    }
    when(envEngine.start(
            eq(workspace.getId()),
            eq(envName),
            eq(workspace.getConfig().getEnvironments().get(envName)),
            anyBoolean(),
            any(),
            any()))
        .thenAnswer(
            invocation -> {
              if (beforeReturn != null) {
                beforeReturn.call();
              }
              return machines;
            });
    return machines;
  }


    @Test
    public void removesOldSnapshotsWhenNewSnapshotsMetadataSuccessfullySaved() throws Exception {
        final WorkspaceImpl workspace = createRunningWorkspace();
        final SnapshotImpl oldSnapshot = mock(SnapshotImpl.class);
        when(snapshotDao.replaceSnapshots(eq(workspace.getId()),
                                          eq(workspace.getRuntime().getActiveEnv()),
                                          anyObject())).thenReturn(singletonList(oldSnapshot));

        workspaceManager.stopWorkspace(workspace.getId());

        verify(runtimes, timeout(2000)).beginSnapshotting(workspace.getId());
        verify(runtimes, timeout(2000)).finishSnapshotting(workspace.getId());
        verify(eventService).publish(DtoFactory.newDto(WorkspaceStatusEvent.class)
                                               .withEventType(SNAPSHOT_CREATING)
                                               .withWorkspaceId(workspace.getId()));
        verify(eventService).publish(DtoFactory.newDto(WorkspaceStatusEvent.class)
                                               .withEventType(SNAPSHOT_CREATED)
                                               .withWorkspaceId(workspace.getId()));
        verify(runtimes).removeSnapshot(oldSnapshot);
    }


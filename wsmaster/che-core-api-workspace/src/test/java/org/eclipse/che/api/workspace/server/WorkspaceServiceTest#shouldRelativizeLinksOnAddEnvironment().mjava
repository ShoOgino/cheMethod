    @Test
    public void shouldRelativizeLinksOnAddEnvironment() throws Exception {
        final WorkspaceImpl workspace = createWorkspace(createConfigDto());
        final String initialLocation = "http://localhost:8080/api/recipe/idrecipe123456789/script";
        when(wsManager.getWorkspace(workspace.getId())).thenReturn(workspace);
        when(wsManager.updateWorkspace(any(), any())).thenReturn(workspace);
        final EnvironmentDto envDto = createEnvDto();
        envDto.getRecipe().withLocation(initialLocation).withType("dockerfile");

        final Response response = given().auth()
                                         .basic(ADMIN_USER_NAME, ADMIN_USER_PASSWORD)
                                         .contentType("application/json")
                                         .body(envDto)
                                         .when()
                                         .queryParam("name", "new-env")
                                         .post(SECURE_PATH + "/workspace/" + workspace.getId() + "/environment");

        assertEquals(response.getStatusCode(), 200);
        String savedLocation = unwrapDto(response, WorkspaceDto.class).getConfig()
                                                                      .getEnvironments()
                                                                      .get("new-env")
                                                                      .getRecipe()
                                                                      .getLocation();

        assertEquals(savedLocation, initialLocation.substring(API_ENDPOINT.length()));
    }


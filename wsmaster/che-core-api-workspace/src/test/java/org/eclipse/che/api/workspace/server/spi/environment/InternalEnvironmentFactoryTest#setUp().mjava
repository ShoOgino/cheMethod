  @BeforeMethod
  public void setUp() throws Exception {
    environmentFactory =
        spy(new TestEnvironmentFactory(installerRegistry, recipeRetriever, machinesValidator));
    final InternalEnvironment internalEnv = mock(InternalEnvironment.class);
    when(internalEnv.getMachines()).thenReturn(Collections.emptyMap());
    when(environmentFactory.doCreate(any(), anyMap(), anyList())).thenReturn(internalEnv);
  }


    @Test
    public void stoppingEventShouldBePublishedBeforeStop() throws Exception {
        final WorkspaceImpl workspace = createWorkspace();
        runtimes = spy(new WorkspaceRuntimes(machineManager, eventService));
        doNothing().when(runtimes).publishEvent(any(), any(), any());

        doAnswer(invocation -> {
            if ((!runtimes.get(workspace.getId())
                          .getRuntime()
                          .getDevMachine()
                          .getId()
                          .equals(invocation.getArguments()[0]))) {
                verify(runtimes).publishEvent(EventType.STOPPING, workspace.getId(), null);
            }
            return null;
        }).when(machineManager).destroy(anyString(), anyBoolean());

        runtimes.start(workspace, workspace.getConfig().getDefaultEnv());
        runtimes.stop(workspace.getId());
    }


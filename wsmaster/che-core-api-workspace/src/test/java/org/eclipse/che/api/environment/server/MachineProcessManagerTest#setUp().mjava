    @BeforeMethod
    public void setUp() throws Exception {
        final EventService eventService = mock(EventService.class);
        final String machineLogsDir = targetDir().resolve("logs-dir").toString();
        IoUtil.deleteRecursive(new File(machineLogsDir));
        manager = spy(new MachineProcessManager(machineLogsDir,
                                                eventService,
                                                environmentEngine,
                                                transmitter,
                                                endpointIdsHolder));

        EnvironmentContext envCont = new EnvironmentContext();
        envCont.setSubject(CREATOR);
        EnvironmentContext.setCurrent(envCont);

        doReturn(logConsumer).when(manager).getProcessLogger(MACHINE_ID, 111, "outputChannel");
        when(command.getCommandLine()).thenReturn("CommandLine");
        when(command.getName()).thenReturn("CommandName");
        when(command.getType()).thenReturn("CommandType");
        when(instance.createProcess(command, "outputChannel")).thenReturn(instanceProcess);
        when(instanceProcess.getPid()).thenReturn(111);
        when(environmentEngine.getMachine(WORKSPACE_ID, MACHINE_ID)).thenReturn(instance);
    }


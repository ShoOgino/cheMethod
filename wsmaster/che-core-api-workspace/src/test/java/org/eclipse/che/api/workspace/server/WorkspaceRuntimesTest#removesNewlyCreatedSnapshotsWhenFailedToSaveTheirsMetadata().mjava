  @Test
  public void removesNewlyCreatedSnapshotsWhenFailedToSaveTheirsMetadata() throws Exception {
    WorkspaceImpl workspace = newWorkspace("workspace", "env-name");
    setRuntime(workspace.getId(), WorkspaceStatus.RUNNING, "env-name");
    doThrow(new SnapshotException("test")).when(snapshotDao).replaceSnapshots(any(), any(), any());
    SnapshotImpl snapshot = mock(SnapshotImpl.class);
    when(envEngine.saveSnapshot(any(), any())).thenReturn(snapshot);

    try {
      runtimes.snapshot(workspace.getId());
    } catch (ServerException x) {
      assertEquals(x.getMessage(), "test");
    }

    verify(snapshotDao).replaceSnapshots(any(), any(), snapshotsCaptor.capture());
    verify(envEngine, times(snapshotsCaptor.getValue().size())).removeSnapshot(snapshot);
    verifyEventsSequence(
        event(
            workspace.getId(),
            WorkspaceStatus.RUNNING,
            WorkspaceStatus.SNAPSHOTTING,
            EventType.SNAPSHOT_CREATING,
            null),
        event(
            workspace.getId(),
            WorkspaceStatus.SNAPSHOTTING,
            WorkspaceStatus.RUNNING,
            EventType.SNAPSHOT_CREATION_ERROR,
            "test"));
  }


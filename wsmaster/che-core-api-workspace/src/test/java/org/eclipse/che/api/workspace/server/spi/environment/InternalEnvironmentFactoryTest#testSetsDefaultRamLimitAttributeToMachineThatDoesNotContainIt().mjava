  @Test
  public void testSetsDefaultRamLimitAttributeToMachineThatDoesNotContainIt() throws Exception {
    final Map<String, String> attributes = new HashMap<>();
    final InternalEnvironment internalEnv = mock(InternalEnvironment.class);
    final InternalMachineConfig machine = mock(InternalMachineConfig.class);
    when(environmentFactory.doCreate(any(), any(), any())).thenReturn(internalEnv);
    when(internalEnv.getMachines()).thenReturn(ImmutableMap.of("testMachine", machine));
    when(machine.getAttributes()).thenReturn(attributes);

    environmentFactory.create(mock(Environment.class));

    assertTrue(attributes.containsKey(MEMORY_LIMIT_ATTRIBUTE));
    assertEquals(attributes.get(MEMORY_LIMIT_ATTRIBUTE), String.valueOf(RAM_LIMIT * 2 << 19));
  }


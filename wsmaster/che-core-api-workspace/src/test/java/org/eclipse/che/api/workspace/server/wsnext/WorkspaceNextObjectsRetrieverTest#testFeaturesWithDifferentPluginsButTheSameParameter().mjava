  @Test
  public void testFeaturesWithDifferentPluginsButTheSameParameter() throws Exception {
    Map<String, String> featuresAttributes =
        featuresAttribute(
            TEST_FEATURE_NAME, TEST_FEATURE_VERSION, TEST_FEATURE_2_NAME, TEST_FEATURE_2_VERSION);
    CheFeature feature1 =
        testFeature(
            TEST_PLUGIN, TEST_PLUGIN_VERSION, TEST_PLUGIN_PARAM_NAME, TEST_PLUGIN_PARAM_VALUE);
    CheFeature feature2 =
        testFeature(
            TEST_PLUGIN_2, TEST_PLUGIN_VERSION_2, TEST_PLUGIN_PARAM_NAME, TEST_PLUGIN_PARAM_VALUE);
    ChePlugin plugin1 =
        testPluginWithSpecifiedPluginAndEnv(
            TEST_PLUGIN,
            TEST_PLUGIN_VERSION,
            TEST_PLUGIN_ENV_NAME_2,
            TEST_PLUGIN_PARAM_PLACEHOLDER);
    ChePlugin plugin2 =
        testPluginWithSpecifiedPluginAndEnv(
            TEST_PLUGIN_2,
            TEST_PLUGIN_VERSION_2,
            TEST_PLUGIN_ENV_NAME_3,
            TEST_PLUGIN_PARAM_PLACEHOLDER);
    doReturn(feature1)
        .when(retriever)
        .getBody(eq(getFeatureURI(TEST_FEATURE_NAME, TEST_FEATURE_VERSION)), eq(CheFeature.class));
    doReturn(feature2)
        .when(retriever)
        .getBody(
            eq(getFeatureURI(TEST_FEATURE_2_NAME, TEST_FEATURE_2_VERSION)), eq(CheFeature.class));
    doReturn(plugin1)
        .when(retriever)
        .getBody(eq(getPluginURI(TEST_PLUGIN, TEST_PLUGIN_VERSION)), eq(ChePlugin.class));
    doReturn(plugin2)
        .when(retriever)
        .getBody(eq(getPluginURI(TEST_PLUGIN_2, TEST_PLUGIN_VERSION_2)), eq(ChePlugin.class));
    ChePlugin expectedPlugin1 =
        expectedPluginWithSpecifiedPluginAndEnv(
            TEST_PLUGIN, TEST_PLUGIN_VERSION, TEST_PLUGIN_ENV_NAME_2, TEST_PLUGIN_PARAM_VALUE);
    ChePlugin expectedPlugin2 =
        expectedPluginWithSpecifiedPluginAndEnv(
            TEST_PLUGIN_2, TEST_PLUGIN_VERSION_2, TEST_PLUGIN_ENV_NAME_3, TEST_PLUGIN_PARAM_VALUE);

    Collection<ChePlugin> plugins = retriever.get(featuresAttributes);

    assertEqualsNoOrder(plugins.toArray(), new Object[] {expectedPlugin1, expectedPlugin2});
  }


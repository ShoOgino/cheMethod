  @Test
  public void testFeaturesWithTheSameServicesButDifferentParameters() throws Exception {
    Map<String, String> featuresAttributes =
        featuresAttribute(
            TEST_FEATURE_NAME, TEST_FEATURE_VERSION, TEST_FEATURE_2_NAME, TEST_FEATURE_2_VERSION);
    CheFeature feature1 =
        testFeature(
            TEST_SERVICE, TEST_SERVICE_VERSION, TEST_SERVICE_PARAM_NAME, TEST_SERVICE_PARAM_VALUE);
    CheFeature feature2 =
        testFeature(
            TEST_SERVICE,
            TEST_SERVICE_VERSION,
            TEST_SERVICE_PARAM_2_NAME,
            TEST_SERVICE_PARAM_VALUE_2);
    CheService service =
        testService(
            TEST_SERVICE_ENV_NAME_2,
            TEST_SERVICE_PARAM_PLACEHOLDER,
            TEST_SERVICE_ENV_NAME_3,
            TEST_SERVICE_PARAM_2_PLACEHOLDER);
    doReturn(feature1)
        .when(retriever)
        .getBody(eq(getFeatureURI(TEST_FEATURE_NAME, TEST_FEATURE_VERSION)), eq(CheFeature.class));
    doReturn(feature2)
        .when(retriever)
        .getBody(
            eq(getFeatureURI(TEST_FEATURE_2_NAME, TEST_FEATURE_2_VERSION)), eq(CheFeature.class));
    doReturn(service).when(retriever).getBody(any(URI.class), eq(CheService.class));
    CheService expectedService =
        expectedServiceWithEnv(
            TEST_SERVICE_ENV_NAME_2,
            TEST_SERVICE_PARAM_VALUE,
            TEST_SERVICE_ENV_NAME_3,
            TEST_SERVICE_PARAM_VALUE_2);

    Collection<CheService> services = retriever.get(featuresAttributes);

    assertEquals(services, singletonList(expectedService));
  }


  @Test
  public void shouldAddMachineNameToEnvironmentVariablesDuringInternalEnvironmentCreation()
      throws Exception {
    // given
    MachineConfigImpl machineConfig = new MachineConfigImpl().withEnv(new HashMap<>());
    EnvironmentImpl env =
        new EnvironmentImpl(
            null, ImmutableMap.of("machine1", machineConfig, "machine2", machineConfig));

    // when
    environmentFactory.create(env);

    // then
    verify(environmentFactory).doCreate(any(), machinesCaptor.capture(), any());
    Map<String, InternalMachineConfig> internalMachines = machinesCaptor.getValue();
    assertEquals(
        internalMachines.get("machine1").getEnv().get(CHE_MACHINE_NAME_ENV_VAR), "machine1");
    assertEquals(
        internalMachines.get("machine2").getEnv().get(CHE_MACHINE_NAME_ENV_VAR), "machine2");
  }


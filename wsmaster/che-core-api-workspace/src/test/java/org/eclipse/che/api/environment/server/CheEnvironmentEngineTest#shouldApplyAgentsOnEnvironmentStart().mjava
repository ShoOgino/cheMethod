  @Test
  public void shouldApplyAgentsOnEnvironmentStart() throws Exception {
    EnvironmentImpl env = createEnv();
    String machineName = "extraMachine";

    // prepare CheServicesEnvironmentImpl which should return compose parser
    CheServicesEnvironmentImpl cheServicesEnvironment = createCheServicesEnvByName(machineName);
    cheServicesEnvironment.getServices().get(machineName).withImage("codenvy/ubuntu_jdk8");

    // when
    startEnv(env, cheServicesEnvironment);

    // then
    verify(machineProvider)
        .startService(
            anyString(),
            anyString(),
            anyString(),
            eq(machineName),
            eq(false),
            anyString(),
            any(CheServiceImpl.class),
            any(LineConsumer.class));
    verify(infrastructureProvisioner).provision(eq(env), any(CheServicesEnvironmentImpl.class));
    verifyNoMoreInteractions(infrastructureProvisioner);
  }


    @Test
    public void shouldApplyAgentsOnEnvironmentStart() throws Exception {
        EnvironmentImpl env = createEnv();
        String machineName = "extraMachine";
        String additionalServiceComposeFilePart = "\n  " + machineName + ":\n    image: codenvy/ubuntu_jdk8";
        env.getRecipe().setContent(env.getRecipe().getContent() + additionalServiceComposeFilePart);

        // when
        startEnv(env);

        // then
        verify(composeProvider).startService(anyString(),
                                             anyString(),
                                             anyString(),
                                             anyString(),
                                             eq(machineName),
                                             eq(false),
                                             anyString(),
                                             any(ComposeServiceImpl.class),
                                             any(LineConsumer.class));
        for (ExtendedMachineImpl extendedMachine : env.getMachines().values()) {
            verify(agentConfigApplier).modify(any(ComposeServiceImpl.class), eq(extendedMachine.getAgents()));
        }
        verifyNoMoreInteractions(agentConfigApplier);
    }


    @Test
    public void shouldApplyAgentsOnEnvironmentStart() throws Exception {
        EnvironmentImpl env = createEnv();
        String machineName = "extraMachine";
        String additionalServiceComposeFilePart = "\n  " + machineName + ":\n    image: codenvy/ubuntu_jdk8";
        env.getRecipe().setContent(env.getRecipe().getContent() + additionalServiceComposeFilePart);

        // when
        startEnv(env);

        // then
        verify(machineProvider).startService(anyString(),
                                             anyString(),
                                             anyString(),
                                             eq(machineName),
                                             eq(false),
                                             anyString(),
                                             any(CheServiceImpl.class),
                                             any(LineConsumer.class));
        verify(infrastructureProvisioner).provision(eq(env), any(CheServicesEnvironmentImpl.class));
        verifyNoMoreInteractions(infrastructureProvisioner);
    }


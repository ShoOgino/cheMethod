    @Test(dataProvider = "environmentWithServersProvider")
    public void shouldAddPortsAndLabelsFromExtendedMachineServers(EnvironmentImpl environment,
                                                                  CheServicesEnvironmentImpl expectedEnv,
                                                                  @Nullable ComposeEnvironmentImpl composeEnvironment)
            throws Exception {
        when(composeFileParser.parse(anyString(), anyString())).thenReturn(composeEnvironment);

        // when
        CheServicesEnvironmentImpl cheServicesEnvironment = parser.parse(environment);

        // then
        // prevent failures because of reordered entries of expose field
        assertEquals(cheServicesEnvironment.getServices().size(), expectedEnv.getServices().size());
        cheServicesEnvironment.getServices()
                              .entrySet()
                              .forEach(entry -> {
                                  CheServiceImpl actual = entry.getValue();
                                  CheServiceImpl expected = expectedEnv.getServices().get(entry.getKey());

                                  assertNotNull(expected);
                                  // order of values does not matter
                                  assertEqualsNoOrder(actual.getExpose().toArray(),
                                                      expected.getExpose().toArray(),
                                                      format("Expose fields differ. Actual:%s. Expected:%s",
                                                             actual.getExpose(), expected.getExpose()));
                                  expected.setExpose(null);
                                  actual.setExpose(null);
                              });
        assertEquals(cheServicesEnvironment, expectedEnv);
    }


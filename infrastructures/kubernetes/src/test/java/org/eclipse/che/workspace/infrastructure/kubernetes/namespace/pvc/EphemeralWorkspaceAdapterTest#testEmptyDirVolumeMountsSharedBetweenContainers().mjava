  @Test
  public void testEmptyDirVolumeMountsSharedBetweenContainers() throws Exception {
    Container container1 = new Container();
    Container container2 = new Container();
    Pod pod = buildPod(POD_ID, container1, container2);
    PodData podData = new PodData(pod.getSpec(), pod.getMetadata());
    when(k8sEnv.getPodsData()).thenReturn(ImmutableMap.of(POD_ID, podData));

    ephemeralWorkspaceAdapter.provision(k8sEnv, runtimeIdentity);

    List<Container> podContainers = pod.getSpec().getContainers();
    List<VolumeMount> container1Mounts = podContainers.get(0).getVolumeMounts();
    List<VolumeMount> container2Mounts = podContainers.get(1).getVolumeMounts();
    assertTrue(container1Mounts.stream().allMatch(mount -> container2Mounts.contains(mount)));
    assertEquals(pod.getSpec().getVolumes().size(), volumes.size());

    List<String> podVolumeNames =
        pod.getSpec().getVolumes().stream().map(vol -> vol.getName()).collect(Collectors.toList());
    assertTrue(
        container1Mounts
            .stream()
            .map(mount -> mount.getName())
            .allMatch(volName -> podVolumeNames.contains(volName)));
  }


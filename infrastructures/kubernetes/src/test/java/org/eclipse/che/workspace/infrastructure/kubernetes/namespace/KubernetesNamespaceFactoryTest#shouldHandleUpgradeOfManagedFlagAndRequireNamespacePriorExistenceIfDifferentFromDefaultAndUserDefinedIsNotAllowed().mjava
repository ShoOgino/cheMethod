  @Test
  public void
      shouldHandleUpgradeOfManagedFlagAndRequireNamespacePriorExistenceIfDifferentFromDefaultAndUserDefinedIsNotAllowed()
          throws Exception {
    // This is a variation of the above test that checks the same scenario, but additionally checks
    // that we correctly set the managed flag on the namespace if the namespace name contains
    // the workspace id (and thus will be automatically deleted after workspace stop).

    // given
    namespaceFactory =
        spy(new KubernetesNamespaceFactory("", "", "", "che", false, clientFactory, userManager));
    KubernetesNamespace toReturnNamespace = mock(KubernetesNamespace.class);
    doReturn(toReturnNamespace).when(namespaceFactory).doCreateNamespaceAccess(any(), any());

    // when
    RuntimeIdentity identity =
        new RuntimeIdentityImpl("workspace123", null, USER_ID, "che-ws-workspace123");
    KubernetesNamespace namespace = namespaceFactory.getOrCreate(identity);

    // then
    assertEquals(toReturnNamespace, namespace);
    verify(namespaceFactory, never()).doCreateServiceAccount(any(), any());
    verify(toReturnNamespace).prepare(eq(true), eq(false));
  }


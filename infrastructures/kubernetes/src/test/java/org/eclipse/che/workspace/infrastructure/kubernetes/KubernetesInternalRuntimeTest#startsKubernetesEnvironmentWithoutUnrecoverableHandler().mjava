  @Test
  public void startsKubernetesEnvironmentWithoutUnrecoverableHandler() throws Exception {
    final ImmutableMap<String, Pod> podsMap =
        ImmutableMap.of(
            POD_NAME,
            mockPod(
                ImmutableList.of(
                    mockContainer(CONTAINER_NAME_1, EXPOSED_PORT_1),
                    mockContainer(CONTAINER_NAME_2, EXPOSED_PORT_2, INTERNAL_PORT))));
    when(k8sEnv.getPods()).thenReturn(podsMap);

    internalRuntimeWithoutUnrecoverableHandler.internalStart(emptyMap());

    verify(pods).create(any());
    verify(ingresses).create(any());
    verify(services).create(any());
    verify(namespace.pods(), times(1)).watchContainers(any());
    verify(bootstrapper, times(2)).bootstrapAsync();
    verify(eventService, times(4)).publish(any());
    verifyOrderedEventsChains(
        new MachineStatusEvent[] {newEvent(M1_NAME, STARTING), newEvent(M1_NAME, RUNNING)},
        new MachineStatusEvent[] {newEvent(M2_NAME, STARTING), newEvent(M2_NAME, RUNNING)});
    verify(serverCheckerFactory).create(IDENTITY, M1_NAME, emptyMap());
    verify(serverCheckerFactory).create(IDENTITY, M2_NAME, emptyMap());
    verify(serversChecker, times(2)).startAsync(any());
    verify(namespace.pods(), times(1)).stopWatch();
  }


  private Multimap<String, PluginMeta> sortByBrokerImage(Collection<PluginMeta> pluginMetas)
      throws InfrastructureException {
    Multimap<String, PluginMeta> sortedPlugins = ArrayListMultimap.create();
    for (PluginMeta pluginMeta : pluginMetas) {
      String type = pluginMeta.getType();
      if (isNullOrEmpty(type)) {
        throw new InfrastructureException(
            format(
                "Plugin '%s:%s' has invalid type '%s'",
                pluginMeta.getId(), pluginMeta.getVersion(), type));
      }
      String image = pluginTypeToImage.get(type);
      if (isNullOrEmpty(image)) {
        throw new InfrastructureException(
            format(
                "Plugin '%s:%s' has unsupported type '%s'",
                pluginMeta.getId(), pluginMeta.getVersion(), type));
      }
      sortedPlugins.put(image, pluginMeta);
    }

    return sortedPlugins;
  }


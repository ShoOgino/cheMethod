  /**
   * Creates a Kubernetes namespace for the specified workspace.
   *
   * <p>The namespace name will be chosen according to a configuration, and it will be prepared
   * (created if necessary).
   *
   * @param workspaceId identifier of the workspace
   * @return created namespace
   * @throws InfrastructureException if any exception occurs during namespace preparing
   */
  public KubernetesNamespace create(String workspaceId) throws InfrastructureException {
    final String namespaceName;
    try {
      namespaceName = evalNamespaceName(workspaceId, EnvironmentContext.getCurrent().getSubject());
    } catch (NotFoundException | ServerException | ConflictException | ValidationException e) {
      throw new InfrastructureException(
          format(
              "Failed to determine the namespace to put the workspace %s to."
                  + " The error message was: %s",
              workspaceId, e.getMessage()),
          e);
    }

    KubernetesNamespace namespace = doCreateNamespace(workspaceId, namespaceName);
    namespace.prepare();

    if (isCreatingNamespace(workspaceId) && !isNullOrEmpty(serviceAccountName)) {
      // prepare service account for workspace only if account name is configured
      // and project is not predefined
      // since predefined project should be prepared during Che deployment
      KubernetesWorkspaceServiceAccount workspaceServiceAccount =
          doCreateServiceAccount(workspaceId, namespaceName);
      workspaceServiceAccount.prepare();
    }

    return namespace;
  }


  /**
   * Modifies Kubernetes environment to expose the specified service port via JWTProxy.
   *
   * @param k8sEnv Kubernetes environment to modify
   * @param backendServiceName service name that will be exposed
   * @param backendServicePort service port that will be exposed
   * @param protocol protocol that will be used for exposed port
   * @param secureServers secure servers to expose
   * @return JWTProxy service port that expose the specified one
   * @throws InfrastructureException if any exception occurs during port exposing
   */
  public ServicePort expose(
      KubernetesEnvironment k8sEnv,
      String backendServiceName,
      int backendServicePort,
      String protocol,
      Map<String, ServerConfig> secureServers)
      throws InfrastructureException {
    ensureJwtProxyInjected(k8sEnv);

    int listenPort = availablePort++;

    Set<String> excludes = new HashSet<>();
    for (ServerConfig config : secureServers.values()) {
      if (config.getAttributes().containsKey(UNSECURED_PATHS_ATTRIBUTE)) {
        Collections.addAll(
            excludes, config.getAttributes().get(UNSECURED_PATHS_ATTRIBUTE).split(","));
      }
    }

    proxyConfigBuilder.addVerifierProxy(
        listenPort, "http://" + backendServiceName + ":" + backendServicePort, excludes);
    k8sEnv
        .getConfigMaps()
        .get(getConfigMapName())
        .getData()
        .put(JWT_PROXY_CONFIG_FILE, proxyConfigBuilder.build());

    ServicePort exposedPort =
        new ServicePortBuilder()
            .withName("server-" + listenPort)
            .withPort(listenPort)
            .withProtocol(protocol)
            .withNewTargetPort(listenPort)
            .build();

    k8sEnv.getServices().get(getServiceName()).getSpec().getPorts().add(exposedPort);

    return exposedPort;
  }


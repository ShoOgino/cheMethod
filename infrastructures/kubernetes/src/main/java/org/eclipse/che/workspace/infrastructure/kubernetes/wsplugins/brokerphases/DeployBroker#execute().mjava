  @Override
  public List<ChePlugin> execute() throws InfrastructureException {
    KubernetesDeployments deployments = namespace.deployments();
    try {
      // Creates config map that can inject Che tooling plugins meta files into a Che plugin
      // broker in a workspace.
      for (ConfigMap configMap : brokerEnvironment.getConfigMaps().values()) {
        namespace.configMaps().create(configMap);
      }
      for (Pod toCreate : brokerEnvironment.getPods().values()) {
        deployments.deploy(toCreate);
      }

      return nextPhase.execute();
    } finally {
      try {
        deployments.delete();
      } catch (InfrastructureException e) {
        LOG.error("Broker deployment removal failed. Error: " + e.getLocalizedMessage(), e);
      }
      try {
        namespace.configMaps().delete();
      } catch (InfrastructureException ex) {
        LOG.error(
            "Broker deployment config map removal failed. Error: " + ex.getLocalizedMessage(), ex);
      }
    }
  }


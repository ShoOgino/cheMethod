  /**
   * Prepares (builds or downloads) docker image for container config.
   *
   * @param container container config
   * @return name of the image for the given container config
   * @throws InternalInfrastructureException if config is incomplete or image build failed
   * @throws SourceNotFoundException if image pull failed
   */
  private String prepareImage(String machineName, DockerContainerConfig container)
      throws SourceNotFoundException, InternalInfrastructureException {

    ProgressMonitor progressMonitor =
        machineLoggersFactory.newProgressMonitor(machineName, identity);
    final String imageName = "eclipse-che/" + container.getContainerName();
    if ((container.getBuild() == null
            || (container.getBuild().getContext() == null
                && container.getBuild().getDockerfileContent() == null))
        && container.getImage() == null) {

      throw new InternalInfrastructureException(
          format("Che container '%s' doesn't have neither build nor image fields", machineName));
    }

    if (container.getBuild() != null
        && (container.getBuild().getContext() != null
            || container.getBuild().getDockerfileContent() != null)) {
      buildImage(container, imageName, doForcePullImage, progressMonitor);
    } else {
      pullImage(container, imageName, progressMonitor);
    }

    return imageName;
  }


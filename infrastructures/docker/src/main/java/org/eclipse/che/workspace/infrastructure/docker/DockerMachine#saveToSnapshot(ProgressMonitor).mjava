    public DockerMachineSource saveToSnapshot(ProgressMonitor progressMonitor) throws SnapshotException {
        try {
            String image = generateRepository();
            if (!snapshotUseRegistry) {
                commitContainer(image, LATEST_TAG);
                return new DockerMachineSource(image).withTag(LATEST_TAG);
            }

            PushParams pushParams = PushParams.create(image)
                                              .withRegistry(registry)
                                              .withTag(LATEST_TAG);

            final String fullRepo = pushParams.getFullRepo();
            commitContainer(fullRepo, LATEST_TAG);
            //TODO fix this workaround. Docker image is not visible after commit when using swarm
            Thread.sleep(2000);
            final String digest = docker.push(pushParams, progressMonitor);
            docker.removeImage(RemoveImageParams.create(fullRepo).withForce(false));
            return new DockerMachineSource(image).withRegistry(registry).withDigest(digest).withTag(LATEST_TAG);
        } catch (IOException ioEx) {
            throw new SnapshotException(ioEx);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new SnapshotException(e.getLocalizedMessage(), e);
        }
    }


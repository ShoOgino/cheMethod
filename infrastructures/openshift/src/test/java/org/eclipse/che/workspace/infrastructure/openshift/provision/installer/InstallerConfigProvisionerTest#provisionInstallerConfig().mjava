  @Test
  public void provisionInstallerConfig() throws Exception {
    final String podName = "test";
    final Container container = mockContainer("machine");
    final Pod pod = mockPod(podName, singletonList(container));
    when(osEnv.getPods()).thenReturn(ImmutableMap.of(podName, pod));
    final InternalMachineConfig devMachine = mock(InternalMachineConfig.class);
    final Map<String, InternalMachineConfig> machines = ImmutableMap.of("test/machine", devMachine);
    when(environment.getMachines()).thenReturn(machines);
    when(devMachine.getServers())
        .thenReturn(singletonMap(Constants.SERVER_WS_AGENT_HTTP_REFERENCE, new ServerConfigImpl()));
    final InstallerImpl installer = mock(InstallerImpl.class);
    final List<InstallerImpl> installers = singletonList(installer);
    when(devMachine.getInstallers()).thenReturn(installers);
    final Map<String, String> envVars = ImmutableMap.of("environment", "CHE_HOST=localhost");
    when(installer.getProperties()).thenReturn(envVars);
    final List<EnvVar> envVariables = new ArrayList<>();
    when(container.getEnv()).thenReturn(envVariables);
    when(installer.getServers()).thenReturn(emptyMap());

    installerConfigProvisioner.provision(environment, osEnv, runtimeIdentity);

    verify(osEnv, times(1)).getPods();
    verify(runtimeIdentity, atLeast(1)).getWorkspaceId();
    verify(environment, times(2)).getMachines();
    assertTrue(envVariables.size() == 3);
  }


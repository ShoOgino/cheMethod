    @BeforeMethod
    public void setUp() throws Exception {
        wsAgentLauncher = new WsAgentLauncherImpl(machineManager,
                                                  requestFactory,
                                                  WS_AGENT_START_CMD_LINE,
                                                  new URI("http://localhost:8080" + API_ENDPOINT_PATH),
                                                  WS_AGENT_MAX_START_TIME_MS,
                                                  WS_AGENT_PING_DELAY_MS,
                                                  WS_AGENT_PING_CONN_TIMEOUT_MS);
        pingRequest = mock(HttpJsonRequest.class, new SelfReturningAnswer());
        when(machineManager.getDevMachine(WS_ID)).thenReturn(machineInstance);
        when(machineInstance.getId()).thenReturn(MACHINE_ID);
        when(machineInstance.getMetadata()).thenReturn(machineMetadata);
        doReturn(Collections.<String, Server>singletonMap(WS_AGENT_PORT, SERVER)).when(machineMetadata).getServers();
        when(requestFactory.fromUrl(anyString())).thenReturn(pingRequest);
        when(pingRequest.request()).thenReturn(pingResponse);
        when(pingResponse.getResponseCode()).thenReturn(HttpURLConnection.HTTP_OK);
    }


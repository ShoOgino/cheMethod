    protected void compareDirectories(java.io.File a, java.io.File b, boolean checkServiceDirs) throws IOException {
        if (!a.isDirectory() || !b.isDirectory()) {
            fail();
        }
        LinkedList<Pair<java.io.File, java.io.File>> q = new LinkedList<>();
        q.add(new Pair<>(a, b));
        while (!q.isEmpty()) {
            Pair<java.io.File, java.io.File> current = q.pop();
            java.io.File[] files1 = current.first.listFiles(checkServiceDirs ? null : SERVICE_DIR_FILTER);
            java.io.File[] files2 = current.second.listFiles(checkServiceDirs ? null : SERVICE_DIR_FILTER);
            if (files1 == null || files2 == null || files1.length != files2.length) {
                fail();
            }
            Arrays.sort(files1);
            Arrays.sort(files2);
            for (int i = 0; i < files1.length; i++) {
                java.io.File file1 = files1[i];
                java.io.File file2 = files2[i];
                if (!file1.getName().equals(file2.getName())) {
                    fail();
                }
                if (file1.isFile()) {
                    try (FileInputStream in1 = new FileInputStream(file1); FileInputStream in2 = new FileInputStream(file2)) {
                        compareStreams(in1, in2);
                    }
                } else {
                    q.push(new Pair<>(file1, file2));
                }
            }
        }
    }


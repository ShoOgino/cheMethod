    protected java.io.File writePermissions(String vfsPath, Map<Principal, Set<String>> permissions) throws IOException {
        java.io.File file = getIoFile(vfsPath);
        java.io.File aclDir = new java.io.File(file.getParentFile(), FSMountPoint.ACL_DIR);
        if (!(aclDir.exists() || aclDir.mkdirs())) {
            fail();
        }

        java.io.File aclFile = new java.io.File(aclDir, file.getName() + FSMountPoint.ACL_FILE_SUFFIX);
        AccessControlList accessControlList = new AccessControlList(permissions);
        if (accessControlList.isEmpty()) {
            if (!aclFile.delete()) {
                if (aclFile.exists()) {
                    fail("Cannot clear ACL. ");
                }
            }
        } else {
            try (DataOutputStream dos = new DataOutputStream(new BufferedOutputStream(new FileOutputStream(aclFile)))) {
                accessControlList.write(dos);
            }
        }
        return aclFile;
    }


    /**
     * Adds a dirty region to the end of the dirty-region queue.
     *
     * @param dr the dirty region to add
     */
    public void addDirtyRegion(DirtyRegion dr) {
        // If the dirty region being added is directly after the last dirty
        // region on the queue then merge the two dirty regions together.
        final DirtyRegion lastDR = getLastDirtyRegion();
        boolean wasMerged = false;
        if (lastDR != null) {
            if (nullSafeStringsEquals(lastDR.getType(), dr.getType())) {
                if (DirtyRegion.INSERT.equals(lastDR.getType())) {
                    if (lastDR.getOffset() + lastDR.getLength() == dr.getOffset()) {
                        lastDR.mergeWith(dr);
                        wasMerged = true;
                    }
                } else if (DirtyRegion.REMOVE.equals(lastDR.getType())) {
                    if (dr.getOffset() + dr.getLength() == lastDR.getOffset()) {
                        lastDR.mergeWith(dr);
                        wasMerged = true;
                    }
                }
            }
        }

        if (!wasMerged) {
            // Don't merge- just add the new one onto the queue.
            fDirtyRegions.add(dr);
        }
    }


    private synchronized void acquire(Path path, int permits, long timeoutMilliseconds) {
        final long endTime = System.currentTimeMillis() + timeoutMilliseconds;
        long waitTime = timeoutMilliseconds;
        while (!tryAcquire(path, permits)) {
            try {
                wait(waitTime);
            } catch (InterruptedException e) {
                notifyAll();
                throw new RuntimeException(e);
            }
            long now = System.currentTimeMillis();
            if (now >= endTime) {
                throw new RuntimeException(String.format("Get lock timeout for '%s'. ", path));
            }
            waitTime = endTime - now;
        }
    }


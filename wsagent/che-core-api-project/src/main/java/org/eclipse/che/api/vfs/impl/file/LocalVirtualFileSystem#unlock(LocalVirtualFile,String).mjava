  void unlock(LocalVirtualFile virtualFile, String lockToken)
      throws ForbiddenException, ConflictException, ServerException {
    if (lockToken == null) {
      throw new ForbiddenException("Null lock token");
    }
    if (!virtualFile.isFile()) {
      throw new ConflictException(String.format("Item '%s' is not locked", virtualFile.getPath()));
    }
    final FileLock fileLock = getFileLock(virtualFile);
    if (NO_LOCK == fileLock) {
      throw new ConflictException(String.format("File '%s' is not locked", virtualFile.getPath()));
    }
    if (!fileLock.getLockToken().equals(lockToken)) {
      throw new ForbiddenException(
          String.format(
              "Unable unlock file '%s'. Lock token does not match", virtualFile.getPath()));
    }

    final PathLockFactory.PathLock lockFilePathLock =
        pathLockFactory.getLock(virtualFile.getPath(), true).acquire(WAIT_FOR_FILE_LOCK_TIMEOUT);
    try {
      doUnlock(virtualFile);
    } finally {
      lockFilePathLock.release();
    }
  }


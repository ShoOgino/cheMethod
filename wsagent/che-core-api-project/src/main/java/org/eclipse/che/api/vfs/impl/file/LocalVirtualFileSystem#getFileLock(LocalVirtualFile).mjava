  private FileLock getFileLock(LocalVirtualFile virtualFile) throws ServerException {
    final PathLockFactory.PathLock lockFilePathLock =
        pathLockFactory.getLock(virtualFile.getPath(), true).acquire(WAIT_FOR_FILE_LOCK_TIMEOUT);
    try {
      final FileLock lock;
      try {
        lock = lockTokensCache.get(virtualFile.getPath());
      } catch (ExecutionException e) {
        String errorMessage = String.format("Unable get lock of file '%s'", virtualFile.getPath());
        LOG.error(errorMessage + "\n" + e.getCause().getMessage(), e.getCause());
        throw new ServerException(errorMessage);
      }
      if (NO_LOCK == lock) {
        return lock;
      }
      if (lock.getExpired() < System.currentTimeMillis()) {
        final File fileLockIoFile = getFileLockIoFile(virtualFile.getPath());
        if (!fileLockIoFile.delete()) {
          if (fileLockIoFile.exists()) {
            FileCleaner.addFile(fileLockIoFile);
            LOG.warn("Unable delete lock file %s", fileLockIoFile);
          }
        }
        lockTokensCache.put(virtualFile.getPath(), NO_LOCK);
        return NO_LOCK;
      }
      return lock;
    } finally {
      lockFilePathLock.release();
    }
  }


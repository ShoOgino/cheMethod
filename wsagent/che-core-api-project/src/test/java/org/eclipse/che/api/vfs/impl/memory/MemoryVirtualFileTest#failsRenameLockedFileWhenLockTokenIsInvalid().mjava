    @Test
    public void failsRenameLockedFileWhenLockTokenIsInvalid() throws Exception {
        VirtualFile folder = getRoot().createFolder(generateFolderName());
        VirtualFile file = folder.createFile(generateFileName(), DEFAULT_CONTENT);
        file.setProperty("property1", "value1");
        Path filePath = file.getPath();
        Path newPath = folder.getPath().newPath("new name");
        String invalidLockToken = invalidateLockToken(file.lock(0));

        try {
            file.rename("new name", invalidLockToken);
            thrown.expect(ForbiddenException.class);
        } catch (ForbiddenException e) {
            assertNull(getRoot().getChild(newPath));

            assertTrue(file.isLocked());
            assertEquals(file, getRoot().getChild(filePath));
            assertEquals(ImmutableMap.of("property1", "value1"), file.getProperties());
            assertEquals(DEFAULT_CONTENT, file.getContentAsString());
        }
    }


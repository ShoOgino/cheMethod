  private void assertThatTarArchiveContainsAllEntries(InputStream in, Map<String, String> entries)
      throws Exception {
    try (TarArchiveInputStream tarIn = new TarArchiveInputStream(in)) {
      TarArchiveEntry tarArchiveEntry;
      while ((tarArchiveEntry = tarIn.getNextTarEntry()) != null) {
        String name = tarArchiveEntry.getName();
        assertTrue(String.format("Unexpected entry %s in TAR", name), entries.containsKey(name));
        if (!tarArchiveEntry.isDirectory()) {
          String content = new String(ByteStreams.toByteArray(tarIn));
          assertEquals(
              String.format("Invalid content of file %s", name), entries.get(name), content);
        }
        entries.remove(name);
      }
    }
    assertTrue(String.format("Expected but were not found in TAR %s", entries), entries.isEmpty());
  }


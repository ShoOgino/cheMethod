  @Test
  public void failsMoveFolderWhenTargetFolderNeedBeOverwrittenButContainsLockedFile()
      throws Exception {
    VirtualFile folder = getRoot().createFolder(generateFolderName());
    VirtualFile file = folder.createFile(generateFileName(), DEFAULT_CONTENT);
    VirtualFile targetFolder = getRoot().createFolder(generateFolderName());
    VirtualFile conflictFolder = targetFolder.createFolder(folder.getName());
    VirtualFile lockedFileInConflictFolder = conflictFolder.createFile(generateFileName(), "xxx");
    lockedFileInConflictFolder.lock(0);

    try {
      folder.moveTo(targetFolder, null, true, null);
      thrown.expect(ForbiddenException.class);
    } catch (ForbiddenException expected) {
      assertionHelper.assertThatIoFileHasContent(
          lockedFileInConflictFolder.getPath(), "xxx".getBytes());
      assertionHelper.assertThatIoFileDoesNotExist(
          conflictFolder.getPath().newPath(file.getName()));

      assertionHelper.assertThatIoFileExists(folder.getPath());
      assertionHelper.assertThatIoFileHasContent(file.getPath(), DEFAULT_CONTENT_BYTES);
    }
  }


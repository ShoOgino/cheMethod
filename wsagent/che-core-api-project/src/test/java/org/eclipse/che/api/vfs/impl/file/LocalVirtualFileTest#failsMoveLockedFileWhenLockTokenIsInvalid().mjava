  @Test
  public void failsMoveLockedFileWhenLockTokenIsInvalid() throws Exception {
    VirtualFile file = getRoot().createFile(generateFileName(), DEFAULT_CONTENT);
    file.setProperty("property1", "value1");
    Path filePath = file.getPath();
    String invalidLockToken = invalidateLockToken(file.lock(0));
    VirtualFile targetFolder = getRoot().createFolder(generateFolderName());
    Path movedFilePath = targetFolder.getPath().newPath(file.getName());

    try {
      file.moveTo(targetFolder, null, false, invalidLockToken);
      thrown.expect(ForbiddenException.class);
    } catch (ForbiddenException e) {
      assertionHelper.assertThatIoFileDoesNotExist(movedFilePath);
      assertionHelper.assertThatLockIoFileDoesNotExist(movedFilePath);
      assertionHelper.assertThatMetadataIoFileDoesNotExist(movedFilePath);

      assertionHelper.assertThatIoFileHasContent(filePath, DEFAULT_CONTENT_BYTES);
      assertionHelper.assertThatMetadataIoFileHasContent(
          filePath, serializeVirtualFileMetadata(ImmutableMap.of("property1", "value1")));
      assertionHelper.assertThatLockIoFileExists(filePath);
    }
  }


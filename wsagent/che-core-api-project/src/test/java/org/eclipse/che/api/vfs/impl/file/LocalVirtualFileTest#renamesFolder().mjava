    @Test
    public void renamesFolder() throws Exception {
        VirtualFile folder = getRoot().createFolder(generateFolderName());
        Path folderPath = folder.getPath();
        folder.setProperty("property1", "value1");
        VirtualFile file = folder.createFile(generateFileName(), DEFAULT_CONTENT);
        String fileName = file.getName();
        file.setProperty("property2", "value2");

        VirtualFile renamed = folder.rename("new_name");

        Path newFilePath = renamed.getPath().newPath(fileName);

        assertionHelper.assertThatIoFileExists(renamed.getPath());
        assertionHelper.assertThatIoFileHasContent(newFilePath, DEFAULT_CONTENT_BYTES);

        assertionHelper.assertThatMetadataIoFileHasContent(renamed.getPath(),
                                                           serializeVirtualFileMetadata(ImmutableMap.of("property1", "value1")));
        assertionHelper
                .assertThatMetadataIoFileHasContent(newFilePath, serializeVirtualFileMetadata(ImmutableMap.of("property2", "value2")));

        assertionHelper.assertThatIoFileDoesNotExist(folderPath);
        assertionHelper.assertThatIoFileDoesNotExist(folderPath.newPath(fileName));
        assertionHelper.assertThatMetadataIoFileDoesNotExist(folderPath);
        assertionHelper.assertThatMetadataIoFileDoesNotExist(folderPath.newPath(fileName));
    }


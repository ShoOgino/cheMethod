  @Test
  public void copiesFolder() throws Exception {
    VirtualFile folder = getRoot().createFolder(generateFolderName());
    createFileTree(folder, 3);
    List<VirtualFile> originalTree = getFileTreeAsList(folder);
    for (int i = 0; i < originalTree.size(); i++) {
      originalTree.get(i).setProperty("property" + i, "value" + 1);
    }

    VirtualFile targetFolder = getRoot().createFolder(generateFolderName());

    VirtualFile copiedFolder = folder.copyTo(targetFolder);

    List<VirtualFile> copiedTree = getFileTreeAsList(copiedFolder);

    Iterator<VirtualFile> originalIterator = originalTree.iterator();
    Iterator<VirtualFile> copiedIterator = copiedTree.iterator();
    while (originalIterator.hasNext() && copiedIterator.hasNext()) {
      VirtualFile original = originalIterator.next();
      VirtualFile copy = copiedIterator.next();
      assertEquals(
          String.format("Properties of virtual file %s not copied properly", copy.getPath()),
          original.getProperties(),
          copy.getProperties());
      if (original.isFile()) {
        assertEquals(
            String.format("Content of file %s not copied properly", copy.getPath()),
            original.getContentAsString(),
            copy.getContentAsString());
      }
    }
    assertFalse(originalIterator.hasNext() || copiedIterator.hasNext());
  }


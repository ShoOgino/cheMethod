  @Test
  public void failsRenameFileWhenFolderContainsItemWithSameName() throws Exception {
    VirtualFile folder = getRoot().createFolder(generateFolderName());
    VirtualFile file = folder.createFile(generateFileName(), DEFAULT_CONTENT);
    file.setProperty("property1", "value1");
    VirtualFile conflictFile = folder.createFile("existed_name", "xxx");
    conflictFile.setProperty("property2", "value2");

    try {
      file.rename("existed_name");
      thrown.expect(ConflictException.class);
    } catch (ConflictException e) {
      assertEquals(DEFAULT_CONTENT, file.getContentAsString());
      assertEquals(ImmutableMap.of("property1", "value1"), file.getProperties());

      assertEquals("xxx", conflictFile.getContentAsString());
      assertEquals(ImmutableMap.of("property2", "value2"), conflictFile.getProperties());
    }
  }


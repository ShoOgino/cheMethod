    @Test
    public void copiesFolder() throws Exception {
        VirtualFile folder = getRoot().createFolder(generateFolderName());
        createFileTree(folder, 3);
        List<VirtualFile> originalTree = getFileTreeAsList(folder);
        for (int i = 0; i < originalTree.size(); i++) {
            originalTree.get(i).setProperty("property" + i, "value" + 1);
        }

        VirtualFile targetFolder = getRoot().createFolder(generateFolderName());

        VirtualFile copiedFolder = folder.copyTo(targetFolder);

        List<VirtualFile> copiedTree = getFileTreeAsList(copiedFolder);

        Iterator<VirtualFile> originalIterator = originalTree.iterator();
        Iterator<VirtualFile> copiedIterator = copiedTree.iterator();
        while (originalIterator.hasNext() && copiedIterator.hasNext()) {
            VirtualFile original = originalIterator.next();
            VirtualFile copy = copiedIterator.next();
            assertionHelper.assertThatIoFileExists(copy.getPath());
            assertionHelper.assertThatMetadataIoFilesHaveSameContent(original.getPath(), copy.getPath());
            if (original.isFile()) {
                assertionHelper.assertThatIoFilesHaveSameContent(original.getPath(), copy.getPath());
            }
        }
        assertFalse(originalIterator.hasNext() || copiedIterator.hasNext());
    }


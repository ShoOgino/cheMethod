    @BeforeMethod
    public void setUp() throws Exception {
        wsAgentLauncher = new WsAgentLauncher(() -> machineProcessManager,
                                              wsAgentPingRequestFactory, null,
                                              WS_AGENT_MAX_START_TIME_MS,
                                              WS_AGENT_PING_DELAY_MS,
                                              WS_AGENT_TIMED_OUT_MESSAGE
        );
        pingRequest = Mockito.mock(HttpJsonRequest.class, new SelfReturningAnswer());
        Mockito.when(agent.getScript()).thenReturn("script");
        Mockito.when(machine.getId()).thenReturn(MACHINE_ID);
        Mockito.when(machine.getWorkspaceId()).thenReturn(WORKSPACE_ID);
        Mockito.when(machine.getRuntime()).thenReturn(machineRuntime);
        Mockito.doReturn(Collections.<String, Server>singletonMap(WS_AGENT_PORT, SERVER)).when(machineRuntime).getServers();
        Mockito.when(requestFactory.fromUrl(Matchers.anyString())).thenReturn(pingRequest);
        Mockito.when(wsAgentPingRequestFactory.createRequest(machine)).thenReturn(pingRequest);
        Mockito.when(pingRequest.request()).thenReturn(pingResponse);
        Mockito.when(pingResponse.getResponseCode()).thenReturn(HttpURLConnection.HTTP_OK);
    }


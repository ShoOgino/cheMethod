  @BeforeMethod
  public void setUp() throws Exception {
    wsAgentLauncher =
        new WsAgentLauncher(
            () -> machineProcessManager,
            wsAgentHealthChecker,
            wsAgentPingRequestFactory,
            null,
            WS_AGENT_MAX_START_TIME_MS,
            WS_AGENT_PING_DELAY_MS,
            WS_AGENT_TIMED_OUT_MESSAGE);
    pingRequest = Mockito.mock(HttpJsonRequest.class, new SelfReturningAnswer());
    Mockito.when(agent.getScript()).thenReturn("script");
    Mockito.when(machine.getId()).thenReturn(MACHINE_ID);
    Mockito.when(machine.getWorkspaceId()).thenReturn(WORKSPACE_ID);
    Mockito.when(machine.getRuntime()).thenReturn(machineRuntime);
    Mockito.when(machine.getNode()).thenReturn(Mockito.mock(InstanceNode.class));
    Mockito.doReturn(Collections.<String, Server>singletonMap(WS_AGENT_PORT, SERVER))
        .when(machineRuntime)
        .getServers();
    Mockito.when(wsAgentPingRequestFactory.createRequest(machine)).thenReturn(pingRequest);
    Mockito.when(wsAgentHealthChecker.check(machine)).thenReturn(pingResponse);
    Mockito.when(pingResponse.getCode()).thenReturn(200);
  }


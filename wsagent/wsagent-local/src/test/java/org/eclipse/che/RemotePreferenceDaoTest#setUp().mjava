    @BeforeMethod
    private void setUp() throws Exception {
        preferenceDao = new RemotePreferenceDao(API_ENDPOINT, requestFactory);
        request = mock(HttpJsonRequest.class, (Answer) invocation -> {
            if (invocation.getMethod().getReturnType().isInstance(invocation.getMock())) {
                return invocation.getMock();
            }
            return RETURNS_DEFAULTS.answer(invocation);
        });
        when(request.request()).thenReturn(response);
        when(requestFactory.fromUrl(anyString())).thenReturn(request);
        final EnvironmentContext context = new EnvironmentContext();
        context.setUser(TEST_USER);
        EnvironmentContext.setCurrent(context);
    }


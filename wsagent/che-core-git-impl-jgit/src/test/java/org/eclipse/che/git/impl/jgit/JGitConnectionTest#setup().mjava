  @BeforeMethod
  public void setup() {
    jGitConnection =
        spy(
            new JGitConnection(
                repository, credentialsLoader, sshKeyProvider, eventService, userResolver));

    RepositoryState repositoryState = mock(RepositoryState.class);
    GitUser gitUser = mock(GitUser.class);
    lenient().when(repositoryState.canAmend()).thenReturn(true);
    lenient().when(repositoryState.canCommit()).thenReturn(true);
    lenient().when(repository.getRepositoryState()).thenReturn(repositoryState);
    lenient().when(gitUser.getName()).thenReturn("username");
    lenient().when(gitUser.getEmail()).thenReturn("email");
    lenient().when(userResolver.getUser()).thenReturn(gitUser);
    lenient().when(repository.getDirectory()).thenReturn(directory);
    lenient().when(directory.getPath()).thenReturn("path");
  }


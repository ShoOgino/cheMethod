  @Test(
    expectedExceptions = ServerException.class,
    expectedExceptionsMessageRegExp = "An error on process kill"
  )
  public void shouldLogAgentStartLogsIfMachineExceptionOccursAfterAgentStartTimeoutHadReached()
      throws Exception {
    // given
    launcher = spy(new TestAgentLauncher(-1, 100, agentChecker));
    when(agentChecker.isLaunched(any(Agent.class), any(InstanceProcess.class), any(Instance.class)))
        .thenReturn(false);

    doReturn(process)
        .when(launcher)
        .start(nullable(Instance.class), nullable(Agent.class), nullable(LineConsumer.class));
    doThrow(new MachineException("An error on process kill")).when(process).kill();

    // when
    try {
      launcher.launch(machine, agent);
      fail("Should throw ServerException");
    } catch (ServerException e) {
      // then
      verify(launcher)
          .logAsErrorAgentStartLogs(
              nullable(Instance.class), nullable(String.class), nullable(String.class));
      // rethrow exception to verify message
      throw e;
    }
  }


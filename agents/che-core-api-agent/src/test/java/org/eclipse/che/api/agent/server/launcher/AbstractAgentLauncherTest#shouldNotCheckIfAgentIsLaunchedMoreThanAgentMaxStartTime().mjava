  @Test(
    expectedExceptions = AgentStartException.class,
    expectedExceptionsMessageRegExp = "Fail launching agent .*. Workspace ID:.*"
  )
  public void shouldNotCheckIfAgentIsLaunchedMoreThanAgentMaxStartTime() throws Exception {
    // given
    launcher = spy(new TestAgentLauncher(200, 100, agentChecker));
    doReturn(process)
        .when(launcher)
        .start(any(Instance.class), any(Agent.class), any(LineConsumer.class));
    when(agentChecker.isLaunched(any(Agent.class), any(InstanceProcess.class), any(Instance.class)))
        .thenReturn(false)
        .thenReturn(false)
        .thenReturn(false)
        .thenReturn(false)
        .thenReturn(true);

    // when
    launcher.launch(machine, agent);

    // then
    // ensure that isLaunched was called several times and then max pinging time was exceeded
    verify(agentChecker, atLeast(2))
        .isLaunched(any(Agent.class), any(InstanceProcess.class), any(Instance.class));
  }


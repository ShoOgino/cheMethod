  @Test(
    expectedExceptions = ServerException.class,
    expectedExceptionsMessageRegExp = "An error on agent start"
  )
  public void shouldLogAgentStartLogsIfMachineExceptionOccurs() throws Exception {
    // given
    doThrow(new MachineException("An error on agent start"))
        .when(launcher)
        .start(any(Instance.class), any(Agent.class), any(LineConsumer.class));

    // when
    try {
      launcher.launch(machine, agent);
      fail("Should throw ServerException");
    } catch (ServerException e) {
      // then
      verify(launcher).logAsErrorAgentStartLogs(anyObject(), anyString(), anyString());
      // rethrow exception to verify message
      throw e;
    }
  }


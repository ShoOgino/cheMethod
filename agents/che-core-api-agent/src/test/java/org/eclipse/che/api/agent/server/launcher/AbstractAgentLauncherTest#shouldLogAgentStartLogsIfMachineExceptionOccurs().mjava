  @Test(
    expectedExceptions = ServerException.class,
    expectedExceptionsMessageRegExp = "An error on agent start"
  )
  public void shouldLogAgentStartLogsIfMachineExceptionOccurs() throws Exception {
    // given
    doThrow(new MachineException("An error on agent start"))
        .when(launcher)
        .start(nullable(Instance.class), nullable(Agent.class), nullable(LineConsumer.class));

    // when
    try {
      launcher.launch(machine, agent);
      fail("Should throw ServerException");
      verify(launcher)
          .logAsErrorAgentStartLogs(
              nullable(Instance.class), nullable(String.class), nullable(String.class));
    } catch (ServerException e) {
      // then
      // rethrow exception to verify message
      throw e;
    }
  }

